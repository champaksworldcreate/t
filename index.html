<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Seriously Good Pyodide Editor ‚Äî Collision-Proof (Fixed)</title>
  <meta name="description" content="A robust Pyodide editor with collision-proof CSS, tabs, stdin, package installs, share/save, and safe output handling." />

  <style>
    :root{
      --pp-bg:#fff7e6; --pp-card:#ffffff; --pp-ink:#1f2937; --pp-muted:#6b7280;
      --pp-brand:#d97706; --pp-brand2:#f59e0b; --pp-border:#eadcc5;
      --pp-shadow:0 18px 40px rgba(31,41,55,.14);
      --pp-codebg:#0b1220; --pp-codeink:#e5e7eb;
      --pp-ok:#166534; --pp-warn:#92400e; --pp-bad:#b91c1c;
      --pp-ring:0 0 0 4px rgba(245,158,11,.22);
      --pp-radius:18px;
      --pp-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --pp-sans: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }

    /* HARD RESET INSIDE APP ONLY */
    .pp-app, .pp-app *{ box-sizing:border-box; }
    .pp-app{ font-family:var(--pp-sans); color:var(--pp-ink); }
    .pp-app button, .pp-app input, .pp-app select, .pp-app textarea{ font-family:inherit; }

    body{
      margin:0;
      background:
        radial-gradient(1000px 600px at 10% -10%, rgba(245,158,11,.25), transparent 60%),
        radial-gradient(900px 540px at 95% 0%, rgba(217,119,6,.18), transparent 55%),
        linear-gradient(180deg, var(--pp-bg), #fff 55%, var(--pp-bg));
    }

    .pp-wrap{max-width:1200px;margin:18px auto;padding:14px}

    .pp-topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
    .pp-brand{display:flex;gap:10px;align-items:center}
    .pp-logo{
      width:42px;height:42px;border-radius:14px;
      background:conic-gradient(from 220deg, var(--pp-brand2), var(--pp-brand), #ffb020, var(--pp-brand2));
      box-shadow:var(--pp-shadow);
      border:1px solid rgba(0,0,0,.06);
      position:relative;
      flex:0 0 auto;
    }
    .pp-logo:after{
      content:"</>";
      position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
      font-weight:900;color:#111827;opacity:.9;
      text-shadow:0 1px 0 rgba(255,255,255,.35);
    }
    .pp-title{margin:0;font-size:18px;line-height:1.2}
    .pp-sub{margin:2px 0 0;color:var(--pp-muted);font-size:12px}

    .pp-actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}

    .pp-btn{
      appearance:none;
      border:1px solid var(--pp-border);
      background:var(--pp-card);
      color:var(--pp-ink);
      border-radius:14px;
      padding:10px 12px;
      box-shadow:0 10px 24px rgba(31,41,55,.08);
      cursor:pointer;
      font-weight:800;
      font-size:13px;
      transition:transform .06s ease, box-shadow .2s ease, border-color .2s ease;
      user-select:none;
      line-height:1;
    }
    .pp-btn:hover{transform:translateY(-1px);box-shadow:0 16px 30px rgba(31,41,55,.12);border-color:#e6cfae}
    .pp-btn:active{transform:translateY(0)}
    .pp-btn:focus-visible{outline:none;box-shadow:var(--pp-shadow),var(--pp-ring)}
    .pp-btn-primary{background:linear-gradient(180deg,var(--pp-brand2),var(--pp-brand));border-color:transparent;color:#111827}
    .pp-btn-danger{background:#fff;border-color:#f3c7c7;color:var(--pp-bad)}
    .pp-btn-ghost{background:transparent;box-shadow:none}

    .pp-kbd{
      font-family:var(--pp-mono);
      font-size:11px;
      padding:2px 6px;
      border:1px solid var(--pp-border);
      border-bottom-width:2px;
      border-radius:8px;
      background:#fff;
      margin-left:4px;
    }

    .pp-grid{display:grid;grid-template-columns:1.25fr .75fr;gap:12px}
    @media (max-width:980px){ .pp-grid{grid-template-columns:1fr} .pp-actions{justify-content:flex-start} }

    .pp-card{
      background:rgba(255,255,255,.82);
      border:1px solid var(--pp-border);
      border-radius:var(--pp-radius);
      box-shadow:var(--pp-shadow);
      overflow:hidden;
      backdrop-filter: blur(6px);
    }

    .pp-cardhead{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:12px;
      border-bottom:1px solid var(--pp-border);
      background:linear-gradient(180deg, rgba(255,241,214,.88), rgba(255,255,255,.6));
    }
    .pp-cardhead h2{margin:0;font-size:14px}
    .pp-small{font-size:12px;color:var(--pp-muted)}

    .pp-toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
    .pp-pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--pp-border);background:rgba(255,255,255,.6);padding:8px 10px;border-radius:999px;font-size:12px;color:var(--pp-muted)}
    .pp-select, .pp-input, .pp-textarea{
      border:1px solid var(--pp-border);
      background:#fff;
      border-radius:14px;
      padding:9px 10px;
      font-size:13px;
      outline:none;
    }
    .pp-select:focus, .pp-input:focus, .pp-textarea:focus{box-shadow:var(--pp-ring);border-color:#e6cfae}

    .pp-toggle{display:flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--pp-border);border-radius:999px;background:#fff;font-weight:800;font-size:12px;cursor:pointer}
    .pp-toggle input{accent-color:var(--pp-brand)}

    /* Editor layout */
    .pp-editorwrap{display:grid;grid-template-rows:auto auto 1fr auto;min-height:610px}
    .pp-tabs{
      display:flex !important;
      flex-direction:row !important;
      align-items:center !important;
      justify-content:flex-start !important;
      gap:8px;
      padding:10px 12px;
      border-bottom:1px solid var(--pp-border);
      background:rgba(255,255,255,.55);
      overflow:auto;
    }
    .pp-tab{
      display:inline-flex !important;
      align-items:center;
      justify-content:center;
      white-space:nowrap;
      border:1px solid var(--pp-border);
      background:#fff;
      padding:8px 12px;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
      cursor:pointer;
      line-height:1;
      flex:0 0 auto !important;
      height:auto !important;
      width:auto !important;
    }
    .pp-tab.pp-active{background:linear-gradient(180deg,var(--pp-brand2),var(--pp-brand));border-color:transparent}

    .pp-editorarea{
      background:var(--pp-codebg) !important;
      border-top:1px solid rgba(255,255,255,.06);
      border-bottom:1px solid rgba(255,255,255,.06);
      position:relative;
      min-height:420px;
    }
    .pp-editor{
      position:absolute; inset:0;
      display:grid;
      grid-template-columns:auto 1fr;
      font-family:var(--pp-mono);
      font-size:14px;
      line-height:1.55;
    }
    .pp-gutter{
      padding:12px 10px;
      text-align:right;
      color:rgba(229,231,235,.45);
      background:rgba(255,255,255,.03);
      border-right:1px solid rgba(255,255,255,.06);
      user-select:none;
      min-width:52px;
      overflow:hidden;
      white-space:pre;
    }
    .pp-code{
      width:100%;
      height:100%;
      padding:12px 12px;
      color:var(--pp-codeink) !important;
      caret-color:#fff !important;
      background:transparent !important;
      border:0 !important;
      outline:none !important;
      resize:none;
      font-family:var(--pp-mono) !important;
      font-size:14px;
      line-height:1.55;
      tab-size:4;
      white-space:pre;
      overflow:auto;
    }

    .pp-footerbar{
      padding:10px 12px;
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;
      background:linear-gradient(180deg, rgba(255,255,255,.55), rgba(255,241,214,.58));
      border-top:1px solid var(--pp-border);
    }
    .pp-status{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pp-dot{width:10px;height:10px;border-radius:999px;background:#9ca3af;display:inline-block}
    .pp-dot.ok{background:var(--pp-ok)}
    .pp-dot.warn{background:var(--pp-warn)}
    .pp-dot.bad{background:var(--pp-bad)}
    .pp-progress{height:10px;width:180px;background:rgba(17,24,39,.08);border:1px solid var(--pp-border);border-radius:999px;overflow:hidden}
    .pp-bar{height:100%;width:0%;background:linear-gradient(90deg,var(--pp-brand2),var(--pp-brand));transition:width .25s ease}

    /* Right side */
    .pp-split{display:grid;gap:12px;grid-template-rows:auto auto 1fr}
    .pp-pad{padding:12px}
    .pp-io{width:100%;min-height:90px;font-family:var(--pp-mono);font-size:13px;line-height:1.45}

    .pp-out{
      background:#0b1220;
      color:#e5e7eb;
      border:1px solid rgba(255,255,255,.07);
      border-radius:16px;
      padding:10px;
      font-family:var(--pp-mono);
      font-size:13px;
      line-height:1.55;
      min-height:190px;
      overflow:auto;
      white-space:pre-wrap;
      word-break:break-word;
    }
    .pp-out .err{color:#fecaca}
    .pp-out .ok{color:#bbf7d0}
    .pp-out .dim{color:#93c5fd;opacity:.85}

    .pp-chip{font-size:12px;border:1px solid var(--pp-border);background:rgba(255,255,255,.75);padding:6px 10px;border-radius:999px;cursor:pointer;font-weight:900}
    .pp-chip:hover{box-shadow:var(--pp-ring)}

    .pp-toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background:#111827;color:#fff;border:1px solid rgba(255,255,255,.18);
      padding:10px 12px;border-radius:999px;box-shadow:0 18px 50px rgba(0,0,0,.25);
      font-size:13px;opacity:0;pointer-events:none;transition:opacity .2s ease, transform .2s ease;
      max-width:min(92vw, 900px);
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .pp-toast.show{opacity:1;transform:translateX(-50%) translateY(-2px)}
  </style>

  <!-- Pyodide -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.26.2/full/pyodide.js"></script>
</head>

<body>
  <div class="pp-app">
    <div class="pp-wrap">

      <div class="pp-topbar">
        <div class="pp-brand">
          <div class="pp-logo" aria-hidden="true"></div>
          <div>
            <h1 class="pp-title">Seriously Good Pyodide Editor</h1>
            <div class="pp-sub">Collision-proof CSS ‚Ä¢ tabs ‚Ä¢ stdin ‚Ä¢ packages ‚Ä¢ share/save ‚Ä¢ fixed stderr bug</div>
          </div>
        </div>
        <div class="pp-actions">
          <button class="pp-btn pp-btn-primary" id="ppRun">‚ñ∂ Run <span class="pp-kbd">Ctrl</span><span class="pp-kbd">Enter</span></button>
          <button class="pp-btn pp-btn-danger" id="ppStop">‚õî Stop</button>
          <button class="pp-btn" id="ppFormat">üßº Format</button>
          <button class="pp-btn" id="ppSave">üíæ Save</button>
          <button class="pp-btn" id="ppShare">üîó Share</button>
        </div>
      </div>

      <div class="pp-grid">
        <!-- Left -->
        <section class="pp-card pp-editorwrap">
          <div class="pp-cardhead">
            <div>
              <h2>Editor</h2>
              <div class="pp-small">If your site CSS is aggressive, this stays stable.</div>
            </div>
            <div class="pp-toolbar">
              <select id="ppExample" class="pp-select" title="Load example">
                <option value="">Examples‚Ä¶</option>
              </select>
              <span class="pp-pill"><b>Pyodide:</b> <span id="ppPyText">not loaded</span></span>
              <label class="pp-toggle"><input type="checkbox" id="ppAutoRun"> Auto-run</label>
              <label class="pp-toggle"><input type="checkbox" id="ppTimer" checked> Timer</label>
            </div>
          </div>

          <div class="pp-tabs" id="ppTabs"></div>

          <div class="pp-editorarea">
            <div class="pp-editor">
              <pre class="pp-gutter" id="ppGutter">1</pre>
              <textarea class="pp-code" id="ppCode" spellcheck="false"></textarea>
            </div>
          </div>

          <div class="pp-footerbar">
            <div class="pp-status">
              <span class="pp-dot" id="ppDot"></span>
              <span class="pp-small" id="ppStatus">Ready.</span>
              <div class="pp-progress"><div class="pp-bar" id="ppBar"></div></div>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
              <span class="pp-small">Indent:</span>
              <select id="ppIndent" class="pp-select" style="max-width:140px">
                <option value="2">2 spaces</option>
                <option value="4" selected>4 spaces</option>
                <option value="tab">Tab</option>
              </select>
              <button class="pp-btn pp-btn-ghost" id="ppNewTab">‚ûï Tab</button>
              <button class="pp-btn pp-btn-ghost" id="ppDelTab">üóëÔ∏è</button>
            </div>
          </div>
        </section>

        <!-- Right -->
        <aside class="pp-split">
          <section class="pp-card">
            <div class="pp-cardhead">
              <div>
                <h2>stdin (input)</h2>
                <div class="pp-small">One value per line. Python <code>input()</code> reads from here.</div>
              </div>
              <div class="pp-toolbar">
                <button class="pp-btn pp-btn-ghost" id="ppStdinSample">üéØ Sample</button>
                <button class="pp-btn pp-btn-ghost" id="ppStdinClear">üßΩ Clear</button>
              </div>
            </div>
            <div class="pp-pad">
              <textarea class="pp-textarea pp-io" id="ppStdin" spellcheck="false" placeholder="5&#10;10&#10;hello"></textarea>
              <div class="pp-small" style="margin-top:8px">
                Tip: stdin is only for inputs. Put Python code in the left editor.
              </div>
              <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
                <span class="pp-chip" data-pkg="numpy">+numpy</span>
                <span class="pp-chip" data-pkg="pandas">+pandas</span>
                <span class="pp-chip" data-pkg="matplotlib">+matplotlib</span>
              </div>
            </div>
          </section>

          <section class="pp-card">
            <div class="pp-cardhead">
              <div>
                <h2>Packages</h2>
                <div class="pp-small">Install pure-python wheels via <code>micropip</code>.</div>
              </div>
              <div class="pp-toolbar">
                <button class="pp-btn" id="ppInstall">üì¶ Install</button>
                <button class="pp-btn pp-btn-ghost" id="ppList">üßæ List</button>
              </div>
            </div>
            <div class="pp-pad">
              <label class="pp-small" for="ppPkgs">Packages</label>
              <input id="ppPkgs" class="pp-input" style="width:100%;margin-top:6px" placeholder="numpy, pandas, matplotlib" />
              <div class="pp-small" style="margin-top:8px">
                ‚ö†Ô∏è If a package needs native binaries, it may fail in Pyodide. Pure-python works best.
              </div>
            </div>
          </section>

          <section class="pp-card">
            <div class="pp-cardhead">
              <div>
                <h2>Output</h2>
                <div class="pp-small">Newlines preserved + errors highlighted.</div>
              </div>
              <div class="pp-toolbar">
                <button class="pp-btn pp-btn-ghost" id="ppCopyOut">üìã Copy</button>
                <button class="pp-btn pp-btn-ghost" id="ppClearOut">üßπ Clear</button>
              </div>
            </div>
            <div class="pp-pad">
              <div class="pp-out" id="ppOut"></div>
            </div>
          </section>
        </aside>
      </div>

    </div>

    <div class="pp-toast" id="ppToast"></div>
  </div>

  <script>
    const $ = (id)=>document.getElementById(id);

    const ui = {
      tabs: $("ppTabs"),
      code: $("ppCode"),
      gutter: $("ppGutter"),
      out: $("ppOut"),
      stdin: $("ppStdin"),
      pkgs: $("ppPkgs"),
      example: $("ppExample"),
      indent: $("ppIndent"),
      pyText: $("ppPyText"),
      dot: $("ppDot"),
      status: $("ppStatus"),
      bar: $("ppBar"),
      autorun: $("ppAutoRun"),
      timer: $("ppTimer"),
      toast: $("ppToast"),
    };

    const btn = {
      run: $("ppRun"),
      stop: $("ppStop"),
      format: $("ppFormat"),
      save: $("ppSave"),
      share: $("ppShare"),
      newTab: $("ppNewTab"),
      delTab: $("ppDelTab"),
      install: $("ppInstall"),
      list: $("ppList"),
      sample: $("ppStdinSample"),
      clearStdin: $("ppStdinClear"),
      copyOut: $("ppCopyOut"),
      clearOut: $("ppClearOut"),
    };

    const STORAGE_KEY="pp_pyodide_editor_v2_fixed";
    const STORAGE_STDIN="pp_pyodide_stdin_v2_fixed";

    const EXAMPLES = [
      { title:"Hello + loops", code:`print("Hello")\nfor i in range(5):\n    print("i =", i)\n` },
      { title:"stdin + input()", code:`n=int(input())\nt=0\nfor _ in range(n):\n    t+=int(input())\nprint("sum =", t)\n` },
      { title:"Prime check", code:`x=int(input())\n\ndef is_prime(n):\n    if n<2: return False\n    if n%2==0: return n==2\n    p=3\n    while p*p<=n:\n        if n%p==0: return False\n        p+=2\n    return True\n\nprint("prime" if is_prime(x) else "not prime")\n` },
      { title:"Matplotlib plot", code:`import matplotlib.pyplot as plt\nxs=[1,2,3,4,5]\nys=[x*x for x in xs]\nplt.plot(xs,ys)\nplt.title("Squares")\nplt.show()\nprint("Plot done.")\n` },
    ];

    const DEFAULT_TABS = [{
      name:"main.py",
      code:`# Welcome Champak üëã\n# Ctrl+Enter to run\n\nprint("Namaste!")\nfor i in range(1,6):\n    print(i, i*i)\n`
    }];

    let state = loadState();
    let currentTab = clamp(state.currentTab||0, 0, state.tabs.length-1);

    let pyodide = null;
    let runtimeId = 0;

    function clamp(n,a,b){return Math.max(a,Math.min(b,n));}

    function toast(msg){
      ui.toast.textContent=msg;
      ui.toast.classList.add("show");
      clearTimeout(toast._t);
      toast._t=setTimeout(()=>ui.toast.classList.remove("show"), 1600);
    }

    function setStatus(text, kind){
      ui.status.textContent=text;
      ui.dot.className="pp-dot"+(kind?(" "+kind):"");
    }

    function setProgress(p){ ui.bar.style.width = clamp(p,0,100)+"%"; }

    function escapeHtml(s){
      return (s+"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
    }

    function writeOut(html, append=true){
      if(!append) ui.out.innerHTML="";
      ui.out.innerHTML += html;
      ui.out.scrollTop = ui.out.scrollHeight;
    }

    function loadState(){
      try{
        const raw=localStorage.getItem(STORAGE_KEY);
        if(raw){
          const p=JSON.parse(raw);
          if(p && Array.isArray(p.tabs) && p.tabs.length) return p;
        }
      }catch(e){}
      return {tabs:structuredClone(DEFAULT_TABS), currentTab:0};
    }

    function saveState(){
      try{
        localStorage.setItem(STORAGE_KEY, JSON.stringify({tabs:state.tabs, currentTab}));
      }catch(e){}
    }

    function loadStdin(){
      try{ ui.stdin.value = localStorage.getItem(STORAGE_STDIN) || ""; }catch(e){}
    }

    function saveStdin(){
      try{ localStorage.setItem(STORAGE_STDIN, ui.stdin.value || ""); }catch(e){}
    }

    function renderTabs(){
      ui.tabs.innerHTML="";
      state.tabs.forEach((t,i)=>{
        const b=document.createElement("button");
        b.type="button";
        b.className="pp-tab"+(i===currentTab?" pp-active":"");
        b.textContent=t.name;
        b.onclick=()=>switchTab(i);
        ui.tabs.appendChild(b);
      });

      ui.example.innerHTML =
        `<option value="">Examples‚Ä¶</option>` +
        EXAMPLES.map((e,i)=>`<option value="${i}">${e.title}</option>`).join("");
    }

    function switchTab(i){
      state.tabs[currentTab].code = ui.code.value;
      currentTab = clamp(i,0,state.tabs.length-1);
      ui.code.value = state.tabs[currentTab].code || "";
      renderTabs(); updateGutter(); saveState();
    }

    function newTab(){
      state.tabs[currentTab].code = ui.code.value;
      let n=1;
      const names=new Set(state.tabs.map(t=>t.name));
      let name=`untitled${n}.py`;
      while(names.has(name)){n++; name=`untitled${n}.py`;}
      state.tabs.push({name, code:"# new file\n"});
      currentTab=state.tabs.length-1;
      ui.code.value=state.tabs[currentTab].code;
      renderTabs(); updateGutter(); saveState();
      toast("New tab created");
    }

    function delTab(){
      if(state.tabs.length<=1){ toast("Can't delete last tab"); return; }
      state.tabs[currentTab].code = ui.code.value;
      state.tabs.splice(currentTab,1);
      currentTab = clamp(currentTab,0,state.tabs.length-1);
      ui.code.value = state.tabs[currentTab].code || "";
      renderTabs(); updateGutter(); saveState();
      toast("Tab deleted");
    }

    function updateGutter(){
      const lines = ui.code.value.split("\n").length || 1;
      let s="";
      for(let i=1;i<=lines;i++) s += i+"\n";
      ui.gutter.textContent = s.trimEnd();
      ui.gutter.scrollTop = ui.code.scrollTop;
    }

    ui.code.addEventListener("scroll", ()=> ui.gutter.scrollTop = ui.code.scrollTop);
    ui.code.addEventListener("input", ()=>{ updateGutter(); autosave(); });

    let autosaveT=null;
    function autosave(){
      clearTimeout(autosaveT);
      autosaveT=setTimeout(()=>{
        state.tabs[currentTab].code = ui.code.value;
        saveState();
      }, 250);
    }

    function basicFormat(){
      const mode = ui.indent.value;
      const tabToSpaces = mode !== "tab";
      const spaceCount = parseInt(mode,10) || 4;
      const lines = ui.code.value.split("\n").map(l=>{
        let x = l.replace(/\s+$/g,"");
        if(tabToSpaces) x = x.replace(/\t/g, " ".repeat(spaceCount));
        return x;
      });
      let out = lines.join("\n");
      if(!out.endsWith("\n")) out += "\n";
      ui.code.value=out;
      updateGutter(); autosave();
      toast("Formatted");
    }

    /* ===== JS bridge for Python stdout/stderr (NO double-underscore!) ===== */
    window.pp_write = (text, isErr)=>{
      const safe = escapeHtml(text);
      writeOut(isErr ? `<span class="err">${safe}</span>` : safe, true);
    };

    function stdinQueue(){
      const lines = (ui.stdin.value||"").replace(/\r\n/g,"\n").split("\n");
      let i=0;
      return ()=> (i<lines.length ? lines[i++] : "");
    }

    async function ensurePyodide(){
      if(pyodide) return pyodide;

      setStatus("Loading Pyodide‚Ä¶","warn");
      ui.pyText.textContent="loading‚Ä¶";
      setProgress(12);

      pyodide = await loadPyodide({ indexURL:"https://cdn.jsdelivr.net/pyodide/v0.26.2/full/" });
      setProgress(55);

      await pyodide.loadPackage("micropip");
      setProgress(80);

      /* IMPORTANT: import pp_write (not __pp_write) to avoid Python name-mangling */
      await pyodide.runPythonAsync(`
import sys, builtins
from js import pp_write

class _PPWriter:
    def __init__(self, is_err=False):
        self.is_err = is_err
    def write(self, s):
        pp_write(str(s), self.is_err)
        return len(s)
    def flush(self):
        pass
`);
      setProgress(100);
      setTimeout(()=>setProgress(0), 450);

      ui.pyText.textContent="ready";
      setStatus("Pyodide ready.","ok");
      return pyodide;
    }

    async function resetRuntime(){
      runtimeId++;
      pyodide=null;
      ui.pyText.textContent="not loaded";
      setStatus("Runtime reset. Run to reload.","warn");
      toast("Stopped + runtime reset");
    }

    async function run(){
      const thisRun = ++runtimeId;
      btn.run.disabled=true;
      btn.stop.disabled=false;

      ui.out.innerHTML = `<span class="dim">‚Äî Running ‚Äî</span>\n`;

      state.tabs[currentTab].code = ui.code.value;
      saveState(); saveStdin();

      try{
        const py = await ensurePyodide();
        if(thisRun !== runtimeId) return;

        const nextIn = stdinQueue();
        window.pp_input = ()=> nextIn();

        await py.runPythonAsync(`
import sys, builtins
from js import pp_input
from __main__ import _PPWriter

sys.stdout = _PPWriter(False)
sys.stderr = _PPWriter(True)

def _input(prompt=""):
    if prompt:
        sys.stdout.write(str(prompt))
    return str(pp_input())

builtins.input = _input
`);

        const t0 = performance.now();
        await py.runPythonAsync(ui.code.value || "");
        const t1 = performance.now();

        if(ui.timer.checked){
          writeOut(`\n<span class="ok">\n‚úì Done</span> <span class="dim">(${Math.round(t1-t0)} ms)</span>\n`, true);
        }else{
          writeOut(`\n<span class="ok">\n‚úì Done</span>\n`, true);
        }
        setStatus("Done.","ok");
      }catch(err){
        const msg = err?.message ? err.message : String(err);
        writeOut(`\n<span class="err">\n‚úó Error:</span>\n<span class="err">${escapeHtml(msg)}</span>\n`, true);
        setStatus("Error.","bad");
      }finally{
        if(thisRun === runtimeId){
          btn.run.disabled=false;
          btn.stop.disabled=true;
        }
      }
    }

    async function installPkgs(){
      const raw=(ui.pkgs.value||"").trim();
      if(!raw){ toast("No packages"); return; }
      const pkgs = raw.split(/[, ]+/).map(s=>s.trim()).filter(Boolean);

      ui.out.innerHTML = `<span class="dim">‚Äî Installing ‚Äî</span>\n`;
      setStatus("Installing‚Ä¶","warn");

      const thisRun = ++runtimeId;
      try{
        const py = await ensurePyodide();
        if(thisRun !== runtimeId) return;

        await py.runPythonAsync(`
import micropip
pkgs = ${JSON.stringify(pkgs)}
await micropip.install(pkgs)
print("Installed:", ", ".join(pkgs))
`);
        setStatus("Packages installed.","ok");
      }catch(err){
        const msg = err?.message ? err.message : String(err);
        writeOut(`\n<span class="err">‚úó Install error:</span>\n<span class="err">${escapeHtml(msg)}</span>\n`, true);
        setStatus("Install failed.","bad");
      }
    }

    async function listPkgs(){
      ui.out.innerHTML = `<span class="dim">‚Äî Installed packages ‚Äî</span>\n`;
      const thisRun=++runtimeId;
      try{
        const py = await ensurePyodide();
        if(thisRun !== runtimeId) return;

        await py.runPythonAsync(`
import pkgutil
names = sorted({m.name for m in pkgutil.iter_modules()})
print("\\n".join(names[:4000]))
`);
      }catch(err){
        const msg = err?.message ? err.message : String(err);
        writeOut(`\n<span class="err">‚úó Error:</span>\n<span class="err">${escapeHtml(msg)}</span>\n`, true);
      }
    }

    function share(){
      state.tabs[currentTab].code = ui.code.value;
      const payload = {tabs:state.tabs, currentTab, stdin:ui.stdin.value||"", pkgs:ui.pkgs.value||""};
      const json = JSON.stringify(payload);
      const bytes = new TextEncoder().encode(json);
      let bin=""; bytes.forEach(b=>bin+=String.fromCharCode(b));
      const b64 = btoa(bin).replaceAll("+","-").replaceAll("/","_").replaceAll("=","");
      const url = location.origin + location.pathname + "#" + b64;
      navigator.clipboard?.writeText(url).then(()=>toast("Share link copied")).catch(()=>prompt("Copy link:", url));
    }

    function loadFromHash(){
      const h = location.hash.replace("#","");
      if(!h) return;
      try{
        let b64=h.replaceAll("-","+").replaceAll("_","/");
        while(b64.length%4) b64+="=";
        const bin=atob(b64);
        const bytes=new Uint8Array(bin.length);
        for(let i=0;i<bin.length;i++) bytes[i]=bin.charCodeAt(i);
        const json=new TextDecoder().decode(bytes);
        const payload=JSON.parse(json);

        if(payload?.tabs?.length){
          state.tabs = payload.tabs;
          currentTab = clamp(payload.currentTab||0, 0, state.tabs.length-1);
          ui.stdin.value = payload.stdin || "";
          ui.pkgs.value = payload.pkgs || "";
          ui.code.value = state.tabs[currentTab].code || "";
          saveState(); saveStdin();
        }
      }catch(e){}
    }

    // Buttons
    btn.run.onclick = run;
    btn.stop.onclick = resetRuntime;
    btn.format.onclick = basicFormat;
    btn.save.onclick = ()=>{ state.tabs[currentTab].code = ui.code.value; saveState(); saveStdin(); toast("Saved"); };
    btn.share.onclick = share;
    btn.newTab.onclick = newTab;
    btn.delTab.onclick = delTab;
    btn.install.onclick = installPkgs;
    btn.list.onclick = listPkgs;

    btn.sample.onclick = ()=>{ ui.stdin.value="5\n10\n20\n30\n40\n50\n"; saveStdin(); toast("stdin sample filled"); };
    btn.clearStdin.onclick = ()=>{ ui.stdin.value=""; saveStdin(); toast("stdin cleared"); };

    btn.copyOut.onclick = ()=>{
      const t = ui.out.innerText || "";
      navigator.clipboard?.writeText(t).then(()=>toast("Output copied")).catch(()=>prompt("Copy:", t));
    };
    btn.clearOut.onclick = ()=>{ ui.out.innerHTML=""; toast("Cleared"); };

    ui.example.onchange = ()=>{
      const i = parseInt(ui.example.value,10);
      if(Number.isFinite(i) && EXAMPLES[i]){
        ui.code.value = EXAMPLES[i].code;
        updateGutter(); autosave();
        toast("Example loaded");
        if(ui.autorun.checked) run();
      }
      ui.example.value="";
    };

    // Package chips
    document.querySelectorAll(".pp-chip[data-pkg]").forEach(ch=>{
      ch.onclick = ()=>{
        const p = ch.getAttribute("data-pkg");
        const cur = (ui.pkgs.value||"").trim();
        const parts = cur ? cur.split(/[, ]+/).filter(Boolean) : [];
        if(!parts.includes(p)){ parts.push(p); ui.pkgs.value = parts.join(", "); toast("Added "+p); }
        else toast(p+" already listed");
      };
    });

    // Ctrl+Enter run, Tab indent (simple)
    ui.code.addEventListener("keydown",(e)=>{
      if((e.ctrlKey||e.metaKey) && e.key==="Enter"){ e.preventDefault(); run(); }
      if(e.key==="Tab"){
        e.preventDefault();
        const mode=ui.indent.value;
        const ins = (mode==="tab") ? "\t" : " ".repeat(parseInt(mode,10)||4);
        const el=ui.code;
        const s=el.selectionStart, t=el.selectionEnd;

        if(s!==t){
          const v=el.value;
          const ls=v.lastIndexOf("\n", s-1)+1;
          const le=v.indexOf("\n", t);
          const end = (le===-1)?v.length:le;
          const block=v.slice(ls,end).split("\n").map(line=>ins+line).join("\n");
          el.value = v.slice(0,ls) + block + v.slice(end);
          el.selectionStart = ls;
          el.selectionEnd = ls + block.length;
        }else{
          el.setRangeText(ins, s, s, "end");
        }
        updateGutter(); autosave();
      }
    });

    // Init
    loadFromHash();
    renderTabs();
    loadStdin();
    ui.code.value = state.tabs[currentTab].code || "";
    updateGutter();
    btn.stop.disabled = true;

    // polite preload
    setTimeout(()=>ensurePyodide().catch(()=>{}), 1200);
  </script>
</body>
</html>
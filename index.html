<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Birthday Card Maker ‚Äî Templates + Print + WhatsApp | Champak Roy</title>
  <meta name="description" content="Create beautiful birthday cards with templates, photo, live preview, print-ready layout, download, and WhatsApp sharing. Built by Champak Roy." />
  <meta name="author" content="Champak Roy" />
  <style>
    :root{
      /* Light saffron theme */
      --bg:#fff7e6;
      --card:#ffffff;
      --ink:#1f2937;
      --muted:#6b7280;
      --brand:#d97706;
      --brand2:#f59e0b;
      --border:#eadcc5;
      --shadow:0 18px 45px rgba(31,41,55,.14);
      --ok:#166534;
      --danger:#b91c1c;

      --radius:18px;
      --radius2:24px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background: radial-gradient(1200px 700px at 20% 0%, #fff2d3 0%, var(--bg) 45%, #fff 100%);
      color:var(--ink);
    }

    .wrap{
      max-width:1180px;
      margin:22px auto 34px;
      padding:16px;
    }

    .topbar{
      display:flex;
      gap:14px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      background: rgba(255,255,255,.72);
      border:1px solid var(--border);
      border-radius: var(--radius2);
      padding:14px 16px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(6px);
    }

    .brand{
      display:flex; gap:12px; align-items:center;
      min-width: 240px;
    }
    .logo{
      width:44px; height:44px;
      border-radius:14px;
      background: radial-gradient(circle at 30% 30%, var(--brand2), var(--brand));
      box-shadow: 0 10px 22px rgba(217,119,6,.25);
      display:grid; place-items:center;
      color:#fff; font-weight:900;
      letter-spacing:.5px;
    }
    .brand h1{
      font-size:16px; margin:0;
      line-height:1.2;
    }
    .brand p{
      margin:3px 0 0;
      font-size:12px;
      color:var(--muted);
    }

    .actions{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      justify-content:flex-end;
    }

    button, .btn{
      border:1px solid var(--border);
      background:#fff;
      color:var(--ink);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:650;
      box-shadow: 0 10px 22px rgba(31,41,55,.08);
      transition: transform .08s ease, box-shadow .18s ease, border-color .18s ease;
      user-select:none;
    }
    button:hover, .btn:hover{
      border-color:#e6c999;
      box-shadow: 0 14px 28px rgba(31,41,55,.12);
      transform: translateY(-1px);
    }
    .primary{
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      color:#fff;
      border-color: rgba(0,0,0,.05);
    }
    .danger{
      border-color: rgba(185,28,28,.25);
      color: var(--danger);
    }

    .grid{
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:16px;
      margin-top:16px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }

    .panel{
      background: rgba(255,255,255,.78);
      border:1px solid var(--border);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      padding:14px;
      backdrop-filter: blur(6px);
    }
    .panel h2{
      margin:0 0 10px;
      font-size:14px;
      color: var(--brand);
      letter-spacing:.2px;
    }

    .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    .row3{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px}
    @media (max-width:520px){
      .row,.row3{grid-template-columns:1fr}
    }

    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin:8px 0 6px;
      font-weight:650;
    }
    input, textarea, select{
      width:100%;
      padding:10px 11px;
      border-radius:14px;
      border:1px solid var(--border);
      background:#fff;
      outline:none;
      font-size:14px;
      color:var(--ink);
    }
    textarea{min-height:88px; resize:vertical}

    .hint{
      margin:8px 0 0;
      font-size:12px;
      color:var(--muted);
      line-height:1.45;
    }

    .chips{display:flex; flex-wrap:wrap; gap:8px; margin-top:10px}
    .chip{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      font-size:12px;
      font-weight:750;
      color: var(--ink);
      transition: transform .08s ease, border-color .18s ease;
    }
    .chip:hover{transform: translateY(-1px); border-color:#e6c999}
    .chip.active{
      border-color: rgba(217,119,6,.4);
      background: linear-gradient(135deg, rgba(217,119,6,.12), rgba(245,158,11,.12));
    }

    /* Preview */
    .previewWrap{
      display:grid;
      gap:14px;
    }

    .previewTop{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; flex-wrap:wrap;
    }
    .previewTop .meta{
      font-size:12px; color:var(--muted);
    }

    .stage{
      display:grid;
      place-items:center;
      padding:14px;
      border-radius: var(--radius2);
      border: 1px dashed #e6c999;
      background: linear-gradient(180deg, rgba(255,255,255,.75), rgba(255,255,255,.55));
      min-height: 520px;
    }

    .card{
      width: 760px;
      height: 520px;
      border-radius: 26px;
      border: 1px solid rgba(0,0,0,.06);
      overflow:hidden;
      box-shadow: 0 26px 60px rgba(31,41,55,.18);
      position:relative;
      background: #fff;
      transform-origin: center;
    }
    @media (max-width: 980px){
      .card{width: 92vw; max-width: 760px; height: calc(min(520px, 68vw));}
    }

    .card .bg{
      position:absolute; inset:0;
      background: var(--cardBg, linear-gradient(135deg,#fff,#fff7e6));
    }
    .card .decor{
      position:absolute; inset:0;
      pointer-events:none;
      opacity: var(--decorOpacity, .95);
    }

    .card .content{
      position:absolute; inset:0;
      padding: 26px 28px;
      display:grid;
      grid-template-columns: 1fr 260px;
      gap:18px;
      align-items: center;
    }
    @media (max-width: 700px){
      .card .content{
        grid-template-columns: 1fr;
        grid-template-rows: auto auto;
        padding: 18px 16px;
      }
    }

    .title{
      font-size: var(--titleSize, 48px);
      margin:0;
      line-height:1.05;
      letter-spacing:.2px;
      color: var(--titleColor, #1f2937);
      text-shadow: 0 10px 30px rgba(0,0,0,.08);
      font-weight: 900;
      font-family: var(--titleFont, system-ui);
      word-break: break-word;
    }
    .sub{
      margin:10px 0 0;
      font-size: var(--subSize, 18px);
      color: var(--subColor, #374151);
      font-weight: 700;
      font-family: var(--bodyFont, system-ui);
      word-break: break-word;
    }
    .msg{
      margin:12px 0 0;
      font-size: var(--msgSize, 16px);
      color: var(--msgColor, #374151);
      line-height:1.45;
      white-space: pre-wrap;
      font-family: var(--bodyFont, system-ui);
      word-break: break-word;
    }
    .footer{
      position:absolute;
      left: 24px;
      bottom: 16px;
      right: 24px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-end;
      font-size:12px;
      color: rgba(55,65,81,.8);
      font-weight:650;
      font-family: var(--bodyFont, system-ui);
    }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.08);
      background: rgba(255,255,255,.65);
      backdrop-filter: blur(6px);
    }
    .dot{
      width:9px; height:9px; border-radius:99px;
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      box-shadow: 0 8px 18px rgba(217,119,6,.25);
    }

    /* Photo */
    .photoBox{
      position:relative;
      width: 260px;
      height: 260px;
      border-radius: var(--photoRadius, 22px);
      border: 2px solid rgba(255,255,255,.75);
      box-shadow: 0 22px 55px rgba(31,41,55,.18);
      overflow:hidden;
      background: rgba(255,255,255,.55);
      backdrop-filter: blur(6px);
      justify-self:end;
    }
    @media (max-width:700px){
      .photoBox{justify-self:center; width: 220px; height:220px;}
    }
    .photoBox .ph{
      position:absolute; inset:0;
      background:
        radial-gradient(circle at 30% 30%, rgba(245,158,11,.18), rgba(217,119,6,.08) 45%, rgba(255,255,255,.75) 70%),
        linear-gradient(135deg, rgba(255,255,255,.9), rgba(255,247,230,.85));
      display:grid; place-items:center;
      color: rgba(55,65,81,.75);
      font-weight: 900;
      text-align:center;
      padding: 18px;
    }
    .photoBox img{
      position:absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%) scale(1);
      transform-origin: center;
      user-select:none;
      -webkit-user-drag:none;
      max-width: none;
      width: auto;
      height: auto;
      min-width: 100%;
      min-height: 100%;
      cursor: grab;
    }
    .photoBox img:active{cursor: grabbing;}

    .miniActions{
      display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;
    }

    .twoCols{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    @media (max-width:520px){
      .twoCols{grid-template-columns:1fr}
    }

    .note{
      margin-top:10px;
      padding:10px 12px;
      border-radius:16px;
      background: rgba(245,158,11,.12);
      border:1px solid rgba(217,119,6,.18);
      color:#6b4a1b;
      font-size:12px;
      line-height:1.45;
      font-weight:650;
    }

    /* Print */
    @media print{
      body{background:#fff}
      .wrap{max-width:none; margin:0; padding:0}
      .topbar,.panel,.previewTop,.note{display:none !important}
      .stage{border:none; background:#fff; min-height:auto; padding:0}
      .card{box-shadow:none; border:none}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">CR</div>
        <div>
          <h1>Birthday Card Maker</h1>
          <p>Templates ‚Ä¢ Photo ‚Ä¢ Print ‚Ä¢ WhatsApp ‚Ä¢ <strong>Champak Roy</strong></p>
        </div>
      </div>

      <div class="actions">
        <button id="btnRandom">üé≤ Random Template</button>
        <button id="btnSave">üíæ Save</button>
        <button id="btnLoad">üìÇ Load</button>
        <button id="btnReset" class="danger">‚ôª Reset</button>
        <button id="btnDownload" class="primary">‚¨á Download PNG</button>
        <button id="btnPrint" class="primary">üñ® Print</button>
        <button id="btnWhatsApp" class="primary">üü¢ WhatsApp</button>
      </div>
    </div>

    <div class="grid">
      <!-- Left controls -->
      <div class="panel">
        <h2>1) Card Details</h2>

        <div class="row">
          <div>
            <label>To (Name)</label>
            <input id="toName" placeholder="e.g., Riya" value="Riya" />
          </div>
          <div>
            <label>From (Your name)</label>
            <input id="fromName" placeholder="e.g., Champak" value="Champak" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Age (optional)</label>
            <input id="age" type="number" min="0" placeholder="e.g., 12" value="12" />
          </div>
          <div>
            <label>Date (optional)</label>
            <input id="date" type="date" />
          </div>
        </div>

        <label>Message</label>
        <textarea id="message" placeholder="Write a sweet birthday message...">Wishing you a day full of smiles, surprises, and cake! üéÇ‚ú®</textarea>

        <div class="twoCols">
          <div>
            <label>Title Style</label>
            <select id="titleStyle">
              <option value="classic">Classic</option>
              <option value="fun" selected>Fun</option>
              <option value="elegant">Elegant</option>
              <option value="bold">Bold</option>
            </select>
          </div>
          <div>
            <label>Photo Shape</label>
            <select id="photoShape">
              <option value="rounded" selected>Rounded</option>
              <option value="circle">Circle</option>
              <option value="square">Square</option>
            </select>
          </div>
        </div>

        <div class="twoCols">
          <div>
            <label>Title Size</label>
            <input id="titleSize" type="range" min="34" max="64" value="50" />
          </div>
          <div>
            <label>Message Size</label>
            <input id="msgSize" type="range" min="12" max="22" value="16" />
          </div>
        </div>

        <div class="note">
          ‚úÖ Tip: Upload a photo, then <b>drag</b> to position it. Use the slider to <b>zoom</b>.
        </div>

        <h2 style="margin-top:14px;">2) Choose a Template</h2>
        <div id="templateChips" class="chips"></div>

        <h2 style="margin-top:14px;">3) Add a Photo</h2>
        <div class="row">
          <div>
            <label>Upload Photo</label>
            <input id="photo" type="file" accept="image/*" />
          </div>
          <div>
            <label>Photo Zoom</label>
            <input id="photoZoom" type="range" min="1" max="2.8" step="0.01" value="1.2" />
          </div>
        </div>

        <div class="miniActions">
          <button id="btnClearPhoto">üóë Clear Photo</button>
          <button id="btnCenterPhoto">üéØ Center Photo</button>
        </div>

        <p class="hint">
          Download PNG works best on modern browsers. WhatsApp share opens WhatsApp with your message ‚Äî
          attach the downloaded image manually if you want to send the card image.
        </p>
      </div>

      <!-- Right preview -->
      <div class="previewWrap">
        <div class="panel previewTop">
          <div>
            <div style="font-weight:900;color:var(--brand);">Live Preview</div>
            <div class="meta">Card updates as you type ‚Ä¢ Print-ready ‚Ä¢ 1-click download</div>
          </div>
          <div class="meta" id="activeTemplateMeta">Template: ‚Äî</div>
        </div>

        <div class="stage">
          <div id="card" class="card">
            <div class="bg" id="cardBg"></div>
            <div class="decor" id="decor"></div>

            <div class="content">
              <div>
                <h1 class="title" id="titleText">Happy Birthday</h1>
                <div class="sub" id="subText">Riya ‚Äî 12</div>
                <div class="msg" id="msgText"></div>
              </div>

              <div class="photoBox" id="photoBox">
                <div class="ph" id="photoPlaceholder">
                  <div>
                    <div style="font-size:28px;">üì∏</div>
                    <div style="margin-top:6px;">Upload Photo</div>
                  </div>
                </div>
                <img id="photoImg" alt="Uploaded photo" style="display:none;" />
              </div>
            </div>

            <div class="footer">
              <div class="badge">
                <span class="dot"></span>
                <span id="footerLeft">Made with ‚ù§Ô∏è</span>
              </div>
              <div class="badge" id="footerRight">‚Äî Champak Roy</div>
            </div>
          </div>
        </div>

        <div class="panel">
          <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;">
            <div style="font-weight:900;">Quick Share Text</div>
            <div class="meta">Copy & use anywhere</div>
          </div>
          <textarea id="shareText" readonly></textarea>
        </div>
      </div>
    </div>
  </div>

  <!-- html2canvas for PNG download -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <script>
    // -----------------------------
    // Templates
    // -----------------------------
    const templates = [
      {
        id: "balloons",
        name: "Balloons Pop",
        bg: "linear-gradient(135deg,#fff 0%, #fff7e6 35%, #fff 100%)",
        titleColor: "#111827",
        subColor: "#374151",
        msgColor: "#374151",
        decorOpacity: 1,
        decor: balloonsSVG()
      },
      {
        id: "confetti",
        name: "Confetti Party",
        bg: "linear-gradient(135deg,#ffffff 0%, #fff1d6 45%, #ffffff 100%)",
        titleColor: "#1f2937",
        subColor: "#374151",
        msgColor: "#374151",
        decorOpacity: 1,
        decor: confettiSVG()
      },
      {
        id: "minimal",
        name: "Minimal Classy",
        bg: "linear-gradient(135deg,#ffffff 0%, #ffffff 60%, #fff7e6 100%)",
        titleColor: "#111827",
        subColor: "#374151",
        msgColor: "#374151",
        decorOpacity: .7,
        decor: minimalLinesSVG()
      },
      {
        id: "kids",
        name: "Kids Fun",
        bg: "radial-gradient(900px 600px at 20% 10%, rgba(245,158,11,.20), transparent 55%), linear-gradient(135deg,#ffffff 0%, #fff7e6 45%, #ffffff 100%)",
        titleColor: "#0f172a",
        subColor: "#1f2937",
        msgColor: "#1f2937",
        decorOpacity: 1,
        decor: kidsDoodlesSVG()
      },
      {
        id: "floral",
        name: "Floral Soft",
        bg: "linear-gradient(135deg,#ffffff 0%, #fff7e6 40%, #ffffff 100%)",
        titleColor: "#1f2937",
        subColor: "#374151",
        msgColor: "#374151",
        decorOpacity: .95,
        decor: floralSVG()
      }
    ];

    // -----------------------------
    // Elements
    // -----------------------------
    const el = (id) => document.getElementById(id);

    const toName = el("toName");
    const fromName = el("fromName");
    const age = el("age");
    const date = el("date");
    const message = el("message");
    const titleStyle = el("titleStyle");
    const photoShape = el("photoShape");
    const titleSize = el("titleSize");
    const msgSize = el("msgSize");

    const card = el("card");
    const cardBg = el("cardBg");
    const decor = el("decor");
    const titleText = el("titleText");
    const subText = el("subText");
    const msgText = el("msgText");
    const footerLeft = el("footerLeft");
    const footerRight = el("footerRight");
    const shareText = el("shareText");
    const activeTemplateMeta = el("activeTemplateMeta");

    const templateChips = el("templateChips");

    const photoInput = el("photo");
    const photoImg = el("photoImg");
    const photoPlaceholder = el("photoPlaceholder");
    const photoBox = el("photoBox");
    const photoZoom = el("photoZoom");
    const btnClearPhoto = el("btnClearPhoto");
    const btnCenterPhoto = el("btnCenterPhoto");

    // Top buttons
    const btnRandom = el("btnRandom");
    const btnSave = el("btnSave");
    const btnLoad = el("btnLoad");
    const btnReset = el("btnReset");
    const btnDownload = el("btnDownload");
    const btnPrint = el("btnPrint");
    const btnWhatsApp = el("btnWhatsApp");

    // -----------------------------
    // State
    // -----------------------------
    let activeTemplateId = templates[1].id; // default: Confetti Party

    // Photo drag state
    let imgLoaded = false;
    let drag = { active:false, startX:0, startY:0, imgX:0, imgY:0 };
    let imgPos = { x: 0, y: 0, scale: parseFloat(photoZoom.value) };

    // -----------------------------
    // Helpers
    // -----------------------------
    function safeText(s){ return (s ?? "").toString().trim(); }

    function computeSubline(){
      const name = safeText(toName.value) || "Friend";
      const a = safeText(age.value);
      const d = safeText(date.value);
      let parts = [name];
      if (a) parts.push(a);
      if (d) parts.push(formatDate(d));
      return parts.join(" ‚Äî ");
    }

    function formatDate(iso){
      // iso: YYYY-MM-DD
      try{
        const [y,m,dd] = iso.split("-").map(Number);
        const dt = new Date(y, m-1, dd);
        const opts = { day:"2-digit", month:"short", year:"numeric" };
        return dt.toLocaleDateString(undefined, opts);
      }catch(e){
        return iso;
      }
    }

    function applyFonts(){
      const style = titleStyle.value;
      let titleFont = "system-ui";
      let bodyFont = "system-ui";
      if (style === "fun"){
        titleFont = "ui-rounded, system-ui, Segoe UI, Arial";
        bodyFont = "system-ui, Segoe UI, Arial";
      } else if (style === "elegant"){
        titleFont = "Georgia, 'Times New Roman', serif";
        bodyFont = "system-ui, Segoe UI, Arial";
      } else if (style === "bold"){
        titleFont = "Impact, Haettenschweiler, 'Arial Narrow Bold', sans-serif";
        bodyFont = "system-ui, Segoe UI, Arial";
      }
      card.style.setProperty("--titleFont", titleFont);
      card.style.setProperty("--bodyFont", bodyFont);
    }

    function applySizes(){
      card.style.setProperty("--titleSize", `${titleSize.value}px`);
      card.style.setProperty("--msgSize", `${msgSize.value}px`);
    }

    function applyPhotoShape(){
      const v = photoShape.value;
      let r = "22px";
      if (v === "circle") r = "999px";
      if (v === "square") r = "10px";
      photoBox.style.setProperty("--photoRadius", r);
    }

    function renderChips(){
      templateChips.innerHTML = "";
      templates.forEach(t=>{
        const b = document.createElement("button");
        b.className = "chip" + (t.id===activeTemplateId ? " active" : "");
        b.type = "button";
        b.textContent = t.name;
        b.addEventListener("click", ()=> setTemplate(t.id));
        templateChips.appendChild(b);
      });
    }

    function setTemplate(id){
      const t = templates.find(x=>x.id===id) || templates[0];
      activeTemplateId = t.id;

      card.style.setProperty("--cardBg", t.bg);
      card.style.setProperty("--titleColor", t.titleColor);
      card.style.setProperty("--subColor", t.subColor);
      card.style.setProperty("--msgColor", t.msgColor);
      card.style.setProperty("--decorOpacity", t.decorOpacity);

      decor.innerHTML = t.decor;
      activeTemplateMeta.textContent = `Template: ${t.name}`;
      renderChips();
      update();
    }

    function update(){
      // Text
      const who = safeText(toName.value) || "Friend";
      const from = safeText(fromName.value) || "Someone";
      const msg = safeText(message.value) || "Have a wonderful day! üéâ";
      titleText.textContent = "Happy Birthday";
      subText.textContent = computeSubline();
      msgText.textContent = msg;

      footerLeft.textContent = `To: ${who}`;
      footerRight.textContent = `‚Äî From ${from} ‚Ä¢ Champak Roy`;

      applyFonts();
      applySizes();
      applyPhotoShape();

      // Share text
      const a = safeText(age.value);
      const d = safeText(date.value);
      const niceDate = d ? `\nDate: ${formatDate(d)}` : "";
      const niceAge = a ? `\nAge: ${a}` : "";
      shareText.value =
`üéâ Happy Birthday, ${who}! üéÇ${niceAge}${niceDate}

${msg}

‚Äî ${from}

(Generated using Birthday Card Maker by Champak Roy)`;
    }

    function resetAll(){
      toName.value = "Riya";
      fromName.value = "Champak";
      age.value = "12";
      date.value = "";
      message.value = "Wishing you a day full of smiles, surprises, and cake! üéÇ‚ú®";
      titleStyle.value = "fun";
      photoShape.value = "rounded";
      titleSize.value = 50;
      msgSize.value = 16;

      clearPhoto();
      setTemplate("confetti");
      update();
    }

    // -----------------------------
    // Photo handling (upload + drag + zoom)
    // -----------------------------
    function clearPhoto(){
      imgLoaded = false;
      photoImg.style.display = "none";
      photoPlaceholder.style.display = "grid";
      photoImg.src = "";
      photoInput.value = "";
      imgPos = { x: 0, y: 0, scale: parseFloat(photoZoom.value) };
      applyImageTransform();
    }

    function centerPhoto(){
      imgPos.x = 0;
      imgPos.y = 0;
      applyImageTransform();
    }

    function applyImageTransform(){
      if(!imgLoaded) return;
      const s = imgPos.scale;
      photoImg.style.transform = `translate(calc(-50% + ${imgPos.x}px), calc(-50% + ${imgPos.y}px)) scale(${s})`;
    }

    photoInput.addEventListener("change", (e)=>{
      const file = e.target.files && e.target.files[0];
      if(!file) return;
      const url = URL.createObjectURL(file);
      photoImg.onload = () => {
        imgLoaded = true;
        photoPlaceholder.style.display = "none";
        photoImg.style.display = "block";
        // Start a bit zoomed-in for nicer framing
        imgPos.scale = parseFloat(photoZoom.value);
        imgPos.x = 0; imgPos.y = 0;
        applyImageTransform();
      };
      photoImg.src = url;
    });

    photoZoom.addEventListener("input", ()=>{
      imgPos.scale = parseFloat(photoZoom.value);
      applyImageTransform();
    });

    // Dragging
    function getPoint(evt){
      if (evt.touches && evt.touches[0]) return {x: evt.touches[0].clientX, y: evt.touches[0].clientY};
      return {x: evt.clientX, y: evt.clientY};
    }

    function onDown(evt){
      if(!imgLoaded) return;
      evt.preventDefault();
      drag.active = true;
      const p = getPoint(evt);
      drag.startX = p.x;
      drag.startY = p.y;
      drag.imgX = imgPos.x;
      drag.imgY = imgPos.y;
    }
    function onMove(evt){
      if(!drag.active || !imgLoaded) return;
      const p = getPoint(evt);
      const dx = p.x - drag.startX;
      const dy = p.y - drag.startY;
      imgPos.x = drag.imgX + dx;
      imgPos.y = drag.imgY + dy;
      applyImageTransform();
    }
    function onUp(){
      drag.active = false;
    }

    photoBox.addEventListener("mousedown", onDown);
    window.addEventListener("mousemove", onMove);
    window.addEventListener("mouseup", onUp);

    photoBox.addEventListener("touchstart", onDown, {passive:false});
    window.addEventListener("touchmove", onMove, {passive:false});
    window.addEventListener("touchend", onUp);

    btnClearPhoto.addEventListener("click", clearPhoto);
    btnCenterPhoto.addEventListener("click", centerPhoto);

    // -----------------------------
    // Save / Load
    // -----------------------------
    const STORAGE_KEY = "birthday_card_maker_v1_champak_roy";

    function getState(){
      // Note: we do not store the actual photo file; only layout settings.
      return {
        toName: toName.value,
        fromName: fromName.value,
        age: age.value,
        date: date.value,
        message: message.value,
        titleStyle: titleStyle.value,
        photoShape: photoShape.value,
        titleSize: titleSize.value,
        msgSize: msgSize.value,
        templateId: activeTemplateId,
        photoZoom: photoZoom.value,
        photoPos: imgPos
      };
    }

    function setState(s){
      if(!s) return;
      toName.value = s.toName ?? "";
      fromName.value = s.fromName ?? "";
      age.value = s.age ?? "";
      date.value = s.date ?? "";
      message.value = s.message ?? "";
      titleStyle.value = s.titleStyle ?? "fun";
      photoShape.value = s.photoShape ?? "rounded";
      titleSize.value = s.titleSize ?? 50;
      msgSize.value = s.msgSize ?? 16;

      photoZoom.value = s.photoZoom ?? 1.2;
      imgPos = s.photoPos ?? {x:0,y:0,scale: parseFloat(photoZoom.value)};

      setTemplate(s.templateId ?? "confetti");
      update();
      applyImageTransform();
    }

    btnSave.addEventListener("click", ()=>{
      localStorage.setItem(STORAGE_KEY, JSON.stringify(getState()));
      toast("Saved ‚úÖ");
    });

    btnLoad.addEventListener("click", ()=>{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw){ toast("No saved design found."); return; }
      try{
        const s = JSON.parse(raw);
        setState(s);
        toast("Loaded ‚úÖ");
      }catch(e){
        toast("Saved data is corrupted.");
      }
    });

    btnReset.addEventListener("click", ()=>{
      if(confirm("Reset everything?")){
        localStorage.removeItem(STORAGE_KEY);
        resetAll();
        toast("Reset ‚úÖ");
      }
    });

    // -----------------------------
    // Random template
    // -----------------------------
    btnRandom.addEventListener("click", ()=>{
      const i = Math.floor(Math.random() * templates.length);
      setTemplate(templates[i].id);
      toast("Random template applied üé≤");
    });

    // -----------------------------
    // Download PNG
    // -----------------------------
    btnDownload.addEventListener("click", async ()=>{
      // Make it crisp
      const scale = 2;
      const canvas = await html2canvas(card, {
        backgroundColor: null,
        scale,
        useCORS: true
      });
      const a = document.createElement("a");
      const who = safeText(toName.value) || "birthday-card";
      a.download = `birthday-card-${who.replace(/\s+/g,"-").toLowerCase()}.png`;
      a.href = canvas.toDataURL("image/png");
      a.click();
      toast("Downloaded PNG ‚úÖ");
    });

    // -----------------------------
    // Print
    // -----------------------------
    btnPrint.addEventListener("click", ()=>{
      // Print only the card by opening a print window
      const t = templates.find(x=>x.id===activeTemplateId) || templates[0];
      const printWin = window.open("", "_blank");
      const photoHTML = imgLoaded
        ? `<img src="${photoImg.src}" style="position:absolute;left:50%;top:50%;transform:${photoImg.style.transform};max-width:none;min-width:100%;min-height:100%;user-select:none;-webkit-user-drag:none;" />`
        : `<div style="position:absolute;inset:0;display:grid;place-items:center;color:rgba(55,65,81,.75);font-weight:900;background:rgba(255,255,255,.55);">
            <div style="text-align:center">
              <div style="font-size:28px">üì∏</div>
              <div style="margin-top:6px">No Photo</div>
            </div>
          </div>`;

      const photoRadius = getComputedStyle(photoBox).getPropertyValue("--photoRadius") || "22px";

      printWin.document.write(`
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Print Birthday Card</title>
  <style>
    @page { size: A4; margin: 10mm; }
    body{ margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#fff; }
    .sheet{ display:grid; place-items:center; min-height: 100vh; padding: 10mm; }
    .card{
      width: 180mm; height: 120mm;
      border-radius: 26px;
      overflow:hidden;
      position:relative;
      border: 1px solid rgba(0,0,0,.08);
    }
    .bg{ position:absolute; inset:0; background: ${t.bg}; }
    .decor{ position:absolute; inset:0; opacity:${t.decorOpacity}; }
    .content{
      position:absolute; inset:0;
      padding: 18mm 18mm;
      display:grid;
      grid-template-columns: 1fr 70mm;
      gap: 10mm;
      align-items:center;
    }
    .title{
      font-size: ${titleSize.value}px;
      margin:0;
      line-height:1.05;
      font-weight:900;
      color: ${t.titleColor};
      font-family: ${getComputedStyle(card).getPropertyValue("--titleFont") || "system-ui"};
    }
    .sub{
      margin:6mm 0 0;
      font-size: 18px;
      font-weight:800;
      color: ${t.subColor};
    }
    .msg{
      margin:6mm 0 0;
      font-size: ${msgSize.value}px;
      line-height:1.45;
      color: ${t.msgColor};
      white-space: pre-wrap;
    }
    .photoBox{
      width: 70mm; height: 70mm;
      border-radius: ${photoRadius};
      border: 2px solid rgba(255,255,255,.8);
      overflow:hidden;
      position:relative;
      background: rgba(255,255,255,.55);
    }
    .footer{
      position:absolute;
      left: 12mm; right: 12mm; bottom: 8mm;
      display:flex; justify-content:space-between; gap:8mm;
      font-size: 12px;
      color: rgba(55,65,81,.85);
      font-weight:700;
    }
    .badge{ padding:6px 10px; border-radius:999px; border:1px solid rgba(0,0,0,.10); background: rgba(255,255,255,.7); }
  </style>
</head>
<body>
  <div class="sheet">
    <div class="card">
      <div class="bg"></div>
      <div class="decor">${t.decor}</div>
      <div class="content">
        <div>
          <h1 class="title">Happy Birthday</h1>
          <div class="sub">${escapeHTML(computeSubline())}</div>
          <div class="msg">${escapeHTML(safeText(message.value) || "")}</div>
        </div>
        <div class="photoBox">
          ${photoHTML}
        </div>
      </div>
      <div class="footer">
        <div class="badge">To: ${escapeHTML(safeText(toName.value) || "Friend")}</div>
        <div class="badge">From ${escapeHTML(safeText(fromName.value) || "Someone")} ‚Ä¢ Champak Roy</div>
      </div>
    </div>
  </div>
  <script>
    window.onload = () => setTimeout(()=>window.print(), 200);
  </script>
</body>
</html>`);
      printWin.document.close();
    });

    // -----------------------------
    // WhatsApp Share
    // -----------------------------
    btnWhatsApp.addEventListener("click", ()=>{
      const text = shareText.value || "";
      const url = "https://wa.me/?text=" + encodeURIComponent(text);
      window.open(url, "_blank");
    });

    // -----------------------------
    // Input listeners
    // -----------------------------
    [toName, fromName, age, date, message, titleStyle, photoShape, titleSize, msgSize].forEach(x=>{
      x.addEventListener("input", update);
      x.addEventListener("change", update);
    });

    // -----------------------------
    // Toast
    // -----------------------------
    let toastTimer = null;
    function toast(msg){
      let t = document.getElementById("toast");
      if(!t){
        t = document.createElement("div");
        t.id = "toast";
        t.style.position = "fixed";
        t.style.left = "50%";
        t.style.bottom = "18px";
        t.style.transform = "translateX(-50%)";
        t.style.background = "rgba(17,24,39,.92)";
        t.style.color = "#fff";
        t.style.padding = "10px 12px";
        t.style.borderRadius = "14px";
        t.style.fontWeight = "800";
        t.style.fontSize = "13px";
        t.style.boxShadow = "0 18px 40px rgba(0,0,0,.25)";
        t.style.zIndex = "9999";
        t.style.maxWidth = "92vw";
        document.body.appendChild(t);
      }
      t.textContent = msg;
      t.style.opacity = "1";
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=>{ t.style.opacity = "0"; }, 1300);
    }

    // -----------------------------
    // SVG Decor Generators
    // -----------------------------
    function balloonsSVG(){
      return `
<svg viewBox="0 0 760 520" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <radialGradient id="g1" cx="30%" cy="20%">
      <stop offset="0" stop-color="rgba(245,158,11,.85)"/>
      <stop offset="1" stop-color="rgba(217,119,6,.9)"/>
    </radialGradient>
    <radialGradient id="g2" cx="30%" cy="20%">
      <stop offset="0" stop-color="rgba(255,255,255,.95)"/>
      <stop offset="1" stop-color="rgba(245,158,11,.65)"/>
    </radialGradient>
  </defs>

  <g opacity="0.95">
    <circle cx="80" cy="90" r="46" fill="url(#g1)"/>
    <circle cx="150" cy="70" r="34" fill="url(#g2)"/>
    <circle cx="690" cy="110" r="48" fill="url(#g2)"/>
    <circle cx="630" cy="60" r="30" fill="url(#g1)"/>

    <path d="M80 136 C78 200, 90 260, 70 330" stroke="rgba(31,41,55,.35)" stroke-width="2" fill="none"/>
    <path d="M150 104 C145 160, 160 230, 140 300" stroke="rgba(31,41,55,.35)" stroke-width="2" fill="none"/>
    <path d="M690 158 C675 210, 700 270, 675 340" stroke="rgba(31,41,55,.35)" stroke-width="2" fill="none"/>
    <path d="M630 90 C620 155, 640 220, 615 290" stroke="rgba(31,41,55,.35)" stroke-width="2" fill="none"/>
  </g>

  <g opacity="0.25">
    <circle cx="260" cy="450" r="140" fill="rgba(245,158,11,.25)"/>
    <circle cx="560" cy="440" r="160" fill="rgba(217,119,6,.18)"/>
  </g>
</svg>`;
    }

    function confettiSVG(){
      // Simple confetti rectangles + streamers
      const pieces = [];
      for(let i=0;i<90;i++){
        const x = Math.random()*760;
        const y = Math.random()*520;
        const w = 6 + Math.random()*10;
        const h = 3 + Math.random()*10;
        const r = (Math.random()*70)-35;
        const op = 0.18 + Math.random()*0.28;
        pieces.push(`<rect x="${x.toFixed(1)}" y="${y.toFixed(1)}" width="${w.toFixed(1)}" height="${h.toFixed(1)}"
          rx="2" fill="rgba(217,119,6,${op.toFixed(2)})" transform="rotate(${r.toFixed(1)} ${x.toFixed(1)} ${y.toFixed(1)})"/>`);
      }
      return `
<svg viewBox="0 0 760 520" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
  <path d="M-10 120 C 140 40, 260 200, 420 120 S 650 120, 770 60" stroke="rgba(245,158,11,.25)" stroke-width="12" fill="none" stroke-linecap="round"/>
  <path d="M-10 180 C 170 110, 330 250, 510 170 S 660 150, 770 120" stroke="rgba(217,119,6,.18)" stroke-width="10" fill="none" stroke-linecap="round"/>
  ${pieces.join("")}
</svg>`;
    }

    function minimalLinesSVG(){
      return `
<svg viewBox="0 0 760 520" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
  <g opacity="0.22" stroke="rgba(217,119,6,.55)" stroke-width="2" fill="none">
    <path d="M40 80 H720" stroke-dasharray="6 10"/>
    <path d="M60 120 H700" stroke-dasharray="6 10"/>
    <path d="M40 440 H720" stroke-dasharray="6 10"/>
    <path d="M60 400 H700" stroke-dasharray="6 10"/>
  </g>
  <g opacity="0.20">
    <circle cx="90" cy="260" r="120" fill="rgba(245,158,11,.18)"/>
    <circle cx="670" cy="260" r="140" fill="rgba(217,119,6,.12)"/>
  </g>
</svg>`;
    }

    function kidsDoodlesSVG(){
      return `
<svg viewBox="0 0 760 520" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
  <g opacity="0.9">
    <circle cx="90" cy="80" r="26" fill="rgba(245,158,11,.45)"/>
    <circle cx="140" cy="110" r="14" fill="rgba(217,119,6,.30)"/>
    <circle cx="680" cy="90" r="22" fill="rgba(245,158,11,.35)"/>
    <circle cx="620" cy="130" r="12" fill="rgba(217,119,6,.28)"/>
  </g>
  <g opacity="0.24" stroke="rgba(217,119,6,.85)" stroke-width="5" fill="none" stroke-linecap="round">
    <path d="M90 430 C 160 360, 240 520, 330 440"/>
    <path d="M430 450 C 520 380, 610 520, 720 420"/>
  </g>
  <g opacity="0.18">
    <polygon points="80,250 95,280 128,284 103,304 110,336 80,320 50,336 57,304 32,284 65,280" fill="rgba(245,158,11,.55)"/>
    <polygon points="690,260 705,290 738,294 713,314 720,346 690,330 660,346 667,314 642,294 675,290" fill="rgba(217,119,6,.45)"/>
  </g>
</svg>`;
    }

    function floralSVG(){
      return `
<svg viewBox="0 0 760 520" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
  <g opacity="0.22">
    <circle cx="90" cy="430" r="120" fill="rgba(245,158,11,.22)"/>
    <circle cx="680" cy="420" r="140" fill="rgba(217,119,6,.16)"/>
  </g>
  <g opacity="0.9">
    ${flower(70, 420, 34)}
    ${flower(120, 460, 24)}
    ${flower(690, 430, 38)}
    ${flower(640, 470, 22)}
  </g>
</svg>`;
    }

    function flower(cx, cy, r){
      // petals
      const petals = [];
      for(let i=0;i<6;i++){
        const a = (Math.PI*2/6)*i;
        const px = cx + Math.cos(a)*r*0.9;
        const py = cy + Math.sin(a)*r*0.9;
        petals.push(`<ellipse cx="${px}" cy="${py}" rx="${r*0.55}" ry="${r*0.32}" fill="rgba(245,158,11,.35)"/>`);
      }
      return `
<g>
  ${petals.join("")}
  <circle cx="${cx}" cy="${cy}" r="${r*0.32}" fill="rgba(217,119,6,.42)"/>
  <circle cx="${cx}" cy="${cy}" r="${r*0.18}" fill="rgba(255,255,255,.75)"/>
</g>`;
    }

    // -----------------------------
    // Utilities
    // -----------------------------
    function escapeHTML(str){
      return (str ?? "").toString()
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;")
        .replaceAll("\n","<br/>");
    }

    // -----------------------------
    // Init
    // -----------------------------
    function init(){
      // Default date empty; user can set
      renderChips();
      setTemplate(activeTemplateId);
      update();

      // Try auto-load a saved state (non-blocking)
      const raw = localStorage.getItem(STORAGE_KEY);
      if(raw){
        try{ setState(JSON.parse(raw)); }catch(e){}
      }
    }
    init();
  </script>
</body>
</html>
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Programming Whiteboard PRO ‚Äî Drag ‚Ä¢ Resize ‚Ä¢ Rotate ‚Ä¢ Draw ‚Ä¢ Connect ‚Ä¢ Save/Export</title>
<style>
:root{
  --bg:#fff7e6;--card:#fff;--ink:#1f2937;--muted:#6b7280;--brand:#d97706;--brand2:#f59e0b;
  --border:#eadcc5;--shadow:0 18px 40px rgba(31,41,55,.14);
  --grid:rgba(255,255,255,.08);
  --snap:rgba(245,158,11,.95);
  --safe:rgba(255,255,255,.18);
  --codebg:#0b1220;--codeink:#e5e7eb;
  --note:#fff6cc;
  --shape:#111827;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--ink)}
.wrap{max-width:1500px;margin:18px auto;padding:14px}
h1{margin:6px 0 14px;text-align:center;color:var(--brand)}
.grid{display:grid;grid-template-columns:400px 1fr;gap:14px;align-items:start}
.card{background:var(--card);border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow);padding:14px}
label{display:block;font-size:13px;font-weight:900;margin-top:10px}
input,select,textarea,button{width:100%;margin-top:6px;padding:9px 10px;border-radius:10px;border:1px solid var(--border);font-size:14px}
textarea{resize:vertical}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
.btn{background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;border:0;cursor:pointer;font-weight:900}
.btn.secondary{background:#fff;color:var(--brand);border:1px solid var(--brand)}
.btn.ghost{background:transparent;border:1px dashed var(--border);color:var(--ink);font-weight:800}
.pill{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:8px 10px;border-radius:999px;border:1px solid var(--border);background:#fff;box-shadow:0 8px 20px rgba(31,41,55,.08)}
.small{font-size:12px;color:var(--muted);line-height:1.35;margin-top:8px}
hr{border:none;border-top:1px solid var(--border);margin:14px 0}

/* BOARD */
.boardWrap{position:relative}
#board{
  width:100%;
  aspect-ratio:16/9;
  background:#0a0a0a;
  border-radius:18px;
  border:1px solid rgba(255,255,255,.10);
  overflow:hidden;
  position:relative;
}
#board.gridOn{
  background-image:
    linear-gradient(to right, var(--grid) 1px, transparent 1px),
    linear-gradient(to bottom, var(--grid) 1px, transparent 1px);
  background-size: 30px 30px;
}
#safeArea{position:absolute;inset:0;pointer-events:none;display:none;z-index:2}
#safeArea::before{
  content:"";
  position:absolute;left:5%;top:5%;right:5%;bottom:5%;
  border:2px dashed var(--safe);border-radius:14px;
}

/* Snap guide lines */
.guide{position:absolute;pointer-events:none;display:none;z-index:99999;background:var(--snap);opacity:.9}
#vGuide{width:2px;top:0;bottom:0}
#hGuide{height:2px;left:0;right:0}

/* Connections layer */
#linksSvg{
  position:absolute;inset:0;
  width:100%;height:100%;
  z-index:3;
  pointer-events:none;
}
#linksSvg .link{
  stroke:rgba(245,158,11,.95);
  stroke-width:3;
  fill:none;
}
#linksSvg .linkShadow{
  stroke:rgba(0,0,0,.45);
  stroke-width:6;
  fill:none;
}

/* Drawing layer */
#drawCanvas{
  position:absolute;inset:0;
  width:100%;height:100%;
  z-index:4;
  pointer-events:none; /* enabled only in draw mode */
}

/* ELEMENT */
.el{position:absolute;border-radius:14px;overflow:visible;user-select:none;touch-action:none;z-index:5}
.el .box{
  position:absolute;inset:0;border:1px solid rgba(255,255,255,.15);
  border-radius:14px;overflow:hidden;box-shadow:0 12px 28px rgba(0,0,0,.35);
  background:rgba(0,0,0,.15);
}
.el.selected .box{outline:2px solid rgba(245,158,11,.95);outline-offset:2px}
.el .hdr{
  position:absolute;left:0;top:0;right:0;padding:7px 10px;
  display:flex;justify-content:space-between;align-items:center;gap:10px;
  background:linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,0));
  color:#fff;font-size:12px;border-radius:14px 14px 0 0;
}
.el .hdr b{font-weight:900}
.el .hdr .mini{display:flex;gap:6px;align-items:center}
.iconBtn{
  width:auto;padding:6px 8px;border-radius:10px;border:1px solid rgba(255,255,255,.2);
  background:rgba(0,0,0,.25);color:#fff;cursor:pointer;font-weight:900;font-size:12px;
}
.iconBtn:hover{background:rgba(0,0,0,.4)}
.content{position:absolute;inset:0;display:flex;align-items:center;justify-content:center}

/* Resize handles */
.handle{position:absolute;width:12px;height:12px;border-radius:4px;background:rgba(245,158,11,.95);border:1px solid rgba(0,0,0,.35)}
.handle.br{right:-6px;bottom:-6px;cursor:nwse-resize}
.handle.tr{right:-6px;top:22px;cursor:nesw-resize}
.handle.bl{left:-6px;bottom:-6px;cursor:nesw-resize}
.handle.tl{left:-6px;top:22px;cursor:nwse-resize}

/* Rotate handle */
.rhandle{position:absolute;left:50%;top:-26px;transform:translateX(-50%);width:16px;height:16px;border-radius:999px;background:rgba(245,158,11,.95);border:1px solid rgba(0,0,0,.35);cursor:grab}
.rstick{position:absolute;left:50%;top:-14px;transform:translateX(-50%);width:2px;height:14px;background:rgba(245,158,11,.85)}

/* Note */
.note{
  width:100%;height:100%;
  padding:40px 12px 12px;
  background:linear-gradient(180deg, rgba(255,255,255,.12), rgba(0,0,0,0)), var(--note);
  color:#111827;
  font-weight:800;
}
.note textarea{
  width:100%;height:100%;
  border:0;outline:none;
  background:transparent;
  font-weight:800;
  font-size:18px;
  color:#111827;
  resize:none;
}

/* Code block */
.codeWrap{
  width:100%;height:100%;
  display:flex;flex-direction:column;
  background:rgba(0,0,0,.10);
}
.codeTop{
  margin-top:32px;
  display:flex;gap:8px;
  padding:8px 10px;
  align-items:center;
}
.codeTop .chip{
  width:auto;border:1px solid rgba(255,255,255,.18);
  background:rgba(0,0,0,.25);color:#fff;
  padding:6px 10px;border-radius:999px;
  font-size:12px;font-weight:900;
}
.codeTop button{
  width:auto;margin:0;
  padding:7px 10px;border-radius:10px;
  border:1px solid rgba(255,255,255,.20);
  background:rgba(0,0,0,.25);
  color:#fff;cursor:pointer;font-weight:900;
}
.codeTop button:hover{background:rgba(0,0,0,.40)}
.codeArea{
  flex:1;
  padding:0 10px 10px;
}
.codeArea textarea{
  width:100%;height:100%;
  border:1px solid rgba(255,255,255,.16);
  background:var(--codebg);
  color:var(--codeink);
  border-radius:12px;
  font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
  font-size:14px;
  line-height:1.35;
  padding:10px;
  outline:none;
  resize:none;
}

/* Output block */
.outputWrap{
  width:100%;height:100%;
  background:rgba(255,255,255,.06);
  padding:40px 12px 12px;
}
.outputWrap pre{
  margin:0;height:100%;
  overflow:auto;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(0,0,0,.45);
  color:#e5e7eb;
  border-radius:12px;
  padding:10px;
  font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
  font-size:13px;
  line-height:1.35;
}

/* Shapes */
.shape{
  width:100%;height:100%;
  display:flex;align-items:center;justify-content:center;
  color:#fff;font-weight:1000;
  padding:38px 10px 10px;
  text-align:center;
}
.shape .label{
  pointer-events:auto;
  border:0;outline:none;
  background:transparent;
  color:#fff;font-weight:1000;
  font-size:20px;
  width:100%;
  text-align:center;
}
.shape.rect{background:rgba(17,24,39,.70)}
.shape.round{background:rgba(17,24,39,.70);border-radius:999px}
.shape.diamond{
  background:rgba(17,24,39,.70);
  transform:rotate(45deg);
}
.shape.diamond .label{transform:rotate(-45deg)}

@media (max-width: 1050px){ .grid{grid-template-columns:1fr} }
</style>
</head>
<body>
<div class="wrap">
  <h1>üß† Programming Whiteboard PRO</h1>

  <div class="grid">
    <!-- LEFT -->
    <div class="card">
      <div class="pill">
        <span><b>Tools</b></span>
        <span style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end">
          <label style="margin:0;font-size:12px;font-weight:900">Grid</label>
          <input id="gridToggle" type="checkbox" style="width:auto;margin:0">
          <label style="margin:0;font-size:12px;font-weight:900">Safe</label>
          <input id="safeToggle" type="checkbox" style="width:auto;margin:0">
          <label style="margin:0;font-size:12px;font-weight:900">Snap</label>
          <input id="snapToggle" type="checkbox" style="width:auto;margin:0" checked>
        </span>
      </div>

      <div class="row">
        <button class="btn" id="addCodeBtn">‚ûï Code Block</button>
        <button class="btn" id="addNoteBtn">üóíÔ∏è Note</button>
      </div>

      <div class="row">
        <button class="btn" id="addOutBtn">üßæ Output</button>
        <button class="btn" id="addShapeBtn">‚¨õ Shape</button>
      </div>

      <div class="row">
        <button class="btn secondary" id="connectBtn">üîó Connect (2 selected)</button>
        <button class="btn secondary" id="delLinksBtn">üßπ Remove Links</button>
      </div>

      <hr>

      <div class="pill"><b>Draw Mode</b></div>
      <div class="row">
        <button class="btn secondary" id="drawToggle">‚úèÔ∏è Start Drawing</button>
        <button class="btn ghost" id="clearInk">üßΩ Clear Ink</button>
      </div>

      <div class="row">
        <div>
          <label>Pen Size</label>
          <input type="range" id="penSize" min="2" max="28" value="6">
        </div>
        <div>
          <label>Pen Color</label>
          <input type="color" id="penColor" value="#f59e0b">
        </div>
      </div>
      <div class="small">Tip: Turn on Draw Mode to sketch arrows/notes quickly. Turn it off to move blocks again.</div>

      <hr>

      <div id="propsEmpty" class="small">
        Click an item to edit. Move: drag ‚Ä¢ Resize: corners ‚Ä¢ Rotate: top dot ‚Ä¢ Multi-select: Shift+Click
      </div>

      <div id="props" style="display:none">
        <div class="pill" style="justify-content:space-between">
          <span><b id="selTitle">Selected</b> <span id="selCount" class="small" style="margin:0"></span></span>
          <button class="iconBtn" id="deleteSel">Delete</button>
        </div>

        <!-- Common -->
        <div class="row">
          <div>
            <label>Rotation (deg)</label>
            <input type="number" id="pRot" value="0" min="-180" max="180">
          </div>
          <div>
            <label>Opacity</label>
            <input type="number" id="pOpacity" value="1" min="0.05" max="1" step="0.05">
          </div>
        </div>

        <div id="shapeProps" style="display:none">
          <label>Shape Type</label>
          <select id="pShapeType">
            <option value="rect">Rectangle</option>
            <option value="round">Rounded / Oval</option>
            <option value="diamond">Decision (Diamond)</option>
          </select>
        </div>

        <label>Board Background</label>
        <input type="color" id="boardBg" value="#0a0a0a">

        <div class="row">
          <button class="btn secondary" id="bringFront" type="button">Bring Front</button>
          <button class="btn secondary" id="sendBack" type="button">Send Back</button>
        </div>
      </div>

      <hr>

      <div class="pill"><b>Save / Load / Export</b></div>
      <div class="row">
        <button class="btn secondary" id="saveLocal" type="button">Save (Local)</button>
        <button class="btn secondary" id="loadLocal" type="button">Load (Local)</button>
      </div>

      <label>Layout JSON</label>
      <textarea id="jsonBox" rows="7" spellcheck="false"></textarea>
      <div class="row">
        <button class="btn secondary" id="copyJSON" type="button">Copy JSON</button>
        <button class="btn secondary" id="applyJSON" type="button">Apply JSON</button>
      </div>

      <div class="row">
        <button class="btn" id="exportPNG" type="button">‚¨á Export PNG (Board)</button>
        <button class="btn ghost" id="clearAll" type="button">Clear Board</button>
      </div>

      <hr>
      <div class="pill"><b>Blocks</b></div>
      <div class="small">Run JS inside a Code Block ‚Üí output goes to nearest Output block (or auto-created).</div>
      <div class="list" id="elementsList"></div>
    </div>

    <!-- RIGHT: BOARD -->
    <div class="card boardWrap">
      <div id="board">
        <div id="safeArea"></div>

        <svg id="linksSvg" viewBox="0 0 100 100" preserveAspectRatio="none">
          <defs>
            <marker id="arrowHead" markerWidth="10" markerHeight="10" refX="9" refY="5" orient="auto" markerUnits="strokeWidth">
              <path d="M 0 0 L 10 5 L 0 10 z" fill="rgba(245,158,11,.95)"></path>
            </marker>
          </defs>
        </svg>

        <canvas id="drawCanvas"></canvas>

        <div id="vGuide" class="guide"></div>
        <div id="hGuide" class="guide"></div>
      </div>
    </div>
  </div>
</div>

<script>
/* ================== Core ================== */
const $ = (q)=>document.querySelector(q);
const board = $("#board");
const vGuide = $("#vGuide");
const hGuide = $("#hGuide");
const safeArea = $("#safeArea");
const elementsList = $("#elementsList");
const jsonBox = $("#jsonBox");
const linksSvg = $("#linksSvg");
const drawCanvas = $("#drawCanvas");
const dctx = drawCanvas.getContext("2d");

let zTop = 10;
let selected = new Set();
let activePrimary = null;

const state = {
  version: 1,
  boardBg:"#0a0a0a",
  els: {},
  links: [],   // {id, from, to}
  ink: null    // dataURL of drawing canvas
};

function uid(){ return "el_" + Math.random().toString(16).slice(2,10); }
function lid(){ return "ln_" + Math.random().toString(16).slice(2,10); }
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
function snapOn(){ return $("#snapToggle").checked; }
function snapGrid(v, size=10){ return $("#gridToggle").checked ? Math.round(v/size)*size : v; }

function safeBounds(){
  const bw = board.clientWidth, bh = board.clientHeight;
  return { left: bw*0.05, right: bw*0.95, top: bh*0.05, bottom: bh*0.95 };
}
function showV(x){ vGuide.style.display="block"; vGuide.style.left = x+"px"; }
function showH(y){ hGuide.style.display="block"; hGuide.style.top  = y+"px"; }
function hideGuides(){ vGuide.style.display="none"; hGuide.style.display="none"; }

function otherRects(exceptId){
  const out = [];
  for(const id of Object.keys(state.els)){
    if(id===exceptId) continue;
    const d = state.els[id];
    out.push({ id, l:d.x, r:d.x+d.w, t:d.y, b:d.y+d.h, cx:d.x+d.w/2, cy:d.y+d.h/2 });
  }
  return out;
}
function snapValue(val, targets, threshold=8){
  let best = {delta:0, hit:false, guide:null};
  let min = threshold+1;
  for(const t of targets){
    const diff = t - val;
    const ad = Math.abs(diff);
    if(ad < min){
      min = ad;
      best = {delta:diff, hit:true, guide:t};
    }
  }
  return best;
}

/* ===== PATCH: missing z-order helpers used by header buttons ===== */
function bringToFront(id){
  const d = state.els[id]; if(!d) return;
  d.z = ++zTop;
  renderEl(id);
  refreshList();
  syncJSONBoxDebounced();
}
function sendToBack(id){
  const d = state.els[id]; if(!d) return;
  d.z = 1;
  // bump others up a bit to keep ordering stable
  Object.values(state.els).forEach(x=>{
    if(x.id !== id) x.z = Math.max(2, (x.z||2));
  });
  zTop = Math.max(10, ...Object.values(state.els).map(x=>x.z||10));
  renderAll();
  refreshList();
  syncJSONBoxDebounced();
}
/* ================================================================ */

/* ================== Canvas sizing ================== */
function fitDrawCanvas(){
  const r = board.getBoundingClientRect();
  const dpr = window.devicePixelRatio || 1;
  drawCanvas.width = Math.round(r.width * dpr);
  drawCanvas.height = Math.round(r.height * dpr);
  drawCanvas.style.width = r.width + "px";
  drawCanvas.style.height = r.height + "px";
  dctx.setTransform(dpr,0,0,dpr,0,0); // draw in CSS pixels

  if(state.ink){
    const img = new Image();
    img.onload = ()=>{
      dctx.clearRect(0,0,r.width,r.height);
      dctx.drawImage(img,0,0,r.width,r.height);
    };
    img.src = state.ink;
  }else{
    dctx.clearRect(0,0,r.width,r.height);
  }

  linksSvg.setAttribute("viewBox", `0 0 ${r.width} ${r.height}`);
}
window.addEventListener("resize", ()=>{ fitDrawCanvas(); renderLinks(); });
fitDrawCanvas();

/* ================== Element Building ================== */
function createElementNode({id, title}){
  const el = document.createElement("div");
  el.className = "el";
  el.dataset.id = id;

  const box = document.createElement("div");
  box.className = "box";
  el.appendChild(box);

  const hdr = document.createElement("div");
  hdr.className = "hdr";
  hdr.innerHTML = `<b>${title}</b>
    <span class="mini">
      <button class="iconBtn" data-act="front">‚ñ≤</button>
      <button class="iconBtn" data-act="back">‚ñº</button>
      <button class="iconBtn" data-act="del">‚úï</button>
    </span>`;
  box.appendChild(hdr);

  const content = document.createElement("div");
  content.className = "content";
  box.appendChild(content);

  ["tl","tr","bl","br"].forEach(pos=>{
    const h = document.createElement("div");
    h.className = "handle "+pos;
    h.dataset.handle = pos;
    el.appendChild(h);
  });

  const stick = document.createElement("div");
  stick.className = "rstick";
  const rh = document.createElement("div");
  rh.className = "rhandle";
  rh.dataset.rotate = "1";
  el.appendChild(stick);
  el.appendChild(rh);

  el.addEventListener("pointerdown", (e)=>{
    if(drawMode.on) return; // don't select when drawing
    const actBtn = e.target.closest("button[data-act]");
    if(actBtn){
      e.stopPropagation();
      const act = actBtn.dataset.act;
      if(act==="del") removeEl(id);
      if(act==="front") bringToFront(id);
      if(act==="back") sendToBack(id);
      return;
    }
    if(e.shiftKey){
      if(selected.has(id)) selected.delete(id);
      else selected.add(id);
      activePrimary = id;
      updateSelectionUI();
    }else{
      selected.clear(); selected.add(id);
      activePrimary = id;
      updateSelectionUI();
    }
  });

  enableDragResizeRotate(el);
  board.appendChild(el);
  return {el, content};
}

/* ================== Add Blocks ================== */
function addNote(){
  const id = uid();
  state.els[id] = {
    id, type:"note", title:"Note",
    x: 60, y: 60, w: 420, h: 240,
    rot: 0, opacity: 1,
    text: "Idea:\n‚Ä¢ Break problem into functions\n‚Ä¢ Add test cases\n‚Ä¢ Edge cases?",
    z: ++zTop
  };
  const {content} = createElementNode({id, title:"Note"});
  const wrap = document.createElement("div");
  wrap.className = "note";
  const ta = document.createElement("textarea");
  ta.value = state.els[id].text;
  ta.addEventListener("input", ()=>{
    state.els[id].text = ta.value;
    refreshList(false); syncJSONBoxDebounced();
  });
  wrap.appendChild(ta);
  content.appendChild(wrap);
  renderEl(id);
  selected.clear(); selected.add(id); activePrimary = id;
  updateSelectionUI(); refreshList(); syncJSONBox();
}

function addOutput(){
  const id = uid();
  state.els[id] = {
    id, type:"output", title:"Output",
    x: 560, y: 420, w: 520, h: 260,
    rot: 0, opacity: 1,
    text: "Output will appear here...",
    z: ++zTop
  };
  const {content} = createElementNode({id, title:"Output"});
  const wrap = document.createElement("div");
  wrap.className = "outputWrap";
  const pre = document.createElement("pre");
  pre.textContent = state.els[id].text;
  wrap.appendChild(pre);
  content.appendChild(wrap);
  renderEl(id);
  selected.clear(); selected.add(id); activePrimary = id;
  updateSelectionUI(); refreshList(); syncJSONBox();
  return id; // PATCH: return new output id for callers
}

function addCode(){
  const id = uid();
  state.els[id] = {
    id, type:"code", title:"Code (JS)",
    x: 520, y: 70, w: 560, h: 330,
    rot: 0, opacity: 1,
    lang: "js",
    code:
`// Example: sum 1..n
function sum(n){
  let s = 0;
  for(let i=1;i<=n;i++) s += i;
  return s;
}

print("sum(10) =", sum(10));`,
    z: ++zTop
  };
  const {content} = createElementNode({id, title:"Code (JS)"});

  const wrap = document.createElement("div");
  wrap.className = "codeWrap";

  const top = document.createElement("div");
  top.className = "codeTop";
  top.innerHTML = `<span class="chip">JavaScript</span>`;

  const runBtn = document.createElement("button");
  runBtn.type = "button";
  runBtn.textContent = "‚ñ∂ Run";
  runBtn.addEventListener("click", ()=>runCodeBlock(id));
  top.appendChild(runBtn);

  const clrBtn = document.createElement("button");
  clrBtn.type = "button";
  clrBtn.textContent = "üßπ Clear Out";
  clrBtn.addEventListener("click", ()=>{
    const out = getNearestOutputFor(id, true);
    if(!out) return;
    out.text = "";
    renderEl(out.id);
    syncJSONBoxDebounced();
  });
  top.appendChild(clrBtn);

  const area = document.createElement("div");
  area.className = "codeArea";
  const ta = document.createElement("textarea");
  ta.value = state.els[id].code;
  ta.addEventListener("input", ()=>{
    state.els[id].code = ta.value;
    syncJSONBoxDebounced();
  });
  area.appendChild(ta);

  wrap.appendChild(top);
  wrap.appendChild(area);
  content.appendChild(wrap);

  renderEl(id);
  selected.clear(); selected.add(id); activePrimary = id;
  updateSelectionUI(); refreshList(); syncJSONBox();
}

function addShape(){
  const id = uid();
  state.els[id] = {
    id, type:"shape", title:"Flow Shape",
    x: 120, y: 340, w: 330, h: 180,
    rot: 0, opacity: 1,
    shape: "diamond",
    text: "Is input valid?",
    z: ++zTop
  };
  const {content} = createElementNode({id, title:"Flow Shape"});
  const s = document.createElement("div");
  s.className = "shape diamond";
  const input = document.createElement("input");
  input.className = "label";
  input.value = state.els[id].text;
  input.addEventListener("input", ()=>{
    state.els[id].text = input.value;
    syncJSONBoxDebounced(); refreshList(false);
  });
  s.appendChild(input);
  content.appendChild(s);

  renderEl(id);
  selected.clear(); selected.add(id); activePrimary = id;
  updateSelectionUI(); refreshList(); syncJSONBox();
}

/* ================== Run code (JS) ================== */
function getNearestOutputFor(codeId, createIfMissing=false){
  const code = state.els[codeId];
  const outs = Object.values(state.els).filter(x=>x.type==="output");

  // PATCH: robust create + return newly created output
  if(outs.length===0){
    if(!createIfMissing) return null;
    const newId = addOutput();
    return state.els[newId] || null;
  }

  // nearest by center distance
  const cx = code.x + code.w/2, cy = code.y + code.h/2;
  let best = outs[0], bestD = Infinity;
  for(const o of outs){
    const ox = o.x + o.w/2, oy = o.y + o.h/2;
    const d = (ox-cx)*(ox-cx) + (oy-cy)*(oy-cy);
    if(d < bestD){ bestD = d; best = o; }
  }
  return best;
}

function runCodeBlock(id){
  const d = state.els[id];
  if(!d || d.type!=="code") return;

  const out = getNearestOutputFor(id, true);
  if(!out) return;

  const lines = [];
  const print = (...args)=>lines.push(args.map(x=>String(x)).join(" "));

  try{
    const fn = new Function("print", `"use strict";\n${d.code}\n`);
    fn(print);
    out.text = lines.join("\n") || "(no output)";
  }catch(err){
    out.text = "‚úó Error:\n" + (err && err.stack ? err.stack : String(err));
  }
  renderEl(out.id);
  syncJSONBoxDebounced();
}

/* ================== Links (Connectors) ================== */
function centerOf(id){
  const d = state.els[id];
  if(!d) return {x:0,y:0};
  return { x: d.x + d.w/2, y: d.y + d.h/2 };
}

function addLink(from, to){
  if(!state.els[from] || !state.els[to] || from===to) return;
  if(state.links.some(l => (l.from===from && l.to===to))) return;
  state.links.push({ id: lid(), from, to });
  renderLinks();
  syncJSONBoxDebounced();
}

function removeLinksOfSelected(){
  if(selected.size===0) return;
  const set = new Set([...selected]);
  state.links = state.links.filter(l => !(set.has(l.from) || set.has(l.to)));
  renderLinks();
  syncJSONBoxDebounced();
}

function renderLinks(){
  const bw = board.clientWidth, bh = board.clientHeight;
  linksSvg.setAttribute("viewBox", `0 0 ${bw} ${bh}`);
  linksSvg.querySelectorAll("path.link,path.linkShadow").forEach(p=>p.remove());

  for(const l of state.links){
    if(!state.els[l.from] || !state.els[l.to]) continue;
    const a = centerOf(l.from);
    const b = centerOf(l.to);

    const dx = b.x - a.x;
    const c1x = a.x + dx*0.35;
    const c2x = a.x + dx*0.65;
    const c1y = a.y;
    const c2y = b.y;
    const d = `M ${a.x} ${a.y} C ${c1x} ${c1y}, ${c2x} ${c2y}, ${b.x} ${b.y}`;

    const sh = document.createElementNS("http://www.w3.org/2000/svg","path");
    sh.setAttribute("d", d);
    sh.setAttribute("class","linkShadow");
    linksSvg.appendChild(sh);

    const p = document.createElementNS("http://www.w3.org/2000/svg","path");
    p.setAttribute("d", d);
    p.setAttribute("class","link");
    p.setAttribute("marker-end","url(#arrowHead)");
    linksSvg.appendChild(p);
  }
}

/* ================== Rendering ================== */
function renderEl(id){
  const d = state.els[id];
  const node = board.querySelector(`.el[data-id="${id}"]`);
  if(!d || !node) return;

  node.style.left = d.x + "px";
  node.style.top  = d.y + "px";
  node.style.width  = d.w + "px";
  node.style.height = d.h + "px";
  node.style.zIndex = String(d.z ?? 5);
  node.style.opacity = String(d.opacity ?? 1);
  node.style.transformOrigin = "center center";
  node.style.transform = `rotate(${d.rot || 0}deg)`;
  node.classList.toggle("selected", selected.has(id));

  if(d.type==="note"){
    const ta = node.querySelector(".note textarea");
    if(ta && ta.value !== (d.text||"")) ta.value = d.text || "";
  }

  if(d.type==="output"){
    const pre = node.querySelector(".outputWrap pre");
    if(pre) pre.textContent = d.text || "";
  }

  if(d.type==="code"){
    const ta = node.querySelector(".codeArea textarea");
    if(ta && ta.value !== (d.code||"")) ta.value = d.code || "";
  }

  if(d.type==="shape"){
    const s = node.querySelector(".shape");
    if(!s) return;
    s.classList.remove("rect","round","diamond");
    s.classList.add(d.shape || "rect");

    if((d.shape||"rect")==="diamond"){
      s.style.transform = "rotate(45deg)";
      const label = s.querySelector(".label");
      if(label) label.style.transform = "rotate(-45deg)";
    }else{
      s.style.transform = "";
      const label = s.querySelector(".label");
      if(label) label.style.transform = "";
    }
    const label = s.querySelector(".label");
    if(label && label.value !== (d.text||"")) label.value = d.text || "";
  }
}

function renderAll(){
  Object.keys(state.els).forEach(renderEl);
  board.style.background = state.boardBg || "#0a0a0a";
  renderLinks();
}

/* ================== Drag/Resize/Rotate (with snapping) ================== */
function enableDragResizeRotate(node){
  let mode=null;
  let start=null;

  node.addEventListener("pointerdown", (e)=>{
    if(drawMode.on) return;
    const id = node.dataset.id;
    const d = state.els[id];
    if(!d) return;
    if(e.target.closest(".hdr button[data-act]")) return;

    const rotHandle = e.target.closest(".rhandle");
    const handle = e.target.closest(".handle");

    if(rotHandle){
      mode="rot";
      const nr = node.getBoundingClientRect();
      const cx = (nr.left + nr.right)/2;
      const cy = (nr.top + nr.bottom)/2;
      start = { id, cx, cy, startRot: d.rot || 0 };
      node.setPointerCapture(e.pointerId);
      e.preventDefault();
      return;
    }
    if(handle){
      mode = handle.dataset.handle;
      start = { id, px:e.clientX, py:e.clientY, ox:d.x, oy:d.y, ow:d.w, oh:d.h };
      node.setPointerCapture(e.pointerId);
      e.preventDefault();
      return;
    }
    mode="drag";
    start = { id, px:e.clientX, py:e.clientY, ox:d.x, oy:d.y };
    node.setPointerCapture(e.pointerId);
    e.preventDefault();
  });

  node.addEventListener("pointermove", (e)=>{
    if(!mode || !start) return;
    const id = start.id;
    const d = state.els[id];
    if(!d) return;

    const bw = board.clientWidth, bh = board.clientHeight;
    const sb = safeBounds();
    const others = otherRects(id);
    const threshold = 8;

    if(mode==="rot"){
      const ang = Math.atan2(e.clientY - start.cy, e.clientX - start.cx);
      const deg = ang * (180/Math.PI) + 90;
      d.rot = Math.round(deg);
      $("#pRot").value = d.rot;
      renderEl(id);
      renderLinks();
      syncJSONBoxDebounced();
      return;
    }

    const dx = e.clientX - start.px;
    const dy = e.clientY - start.py;

    if(mode==="drag"){
      let nx = snapGrid(start.ox + dx);
      let ny = snapGrid(start.oy + dy);

      nx = clamp(nx, 0, bw - d.w);
      ny = clamp(ny, 0, bh - d.h);

      if(snapOn()){
        const l = nx, r = nx + d.w, t = ny, b = ny + d.h, cx = nx + d.w/2, cy = ny + d.h/2;
        const xTargets = [0, bw/2, bw, sb.left, sb.right];
        const yTargets = [0, bh/2, bh, sb.top, sb.bottom];
        for(const o of others){ xTargets.push(o.l,o.r,o.cx); yTargets.push(o.t,o.b,o.cy); }

        let bestX = {delta:0, hit:false, guide:null};
        for(const v of [l,r,cx]){
          const s = snapValue(v, xTargets, threshold);
          if(s.hit && (!bestX.hit || Math.abs(s.delta) < Math.abs(bestX.delta))) bestX = s;
        }
        let bestY = {delta:0, hit:false, guide:null};
        for(const v of [t,b,cy]){
          const s = snapValue(v, yTargets, threshold);
          if(s.hit && (!bestY.hit || Math.abs(s.delta) < Math.abs(bestY.delta))) bestY = s;
        }

        if(bestX.hit){ nx += bestX.delta; showV(bestX.guide); } else vGuide.style.display="none";
        if(bestY.hit){ ny += bestY.delta; showH(bestY.guide); } else hGuide.style.display="none";

        // PATCH: clamp again after snapping
        nx = clamp(nx, 0, bw - d.w);
        ny = clamp(ny, 0, bh - d.h);
      }else hideGuides();

      d.x = nx; d.y = ny;
      renderEl(id);
      renderLinks();
      refreshList(false);
      syncJSONBoxDebounced();
      return;
    }

    // resize
    const minW=140, minH=90;
    let x=d.x, y=d.y, w=d.w, h=d.h;

    if(mode.includes("r")) w = Math.max(minW, snapGrid(start.ow + dx));
    if(mode.includes("l")){
      const nw = Math.max(minW, snapGrid(start.ow - dx));
      const nx = snapGrid(start.ox + dx);
      w = nw; x = nx;
    }
    if(mode.includes("b")) h = Math.max(minH, snapGrid(start.oh + dy));
    if(mode.includes("t")){
      const nh = Math.max(minH, snapGrid(start.oh - dy));
      const ny = snapGrid(start.oy + dy);
      h = nh; y = ny;
    }

    x = clamp(x, 0, bw - w);
    y = clamp(y, 0, bh - h);

    if(snapOn()){
      const r=x+w, b=y+h;
      const xTargets = [0, bw/2, bw, sb.left, sb.right];
      const yTargets = [0, bh/2, bh, sb.top, sb.bottom];
      for(const o of others){ xTargets.push(o.l,o.r,o.cx); yTargets.push(o.t,o.b,o.cy); }

      const sxR = snapValue(r, xTargets, threshold);
      const syB = snapValue(b, yTargets, threshold);

      if(sxR.hit){ w = clamp(w + sxR.delta, minW, bw - x); showV(sxR.guide); } else vGuide.style.display="none";
      if(syB.hit){ h = clamp(h + syB.delta, minH, bh - y); showH(syB.guide); } else hGuide.style.display="none";

      // PATCH: clamp again after snapping
      w = clamp(w, minW, bw - x);
      h = clamp(h, minH, bh - y);
      x = clamp(x, 0, bw - w);
      y = clamp(y, 0, bh - h);
    }else hideGuides();

    d.x=x; d.y=y; d.w=w; d.h=h;
    renderEl(id);
    renderLinks();
    refreshList(false);
    syncJSONBoxDebounced();
  });

  node.addEventListener("pointerup", ()=>{
    mode=null; start=null;
    hideGuides();
  });
}

/* ================== Selection UI ================== */
function updateSelectionUI(){
  renderAll(); refreshList();
  const ids = [...selected];
  $("#selCount").textContent = ids.length ? `(${ids.length})` : "";

  if(ids.length===0){
    $("#propsEmpty").style.display="block";
    $("#props").style.display="none";
    return;
  }
  $("#propsEmpty").style.display="none";
  $("#props").style.display="block";

  const primaryId = activePrimary || ids[ids.length-1];
  const d = state.els[primaryId];

  const nameMap = { code:"Code Block", note:"Note", output:"Output", shape:"Shape" };
  $("#selTitle").textContent = ids.length>1 ? "Multiple Selected" : (nameMap[d.type] || "Selected");

  $("#pRot").value = Math.round(d.rot || 0);
  $("#pOpacity").value = (d.opacity ?? 1);

  $("#shapeProps").style.display = (ids.length===1 && d.type==="shape") ? "block" : "none";
  if(ids.length===1 && d.type==="shape"){
    $("#pShapeType").value = d.shape || "rect";
  }

  $("#boardBg").value = state.boardBg || "#0a0a0a";
}

board.addEventListener("pointerdown", (e)=>{
  if(e.target === board){
    selected.clear(); activePrimary=null;
    updateSelectionUI();
  }
});

function withSingle(fn){
  const ids=[...selected];
  if(ids.length!==1) return;
  fn(ids[0], state.els[ids[0]]);
}

/* Common props apply to all selected */
$("#pRot").addEventListener("input", ()=>{
  const val = Math.max(-180, Math.min(180, +$("#pRot").value||0));
  for(const id of selected){ state.els[id].rot = val; renderEl(id); }
  renderLinks();
  syncJSONBoxDebounced();
});
$("#pOpacity").addEventListener("input", ()=>{
  const val = Math.max(0.05, Math.min(1, +$("#pOpacity").value||1));
  for(const id of selected){ state.els[id].opacity = val; renderEl(id); }
  syncJSONBoxDebounced();
});
$("#pShapeType").addEventListener("change", ()=>withSingle((id,d)=>{
  if(d.type!=="shape") return;
  d.shape = $("#pShapeType").value;
  renderEl(id);
  syncJSONBoxDebounced();
}));

/* Board bg */
$("#boardBg").addEventListener("input", ()=>{
  state.boardBg = $("#boardBg").value;
  board.style.background = state.boardBg;
  syncJSONBoxDebounced();
});

/* Delete */
$("#deleteSel").addEventListener("click", ()=>{
  for(const id of [...selected]) removeEl(id);
  selected.clear(); activePrimary=null;
  updateSelectionUI();
});

/* Z order (panel buttons) */
$("#bringFront").addEventListener("click", ()=>{
  for(const id of selected){ bringToFront(id); }
});
$("#sendBack").addEventListener("click", ()=>{
  for(const id of selected){ sendToBack(id); }
});

/* List */
function refreshList(){
  const ids = Object.keys(state.els).sort((a,b)=>(state.els[a].z||0)-(state.els[b].z||0));
  elementsList.innerHTML="";
  for(const id of ids){
    const d = state.els[id];
    const div = document.createElement("div");
    div.className="pill";
    div.style.borderColor = selected.has(id) ? "#f59e0b" : "";
    div.style.borderRadius="14px";
    div.style.justifyContent="space-between";
    div.innerHTML = `
      <div>
        <b>${d.type==="code"?"Code":d.type==="note"?"Note":d.type==="output"?"Output":"Shape"}</b>
        <span class="small" style="margin:0;display:block">${Math.round(d.x)},${Math.round(d.y)} ‚Ä¢ ${Math.round(d.w)}√ó${Math.round(d.h)}</span>
      </div>
      <div style="display:flex;gap:6px">
        <button class="iconBtn" data-a="sel">Select</button>
        <button class="iconBtn" data-a="del">Del</button>
      </div>
    `;
    div.querySelector('[data-a="sel"]').addEventListener("click",(e)=>{
      e.stopPropagation();
      selected.clear(); selected.add(id); activePrimary=id; updateSelectionUI();
    });
    div.querySelector('[data-a="del"]').addEventListener("click",(e)=>{
      e.stopPropagation();
      removeEl(id);
      if(selected.has(id)) selected.delete(id);
      updateSelectionUI();
    });
    elementsList.appendChild(div);
  }
}

/* Remove */
function removeEl(id){
  if(!state.els[id]) return;
  state.links = state.links.filter(l => !(l.from===id || l.to===id));
  const node = board.querySelector(`.el[data-id="${id}"]`);
  if(node) node.remove();
  delete state.els[id];
  renderLinks();
  syncJSONBoxDebounced();
}

/* ================== JSON Save/Load ================== */
function runtimeStrippedCopy(){
  const copy = JSON.parse(JSON.stringify(state));
  copy.ink = drawCanvas.toDataURL("image/png");
  return copy;
}
function syncJSONBox(){ jsonBox.value = JSON.stringify(runtimeStrippedCopy(), null, 2); }
let jsonTimer=null;
function syncJSONBoxDebounced(){ clearTimeout(jsonTimer); jsonTimer=setTimeout(syncJSONBox, 140); }

$("#copyJSON").addEventListener("click", async ()=>{
  syncJSONBox();
  jsonBox.select();
  try{ await navigator.clipboard.writeText(jsonBox.value); }catch{}
});
$("#applyJSON").addEventListener("click", ()=>{
  try{ loadFromObject(JSON.parse(jsonBox.value||"{}")); }
  catch{ alert("Invalid JSON."); }
});
$("#saveLocal").addEventListener("click", ()=>{
  localStorage.setItem("prog_whiteboard_v1", JSON.stringify(runtimeStrippedCopy()));
  alert("Saved to Local Storage.");
});
$("#loadLocal").addEventListener("click", ()=>{
  const raw = localStorage.getItem("prog_whiteboard_v1");
  if(!raw) return alert("No saved board found.");
  try{ loadFromObject(JSON.parse(raw)); }catch{ alert("Saved data is corrupted."); }
});
$("#clearAll").addEventListener("click", ()=>{
  state.els = {};
  state.links = [];
  selected.clear(); activePrimary=null;
  board.querySelectorAll(".el").forEach(n=>n.remove());
  state.ink = null;
  dctx.clearRect(0,0,board.clientWidth,board.clientHeight);
  renderLinks();
  updateSelectionUI(); refreshList(); syncJSONBox();
});

function loadFromObject(obj){
  $("#clearAll").click();
  state.version = obj.version || 1;
  state.boardBg = obj.boardBg || "#0a0a0a";
  board.style.background = state.boardBg;
  $("#boardBg").value = state.boardBg;

  for(const id of Object.keys(obj.els||{})){
    const d = obj.els[id];
    d.z = d.z || (++zTop);
    d.rot = d.rot || 0;
    d.opacity = (d.opacity==null?1:d.opacity);
    state.els[id] = d;

    const {content} = createElementNode({id, title: d.title || (d.type==="code"?"Code (JS)":d.type==="note"?"Note":d.type==="output"?"Output":"Flow Shape")});
    if(d.type==="note"){
      const wrap = document.createElement("div");
      wrap.className="note";
      const ta = document.createElement("textarea");
      ta.value = d.text || "";
      ta.addEventListener("input", ()=>{ state.els[id].text = ta.value; refreshList(false); syncJSONBoxDebounced(); });
      wrap.appendChild(ta);
      content.appendChild(wrap);
    }else if(d.type==="output"){
      const wrap = document.createElement("div");
      wrap.className="outputWrap";
      const pre = document.createElement("pre");
      pre.textContent = d.text || "";
      wrap.appendChild(pre);
      content.appendChild(wrap);
    }else if(d.type==="code"){
      const wrap = document.createElement("div");
      wrap.className="codeWrap";

      const top = document.createElement("div");
      top.className="codeTop";
      top.innerHTML = `<span class="chip">JavaScript</span>`;

      const runBtn = document.createElement("button");
      runBtn.type="button"; runBtn.textContent="‚ñ∂ Run";
      runBtn.addEventListener("click", ()=>runCodeBlock(id));
      top.appendChild(runBtn);

      const clrBtn = document.createElement("button");
      clrBtn.type="button"; clrBtn.textContent="üßπ Clear Out";
      clrBtn.addEventListener("click", ()=>{
        const out = getNearestOutputFor(id, true);
        if(!out) return;
        out.text = "";
        renderEl(out.id);
        syncJSONBoxDebounced();
      });
      top.appendChild(clrBtn);

      const area = document.createElement("div");
      area.className="codeArea";
      const ta = document.createElement("textarea");
      ta.value = d.code || "";
      ta.addEventListener("input", ()=>{ state.els[id].code = ta.value; syncJSONBoxDebounced(); });
      area.appendChild(ta);

      wrap.appendChild(top); wrap.appendChild(area);
      content.appendChild(wrap);
    }else if(d.type==="shape"){
      const s = document.createElement("div");
      s.className = "shape rect";
      const input = document.createElement("input");
      input.className="label";
      input.value = d.text || "";
      input.addEventListener("input", ()=>{ state.els[id].text = input.value; syncJSONBoxDebounced(); });
      s.appendChild(input);
      content.appendChild(s);
    }
    renderEl(id);
  }

  state.links = Array.isArray(obj.links) ? obj.links.filter(x=>x && x.from && x.to) : [];
  renderLinks();

  state.ink = obj.ink || null;
  fitDrawCanvas();

  zTop = Math.max(10, ...Object.values(state.els).map(x=>x.z||10));
  selected.clear(); activePrimary=null;
  updateSelectionUI(); refreshList(); syncJSONBox();
}

/* ================== Buttons ================== */
$("#gridToggle").addEventListener("change", ()=> board.classList.toggle("gridOn", $("#gridToggle").checked));
$("#safeToggle").addEventListener("change", ()=> safeArea.style.display = $("#safeToggle").checked ? "block" : "none");

$("#addCodeBtn").addEventListener("click", addCode);
$("#addNoteBtn").addEventListener("click", addNote);
$("#addOutBtn").addEventListener("click", addOutput);
$("#addShapeBtn").addEventListener("click", addShape);

$("#connectBtn").addEventListener("click", ()=>{
  const ids = [...selected];
  if(ids.length !== 2) return alert("Select exactly 2 blocks (Shift+Click) to connect.");
  addLink(ids[0], ids[1]);
});
$("#delLinksBtn").addEventListener("click", ()=>{
  if(selected.size===0){
    state.links = [];
    renderLinks();
    syncJSONBoxDebounced();
    return;
  }
  removeLinksOfSelected();
});

/* ================== Draw Mode ================== */
const drawMode = { on:false, drawing:false, last:null };

function setDrawMode(on){
  drawMode.on = !!on;
  drawMode.drawing = false;
  drawMode.last = null;
  drawCanvas.style.pointerEvents = on ? "auto" : "none";

  // PATCH: keep button classes consistent
  const btn = $("#drawToggle");
  btn.textContent = on ? "üß≤ Stop Drawing" : "‚úèÔ∏è Start Drawing";
  btn.className = on ? "btn" : "btn secondary";
}
$("#drawToggle").addEventListener("click", ()=> setDrawMode(!drawMode.on));

function inkSettings(){
  return { w: +$("#penSize").value||6, color: $("#penColor").value || "#f59e0b" };
}
function boardPointFromEvent(e){
  const r = board.getBoundingClientRect();
  return { x: e.clientX - r.left, y: e.clientY - r.top };
}

drawCanvas.addEventListener("pointerdown", (e)=>{
  if(!drawMode.on) return;
  drawMode.drawing = true;
  drawCanvas.setPointerCapture(e.pointerId);
  const p = boardPointFromEvent(e);
  drawMode.last = p;
  e.preventDefault();
});
drawCanvas.addEventListener("pointermove", (e)=>{
  if(!drawMode.on || !drawMode.drawing) return;
  const p = boardPointFromEvent(e);
  const {w,color} = inkSettings();
  dctx.lineCap = "round";
  dctx.lineJoin = "round";
  dctx.strokeStyle = color;
  dctx.lineWidth = w;

  dctx.beginPath();
  dctx.moveTo(drawMode.last.x, drawMode.last.y);
  dctx.lineTo(p.x, p.y);
  dctx.stroke();

  drawMode.last = p;
});
drawCanvas.addEventListener("pointerup", ()=>{
  if(!drawMode.on) return;
  drawMode.drawing = false;
  drawMode.last = null;
  state.ink = drawCanvas.toDataURL("image/png");
  syncJSONBoxDebounced();
});

$("#clearInk").addEventListener("click", ()=>{
  dctx.clearRect(0,0,board.clientWidth,board.clientHeight);
  state.ink = null;
  syncJSONBoxDebounced();
});

/* ================== Export PNG ================== */
function exportPNG(){
  const bw = board.clientWidth, bh = board.clientHeight;

  const clone = board.cloneNode(true);
  clone.querySelectorAll(".handle,.rhandle,.rstick,.hdr .mini,.guide").forEach(n=>n.remove());
  clone.querySelectorAll(".el").forEach(n=>n.classList.remove("selected"));

  const cnv = clone.querySelector("#drawCanvas");
  if(cnv){
    const img = document.createElement("img");
    img.src = drawCanvas.toDataURL("image/png");
    img.style.position="absolute";
    img.style.inset="0";
    img.style.width="100%";
    img.style.height="100%";
    img.style.pointerEvents="none";
    cnv.replaceWith(img);
  }

  const wrapper = document.createElement("div");
  wrapper.setAttribute("xmlns","http://www.w3.org/1999/xhtml");
  wrapper.style.width = bw+"px";
  wrapper.style.height = bh+"px";

  // PATCH: include styles so foreignObject renders correctly
  const style = document.createElement("style");
  style.textContent = Array.from(document.querySelectorAll("style")).map(s=>s.textContent||"").join("\n");
  wrapper.appendChild(style);

  wrapper.appendChild(clone);

  const svg = `
<svg xmlns="http://www.w3.org/2000/svg" width="${bw}" height="${bh}">
  <foreignObject width="100%" height="100%">
    ${new XMLSerializer().serializeToString(wrapper)}
  </foreignObject>
</svg>`;

  const blob = new Blob([svg], {type:"image/svg+xml;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const img = new Image();
  img.onload = ()=>{
    const out = document.createElement("canvas");
    out.width = bw; out.height = bh;
    const ctx = out.getContext("2d");
    ctx.drawImage(img, 0, 0);
    URL.revokeObjectURL(url);

    const a = document.createElement("a");
    a.href = out.toDataURL("image/png");
    a.download = "programming-whiteboard.png";
    a.click();
  };
  img.onerror = ()=>{
    URL.revokeObjectURL(url);
    alert("PNG export failed in this browser. Use a screenshot, or try Chrome/Edge.");
  };
  img.src = url;
}
$("#exportPNG").addEventListener("click", exportPNG);

/* ================== Init ================== */
function init(){
  state.boardBg = "#0a0a0a";
  board.style.background = state.boardBg;
  $("#boardBg").value = state.boardBg;
  $("#gridToggle").checked = true;
  $("#safeToggle").checked = false;
  $("#snapToggle").checked = true;

  addShape();
  addNote();
  addCode();
  addOutput();

  const ids = Object.keys(state.els);
  const shapeId = ids.find(x=>state.els[x].type==="shape");
  const codeId  = ids.find(x=>state.els[x].type==="code");
  const outId   = ids.find(x=>state.els[x].type==="output");
  if(shapeId && codeId) addLink(shapeId, codeId);
  if(codeId && outId) addLink(codeId, outId);

  syncJSONBox();
  updateSelectionUI();
  refreshList();
  renderLinks();
}
init();

/* board click: deselect */
board.addEventListener("pointerdown", (e)=>{
  if(drawMode.on) return;
  if(e.target === board){
    selected.clear(); activePrimary=null;
    updateSelectionUI();
  }
});

/* keyboard delete */
window.addEventListener("keydown", (e)=>{
  if(drawMode.on) return;
  if(e.key==="Delete" || e.key==="Backspace"){
    if(selected.size){
      for(const id of [...selected]) removeEl(id);
      selected.clear(); activePrimary=null;
      updateSelectionUI(); refreshList(); syncJSONBoxDebounced();
    }
  }
});
</script>
</body>
</html>
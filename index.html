<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Champ Image Lab ‚Äî B/W ‚Ä¢ Colorize ‚Ä¢ BG/FG Remove ‚Ä¢ Filters</title>
<meta name="description" content="Offline, single-file image tool: grayscale, colorize, background removal, foreground removal, cropping, resize, and quick filters. Runs fully in your browser."/>
<style>
  :root{
    --bg:#fff7e6; --card:#ffffff; --ink:#1f2937; --muted:#6b7280;
    --brand:#d97706; --brand2:#f59e0b; --border:#eadcc5; --shadow:0 18px 40px rgba(31,41,55,.14);
    --ok:#059669; --bad:#dc2626; --r:18px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    background: radial-gradient(1200px 800px at 10% 0%, rgba(245,158,11,.22), transparent 55%),
                radial-gradient(1000px 700px at 100% 10%, rgba(217,119,6,.14), transparent 55%),
                var(--bg);
    color:var(--ink);
  }
  header{
    position:sticky; top:0; z-index:10;
    backdrop-filter: blur(10px);
    background: linear-gradient(to bottom, rgba(255,247,230,.92), rgba(255,247,230,.68));
    border-bottom:1px solid var(--border);
  }
  .wrap{max-width:1200px; margin:0 auto; padding:14px;}
  .top{display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;}
  .brand{display:flex; gap:10px; align-items:center;}
  .logo{
    width:42px; height:42px; border-radius:14px;
    background: radial-gradient(circle at 30% 30%, var(--brand2), var(--brand));
    box-shadow: var(--shadow);
    display:grid; place-items:center;
    color:#fff; font-weight:900;
  }
  h1{font-size:16px; margin:0}
  .sub{font-size:12px; color:var(--muted); margin-top:2px}
  button,.btn,input[type="color"]{
    border:1px solid var(--border);
    background:#fff;
    border-radius:14px;
    padding:10px 12px;
    cursor:pointer;
    box-shadow: 0 10px 20px rgba(31,41,55,.08);
    transition: transform .05s ease, box-shadow .2s ease, border-color .2s ease;
    color:var(--ink);
    font-weight:700;
  }
  button:hover,.btn:hover{transform: translateY(-1px); box-shadow: 0 16px 26px rgba(31,41,55,.12); border-color:#e9cfa8}
  button:active,.btn:active{transform: translateY(0px); box-shadow: 0 10px 18px rgba(31,41,55,.10)}
  .primary{
    background: linear-gradient(180deg, rgba(245,158,11,.26), rgba(217,119,6,.14));
    border-color:#edc790;
  }
  .danger{background: linear-gradient(180deg, rgba(220,38,38,.12), rgba(220,38,38,.06)); border-color: rgba(220,38,38,.25)}
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .grid{display:grid; grid-template-columns: 430px 1fr; gap:14px; padding:14px;}
  @media (max-width: 980px){ .grid{grid-template-columns:1fr;} }
  .card{
    background: rgba(255,255,255,.9);
    border:1px solid var(--border);
    border-radius: var(--r);
    box-shadow: var(--shadow);
  }
  .card .hd{padding:12px 12px 0 12px; display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;}
  .card .bd{padding:12px}
  .card h2{margin:0; font-size:14px;}
  .note{
    background: linear-gradient(180deg, rgba(245,158,11,.15), rgba(245,158,11,.06));
    border:1px dashed rgba(217,119,6,.35);
    border-radius: 14px;
    padding:10px 12px;
    color:#7a4a00;
    font-size:12px;
    line-height:1.35;
  }
  .tools{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
  @media (max-width:520px){ .tools{grid-template-columns:1fr;} }
  label{font-size:12px; color:var(--muted); font-weight:700}
  .field{
    display:flex; flex-direction:column; gap:6px;
    background: rgba(255,255,255,.65);
    border:1px solid var(--border);
    border-radius: 16px;
    padding:10px;
  }
  .field input[type="range"]{width:100%}
  .field .inline{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .pill{
    font-size:12px; padding:6px 10px; border-radius:999px;
    border:1px solid var(--border); background:#fff; color:var(--muted); font-weight:800;
  }
  .pill.ok{color:var(--ok); border-color: rgba(5,150,105,.25); background: rgba(5,150,105,.06)}
  .pill.bad{color:var(--bad); border-color: rgba(220,38,38,.25); background: rgba(220,38,38,.06)}
  canvas{
    width:100%; height:auto;
    background:
      linear-gradient(45deg, rgba(31,41,55,.06) 25%, transparent 25%),
      linear-gradient(-45deg, rgba(31,41,55,.06) 25%, transparent 25%),
      linear-gradient(45deg, transparent 75%, rgba(31,41,55,.06) 75%),
      linear-gradient(-45deg, transparent 75%, rgba(31,41,55,.06) 75%);
    background-size: 20px 20px;
    background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
    border-radius: 16px;
    border: 1px solid var(--border);
  }
  .two{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
  @media (max-width:720px){ .two{grid-template-columns:1fr;} }
  .small{font-size:12px; color:var(--muted); line-height:1.35}
  .kbd{
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size:11px; padding:2px 6px; border-radius:8px;
    background: rgba(11,18,32,.08); border:1px solid rgba(11,18,32,.14);
    color: rgba(11,18,32,.85); font-weight:900;
  }
  .footer{padding:14px; text-align:center; color:var(--muted); font-size:12px;}
  .hidden{display:none !important}
</style>
</head>
<body>
<header>
  <div class="wrap top">
    <div class="brand">
      <div class="logo">C</div>
      <div>
        <h1>Champ Image Lab</h1>
        <div class="sub">Offline ‚Ä¢ No server ‚Ä¢ Light Saffron Theme</div>
      </div>
    </div>
    <div class="row">
      <label class="btn primary" for="file">üì∑ Open Image</label>
      <input id="file" type="file" accept="image/*" class="hidden" />
      <button id="pasteBtn" class="btn">üìã Paste</button>
      <button id="resetBtn" class="btn">‚Ü© Reset</button>
      <button id="undoBtn" class="btn">‚ü≤ Undo</button>
      <button id="redoBtn" class="btn">‚ü≥ Redo</button>
      <button id="downloadPngBtn" class="btn primary">‚¨á Download PNG</button>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid">
    <section class="card">
      <div class="hd">
        <h2>Preview</h2>
        <div class="row">
          <span id="status" class="pill bad">No image</span>
          <span class="pill">Tip: Click edited image for ‚ÄúMagic Remove‚Äù</span>
        </div>
      </div>
      <div class="bd">
        <div class="two">
          <div>
            <div class="small"><b>Original</b></div>
            <canvas id="c0"></canvas>
          </div>
          <div>
            <div class="small"><b>Edited</b> (PNG transparency supported)</div>
            <canvas id="c1" title="Click to remove a region (magic remove)."></canvas>
          </div>
        </div>
        <div style="height:10px"></div>
        <div class="note">
          <b>About ‚ÄúB/W ‚Üí Color‚Äù:</b> Real restoration needs AI models. This tool provides a <b>smart offline colorize</b>
          (tint + contrast) that‚Äôs great for posters/thumbnails.
        </div>
      </div>
    </section>

    <section class="card">
      <div class="hd">
        <h2>Tools</h2>
        <div class="row">
          <span class="small">Shortcuts: <span class="kbd">Ctrl</span>+<span class="kbd">Z</span> Undo ‚Ä¢ <span class="kbd">Ctrl</span>+<span class="kbd">Y</span> Redo</span>
        </div>
      </div>
      <div class="bd">
        <div class="tools">
          <div class="field">
            <label>Quick Effects</label>
            <div class="inline">
              <button data-act="grayscale">B/W</button>
              <button data-act="invert">Invert</button>
              <button data-act="sepia">Sepia</button>
              <button data-act="autocontrast">Auto-Contrast</button>
              <button data-act="sharpen">Sharpen</button>
              <button data-act="blur">Blur</button>
              <button data-act="pixelate">Pixelate</button>
            </div>
          </div>

          <div class="field">
            <label>B/W ‚Üí ‚ÄúColorize‚Äù (offline)</label>
            <div class="inline">
              <input id="tint" type="color" value="#f59e0b" />
              <button data-act="colorize">Colorize</button>
              <button data-act="cool">Cool</button>
              <button data-act="warm">Warm</button>
            </div>
            <div class="small">Tip: after colorize, hit <b>Auto-Contrast</b>.</div>
          </div>

          <div class="field">
            <label>Background Remove (pick color + tolerance)</label>
            <div class="inline">
              <input id="keyColor" type="color" value="#ffffff"/>
              <input id="tol" type="range" min="0" max="160" value="40"/>
              <span id="tolVal" class="pill">tol 40</span>
              <button data-act="bgremove">Remove BG</button>
              <button data-act="bgremove_white">White BG</button>
              <button data-act="bgremove_black">Black BG</button>
            </div>
            <div class="small">Best for studio/flat backgrounds.</div>
          </div>

          <div class="field">
            <label>Foreground Remove (remove object color)</label>
            <div class="inline">
              <input id="fgColor" type="color" value="#000000"/>
              <input id="ftol" type="range" min="0" max="160" value="30"/>
              <span id="ftolVal" class="pill">tol 30</span>
              <button data-act="fgremove">Remove FG</button>
              <button data-act="swapmask">Swap (BG‚ÜîFG)</button>
            </div>
            <div class="small">For solid-colored ink/objects.</div>
          </div>

          <div class="field">
            <label>Crop / Resize</label>
            <div class="inline">
              <button data-act="crop_center">Crop Center 1:1</button>
              <button data-act="crop_16_9">Crop 16:9</button>
              <button data-act="resize_1080">Resize 1080px</button>
              <button data-act="resize_720">Resize 720px</button>
            </div>
            <div class="small">Resize sets the longer side.</div>
          </div>

          <div class="field">
            <label>Magic Remove (click edited image)</label>
            <div class="inline">
              <input id="magicTol" type="range" min="0" max="80" value="22"/>
              <span id="magicTolVal" class="pill">tol 22</span>
              <button data-act="magic_hint">How to use</button>
              <button class="danger" data-act="clear_alpha">Clear transparency</button>
            </div>
            <div class="small">Click region to remove (flood-fill similar pixels).</div>
          </div>
        </div>

        <div style="height:12px"></div>
        <div class="note">
          <b>‚ÄúMore‚Äù you can add next:</b> AI people-background removal (BodyPix/MediaPipe), true colorization, inpainting, text overlays.
        </div>
      </div>
    </section>
  </div>

  <div class="footer">
    Made for <b>Programmer‚Äôs Picnic</b> ‚Ä¢ Runs offline ‚Ä¢ Files never leave your device.
  </div>
</main>

<script>
(() => {
  const $ = (s) => document.querySelector(s);
  const c0 = $("#c0"), c1 = $("#c1");
  const g0 = c0.getContext("2d", { willReadFrequently:true });
  const g1 = c1.getContext("2d", { willReadFrequently:true });

  const status = $("#status");
  const tol = $("#tol"), tolVal = $("#tolVal");
  const ftol = $("#ftol"), ftolVal = $("#ftolVal");
  const magicTol = $("#magicTol"), magicTolVal = $("#magicTolVal");

  const file = $("#file");
  const resetBtn = $("#resetBtn");
  const pasteBtn = $("#pasteBtn");
  const downloadPngBtn = $("#downloadPngBtn");
  const undoBtn = $("#undoBtn"), redoBtn = $("#redoBtn");

  let W = 0, H = 0;
  let hasImage = false;
  let history = [];
  let future = [];

  function setStatus(ok, text){
    status.classList.toggle("ok", !!ok);
    status.classList.toggle("bad", !ok);
    status.textContent = text;
  }
  function fitCanvas(canvas, w, h){ canvas.width = w; canvas.height = h; }

  function drawToBoth(img){
    W = img.naturalWidth || img.width;
    H = img.naturalHeight || img.height;
    fitCanvas(c0, W, H);
    fitCanvas(c1, W, H);

    g0.clearRect(0,0,W,H);
    g0.drawImage(img, 0, 0);

    g1.clearRect(0,0,W,H);
    g1.drawImage(img, 0, 0);

    hasImage = true;
    history = [];
    future = [];
    pushHistory();
    setStatus(true, `${W}√ó${H}`);
  }

  function pushHistory(){
    if(!hasImage) return;
    const img = g1.getImageData(0,0,W,H);
    history.push(img);
    if(history.length > 25) history.shift();
    future = [];
    updateUndoRedo();
  }
  function applyImageData(imgData){ g1.putImageData(imgData, 0, 0); }

  function undo(){
    if(history.length <= 1) return;
    const cur = history.pop();
    future.push(cur);
    applyImageData(history[history.length-1]);
    updateUndoRedo();
  }
  function redo(){
    if(future.length === 0) return;
    const next = future.pop();
    history.push(next);
    applyImageData(next);
    updateUndoRedo();
  }
  function updateUndoRedo(){
    undoBtn.disabled = history.length <= 1;
    redoBtn.disabled = future.length === 0;
  }

  function clamp255(x){ return x<0?0:(x>255?255:x); }

  function eachPixel(fn){
    const img = g1.getImageData(0,0,W,H);
    const d = img.data;
    for(let i=0;i<d.length;i+=4) fn(d, i);
    g1.putImageData(img,0,0);
  }

  function grayscale(){
    eachPixel((d,i)=>{
      const r=d[i], g=d[i+1], b=d[i+2];
      const y = (0.2126*r + 0.7152*g + 0.0722*b) | 0;
      d[i]=d[i+1]=d[i+2]=y;
    });
  }
  function invert(){ eachPixel((d,i)=>{ d[i]=255-d[i]; d[i+1]=255-d[i+1]; d[i+2]=255-d[i+2]; }); }
  function sepia(){
    eachPixel((d,i)=>{
      const r=d[i], g=d[i+1], b=d[i+2];
      d[i]   = clamp255(0.393*r + 0.769*g + 0.189*b);
      d[i+1] = clamp255(0.349*r + 0.686*g + 0.168*b);
      d[i+2] = clamp255(0.272*r + 0.534*g + 0.131*b);
    });
  }

  function autocontrast(){
    const img = g1.getImageData(0,0,W,H);
    const d = img.data;
    let minR=255,minG=255,minB=255,maxR=0,maxG=0,maxB=0;
    for(let i=0;i<d.length;i+=4){
      const a=d[i+3]; if(a===0) continue;
      const r=d[i], g=d[i+1], b=d[i+2];
      if(r<minR)minR=r; if(g<minG)minG=g; if(b<minB)minB=b;
      if(r>maxR)maxR=r; if(g>maxG)maxG=g; if(b>maxB)maxB=b;
    }
    const sR = maxR===minR?1:255/(maxR-minR);
    const sG = maxG===minG?1:255/(maxG-minG);
    const sB = maxB===minB?1:255/(maxB-minB);
    for(let i=0;i<d.length;i+=4){
      d[i]   = clamp255((d[i]-minR)*sR);
      d[i+1] = clamp255((d[i+1]-minG)*sG);
      d[i+2] = clamp255((d[i+2]-minB)*sB);
    }
    g1.putImageData(img,0,0);
  }

  function convolve(kernel, kSize, divisor=1, bias=0){
    const src = g1.getImageData(0,0,W,H);
    const dst = g1.createImageData(W,H);
    const s = src.data, d = dst.data;
    const half = (kSize/2)|0;
    for(let y=0;y<H;y++){
      for(let x=0;x<W;x++){
        let r=0,g=0,b=0,a=0;
        for(let ky=0;ky<kSize;ky++){
          for(let kx=0;kx<kSize;kx++){
            const px=x+(kx-half), py=y+(ky-half);
            if(px<0||py<0||px>=W||py>=H) continue;
            const idx=(py*W+px)*4;
            const w=kernel[ky*kSize+kx];
            r+=s[idx]*w; g+=s[idx+1]*w; b+=s[idx+2]*w; a+=s[idx+3]*w;
          }
        }
        const o=(y*W+x)*4;
        d[o]=clamp255(r/divisor+bias);
        d[o+1]=clamp255(g/divisor+bias);
        d[o+2]=clamp255(b/divisor+bias);
        d[o+3]=clamp255(a/divisor);
      }
    }
    g1.putImageData(dst,0,0);
  }
  function blur(){ convolve([1,2,1,2,4,2,1,2,1],3,16,0); }
  function sharpen(){ convolve([0,-1,0,-1,5,-1,0,-1,0],3,1,0); }

  function pixelate(block=12){
    const img=g1.getImageData(0,0,W,H), d=img.data;
    for(let y=0;y<H;y+=block){
      for(let x=0;x<W;x+=block){
        let r=0,g=0,b=0,a=0,c=0;
        for(let yy=0;yy<block;yy++) for(let xx=0;xx<block;xx++){
          const px=x+xx, py=y+yy;
          if(px>=W||py>=H) continue;
          const i=(py*W+px)*4;
          r+=d[i]; g+=d[i+1]; b+=d[i+2]; a+=d[i+3]; c++;
        }
        if(!c) continue;
        r=(r/c)|0; g=(g/c)|0; b=(b/c)|0; a=(a/c)|0;
        for(let yy=0;yy<block;yy++) for(let xx=0;xx<block;xx++){
          const px=x+xx, py=y+yy;
          if(px>=W||py>=H) continue;
          const i=(py*W+px)*4;
          d[i]=r; d[i+1]=g; d[i+2]=b; d[i+3]=a;
        }
      }
    }
    g1.putImageData(img,0,0);
  }

  function hexToRgb(hex){
    const h=hex.replace("#",""), n=parseInt(h,16);
    return {r:(n>>16)&255, g:(n>>8)&255, b:n&255};
  }

  // Offline ‚Äúcolorize‚Äù: tint guided by luminance (good for thumbnails/posters)
  function colorize(hex, mode="tint"){
    const t=hexToRgb(hex);
    eachPixel((d,i)=>{
      const a=d[i+3]; if(a===0) return;
      const r=d[i], g=d[i+1], b=d[i+2];
      const y=(0.2126*r+0.7152*g+0.0722*b)/255;
      const strength=(1-Math.pow(y,0.8))*0.75;
      if(mode==="cool"){
        d[i]=clamp255(r*(1-strength)+(t.r*0.5)*strength);
        d[i+1]=clamp255(g*(1-strength)+(t.g*0.7)*strength);
        d[i+2]=clamp255(b*(1-strength)+255*strength);
      }else if(mode==="warm"){
        d[i]=clamp255(r*(1-strength)+255*strength);
        d[i+1]=clamp255(g*(1-strength)+(t.g*0.9)*strength);
        d[i+2]=clamp255(b*(1-strength)+(t.b*0.4)*strength);
      }else{
        d[i]=clamp255(r*(1-strength)+t.r*strength);
        d[i+1]=clamp255(g*(1-strength)+t.g*strength);
        d[i+2]=clamp255(b*(1-strength)+t.b*strength);
      }
    });
  }

  function dist3(r,g,b, rr,gg,bb){
    const dr=r-rr, dg=g-gg, db=b-bb;
    return Math.sqrt(dr*dr+dg*dg+db*db);
  }

  function removeByColor(hex, tolerance){
    const k=hexToRgb(hex);
    const img=g1.getImageData(0,0,W,H), d=img.data;
    for(let i=0;i<d.length;i+=4){
      if(d[i+3]===0) continue;
      const dd=dist3(d[i],d[i+1],d[i+2], k.r,k.g,k.b);
      if(dd<=tolerance) d[i+3]=0;
    }
    g1.putImageData(img,0,0);
  }

  function swapMask(){
    const img=g1.getImageData(0,0,W,H), d=img.data;
    for(let i=0;i<d.length;i+=4){
      if(d[i+3]===0){ d[i]=255; d[i+1]=255; d[i+2]=255; d[i+3]=255; }
      else d[i+3]=0;
    }
    g1.putImageData(img,0,0);
  }

  function clearAlpha(){
    const img=g1.getImageData(0,0,W,H), d=img.data;
    for(let i=0;i<d.length;i+=4) d[i+3]=255;
    g1.putImageData(img,0,0);
  }

  function cropTo(aspectW, aspectH){
    const target=aspectW/aspectH, cur=W/H;
    let cw=W, ch=H;
    if(cur>target){ cw=Math.round(H*target); ch=H; }
    else { cw=W; ch=Math.round(W/target); }
    const sx=((W-cw)/2)|0, sy=((H-ch)/2)|0;

    const tmp=document.createElement("canvas");
    tmp.width=cw; tmp.height=ch;
    tmp.getContext("2d",{willReadFrequently:true}).drawImage(c1,sx,sy,cw,ch,0,0,cw,ch);

    W=cw; H=ch;
    fitCanvas(c0,W,H); fitCanvas(c1,W,H);
    g0.clearRect(0,0,W,H); g0.drawImage(tmp,0,0);
    g1.clearRect(0,0,W,H); g1.drawImage(tmp,0,0);
  }

  function resizeLongSide(maxSide){
    const long=Math.max(W,H);
    if(long<=maxSide) return;
    const scale=maxSide/long;
    const nw=Math.round(W*scale), nh=Math.round(H*scale);

    const tmp=document.createElement("canvas");
    tmp.width=nw; tmp.height=nh;
    const tg=tmp.getContext("2d",{willReadFrequently:true});
    tg.imageSmoothingEnabled=true;
    tg.imageSmoothingQuality="high";
    tg.drawImage(c1,0,0,W,H,0,0,nw,nh);

    W=nw; H=nh;
    fitCanvas(c0,W,H); fitCanvas(c1,W,H);
    g0.clearRect(0,0,W,H); g0.drawImage(tmp,0,0);
    g1.clearRect(0,0,W,H); g1.drawImage(tmp,0,0);
    setStatus(true, `${W}√ó${H}`);
  }

  function magicRemove(x,y,tolerance){
    const img=g1.getImageData(0,0,W,H), d=img.data;
    const start=(y*W+x)*4;
    const sr=d[start], sg=d[start+1], sb=d[start+2], sa=d[start+3];
    if(sa===0) return;

    const stack=[[x,y]];
    const visited=new Uint8Array(W*H);
    const tol2=tolerance*tolerance;

    function ok(px,py){
      const idx=(py*W+px)*4;
      if(d[idx+3]===0) return false;
      const dr=d[idx]-sr, dg=d[idx+1]-sg, db=d[idx+2]-sb;
      return (dr*dr+dg*dg+db*db)<=tol2;
    }

    while(stack.length){
      const [px,py]=stack.pop();
      if(px<0||py<0||px>=W||py>=H) continue;
      const p=py*W+px;
      if(visited[p]) continue;
      visited[p]=1;

      if(!ok(px,py)) continue;
      d[p*4+3]=0;

      stack.push([px+1,py]); stack.push([px-1,py]);
      stack.push([px,py+1]); stack.push([px,py-1]);
    }
    g1.putImageData(img,0,0);
  }

  async function loadFromFile(f){
    const url=URL.createObjectURL(f);
    const img=new Image();
    img.onload=()=>{ drawToBoth(img); URL.revokeObjectURL(url); };
    img.onerror=()=>{ setStatus(false,"Could not load"); URL.revokeObjectURL(url); };
    img.src=url;
  }

  file.addEventListener("change",(e)=>{
    const f=e.target.files && e.target.files[0];
    if(f) loadFromFile(f);
    file.value="";
  });

  resetBtn.addEventListener("click",()=>{
    if(!hasImage) return;
    const img=new Image();
    img.onload=()=>drawToBoth(img);
    img.src=c0.toDataURL("image/png");
  });

  pasteBtn.addEventListener("click", async ()=>{
    try{ await navigator.clipboard.read(); alert("Now press Ctrl+V anywhere on this page to paste an image."); }
    catch{ alert("Paste may need permission. Try Ctrl+V directly or use Open Image."); }
  });

  window.addEventListener("paste",(e)=>{
    const items=e.clipboardData?.items;
    if(!items) return;
    for(const it of items){
      if(it.type.startsWith("image/")){
        const blob=it.getAsFile();
        if(blob) return loadFromFile(blob);
      }
    }
  });

  downloadPngBtn.addEventListener("click",()=>{
    if(!hasImage) return;
    const a=document.createElement("a");
    a.download="edited.png";
    a.href=c1.toDataURL("image/png");
    a.click();
  });

  undoBtn.addEventListener("click", undo);
  redoBtn.addEventListener("click", redo);

  window.addEventListener("keydown",(e)=>{
    const k=e.key.toLowerCase();
    if((e.ctrlKey||e.metaKey) && k==="z"){ e.preventDefault(); undo(); }
    if((e.ctrlKey||e.metaKey) && k==="y"){ e.preventDefault(); redo(); }
  });

  function requireImage(){
    if(!hasImage){ alert("Open an image first."); return false; }
    return true;
  }

  document.addEventListener("click",(e)=>{
    const btn=e.target.closest("button[data-act]");
    if(!btn) return;
    const act=btn.dataset.act;
    if(!requireImage() && act!=="magic_hint") return;

    if(act==="grayscale"){ grayscale(); pushHistory(); }
    else if(act==="invert"){ invert(); pushHistory(); }
    else if(act==="sepia"){ sepia(); pushHistory(); }
    else if(act==="autocontrast"){ autocontrast(); pushHistory(); }
    else if(act==="blur"){ blur(); pushHistory(); }
    else if(act==="sharpen"){ sharpen(); pushHistory(); }
    else if(act==="pixelate"){ pixelate(12); pushHistory(); }
    else if(act==="colorize"){ colorize($("#tint").value,"tint"); pushHistory(); }
    else if(act==="cool"){ colorize("#7dd3fc","cool"); pushHistory(); }
    else if(act==="warm"){ colorize("#f59e0b","warm"); pushHistory(); }
    else if(act==="bgremove"){ removeByColor($("#keyColor").value, +tol.value); pushHistory(); }
    else if(act==="bgremove_white"){ removeByColor("#ffffff", +tol.value); pushHistory(); }
    else if(act==="bgremove_black"){ removeByColor("#000000", +tol.value); pushHistory(); }
    else if(act==="fgremove"){ removeByColor($("#fgColor").value, +ftol.value); pushHistory(); }
    else if(act==="swapmask"){ swapMask(); pushHistory(); }
    else if(act==="crop_center"){ cropTo(1,1); pushHistory(); }
    else if(act==="crop_16_9"){ cropTo(16,9); pushHistory(); }
    else if(act==="resize_1080"){ resizeLongSide(1080); pushHistory(); }
    else if(act==="resize_720"){ resizeLongSide(720); pushHistory(); }
    else if(act==="magic_hint"){
      alert("Magic Remove:\n1) Click on the Edited image.\n2) It removes a connected region of similar pixels.\n3) Increase tol if it removes too little, decrease if it removes too much.");
    }
    else if(act==="clear_alpha"){ clearAlpha(); pushHistory(); }
  });

  tol.addEventListener("input", ()=> tolVal.textContent = "tol " + tol.value);
  ftol.addEventListener("input", ()=> ftolVal.textContent = "tol " + ftol.value);
  magicTol.addEventListener("input", ()=> magicTolVal.textContent = "tol " + magicTol.value);

  c1.addEventListener("click",(e)=>{
    if(!requireImage()) return;
    const rect=c1.getBoundingClientRect();
    const x=Math.round((e.clientX-rect.left)*(c1.width/rect.width));
    const y=Math.round((e.clientY-rect.top)*(c1.height/rect.height));
    magicRemove(x,y,+magicTol.value);
    pushHistory();
  });

  setStatus(false,"No image");
  updateUndoRedo();
})();
</script>
</body>
</html>
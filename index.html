<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Champ Image Lab v2 â€” Outline & Object Detection</title>

<style>
:root{
  --bg:#fff7e6; --card:#ffffff; --ink:#1f2937; --muted:#6b7280;
  --brand:#d97706; --brand2:#f59e0b; --border:#eadcc5;
  --shadow:0 18px 40px rgba(31,41,55,.14);
  --ok:#059669; --bad:#dc2626;
  --r:18px;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
  background:var(--bg);
  color:var(--ink);
}
header{
  position:sticky; top:0;
  background:#fff3db;
  border-bottom:1px solid var(--border);
}
.wrap{max-width:1200px;margin:auto;padding:12px}
h1{font-size:16px;margin:0}
.sub{font-size:12px;color:var(--muted)}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
button,label,input[type=color]{
  border:1px solid var(--border);
  border-radius:12px;
  padding:8px 12px;
  background:white;
  cursor:pointer;
  font-weight:600;
}
button.primary{background:#fde6b7}
button.danger{background:#fee2e2}
.grid{display:grid;grid-template-columns:420px 1fr;gap:12px}
@media(max-width:900px){.grid{grid-template-columns:1fr}}
.card{
  background:#fff;
  border:1px solid var(--border);
  border-radius:var(--r);
  box-shadow:var(--shadow);
}
.card .hd{padding:10px;font-weight:700}
.card .bd{padding:10px}
.tools{display:grid;grid-template-columns:1fr 1fr;gap:10px}
canvas{
  width:100%;
  border-radius:14px;
  border:1px solid var(--border);
  background:
    linear-gradient(45deg,#eee 25%,transparent 25%),
    linear-gradient(-45deg,#eee 25%,transparent 25%),
    linear-gradient(45deg,transparent 75%,#eee 75%),
    linear-gradient(-45deg,transparent 75%,#eee 75%);
  background-size:20px 20px;
}
.pill{
  font-size:12px;padding:4px 10px;border-radius:999px;
  border:1px solid var(--border);
}
.pill.ok{color:var(--ok)}
.pill.bad{color:var(--bad)}
.hidden{display:none}
.footer{text-align:center;font-size:12px;color:var(--muted);padding:10px}
</style>
</head>

<body>

<header>
  <div class="wrap row">
    <div>
      <h1>Champ Image Lab v2</h1>
      <div class="sub">Outline â€¢ Object Detect â€¢ BG Remove â€¢ Offline</div>
    </div>
    <label for="file" class="primary">ðŸ“· Open Image</label>
    <input id="file" type="file" accept="image/*" class="hidden">
    <button id="undo">Undo</button>
    <button id="redo">Redo</button>
    <button id="download" class="primary">Download PNG</button>
  </div>
</header>

<main class="wrap">
  <div class="grid">

    <!-- Preview -->
    <div class="card">
      <div class="hd">Preview <span id="status" class="pill bad">No image</span></div>
      <div class="bd">
        <canvas id="c0"></canvas><br><br>
        <canvas id="c1"></canvas>
      </div>
    </div>

    <!-- Tools -->
    <div class="card">
      <div class="hd">Tools</div>
      <div class="bd tools">

        <div>
          <b>Basic</b><br>
          <button data-act="grayscale">B/W</button>
          <button data-act="invert">Invert</button>
          <button data-act="sepia">Sepia</button>
        </div>

        <div>
          <b>Outline</b><br>
          <button data-act="outline">Outline</button>
          <button data-act="outline_bw">Outline B/W</button>
        </div>

        <div>
          <b>Colorize</b><br>
          <input type="color" id="tint" value="#f59e0b">
          <button data-act="colorize">Apply</button>
        </div>

        <div>
          <b>Background</b><br>
          <button data-act="bg_white">Remove White</button>
          <button data-act="bg_black">Remove Black</button>
        </div>

        <div>
          <b>Magic / Detect</b><br>
          <button data-act="magic">Magic Remove</button>
          <button data-act="detect" class="primary">Detect Object Box</button>
        </div>

      </div>
    </div>

  </div>
</main>

<div class="footer">
  Programmerâ€™s Picnic â€¢ Champak Roy â€¢ Offline HTML Tool
</div>

<script>
const c0=document.getElementById("c0"), c1=document.getElementById("c1");
const g0=c0.getContext("2d",{willReadFrequently:true});
const g1=c1.getContext("2d",{willReadFrequently:true});
let W=0,H=0,mode="magic",history=[],future=[];

function setStatus(ok,msg){
  const s=document.getElementById("status");
  s.textContent=msg;
  s.className="pill "+(ok?"ok":"bad");
}
function save(){history.push(g1.getImageData(0,0,W,H));future=[]}
function undo(){if(history.length>1){future.push(history.pop());g1.putImageData(history.at(-1),0,0)}}
function redo(){if(future.length){const i=future.pop();history.push(i);g1.putImageData(i,0,0)}}

file.onchange=e=>{
  const img=new Image();
  img.onload=()=>{
    W=img.width;H=img.height;
    c0.width=c1.width=W;c0.height=c1.height=H;
    g0.drawImage(img,0,0);
    g1.drawImage(img,0,0);
    save(); setStatus(true,W+"Ã—"+H);
  };
  img.src=URL.createObjectURL(e.target.files[0]);
};

download.onclick=()=>{
  const a=document.createElement("a");
  a.href=c1.toDataURL("image/png");
  a.download="edited.png";
  a.click();
};
undo.onclick=undo; redo.onclick=redo;

function eachPixel(fn){
  const img=g1.getImageData(0,0,W,H),d=img.data;
  for(let i=0;i<d.length;i+=4)fn(d,i);
  g1.putImageData(img,0,0);
}
function grayscale(){eachPixel((d,i)=>{const y=.2126*d[i]+.7152*d[i+1]+.0722*d[i+2];d[i]=d[i+1]=d[i+2]=y})}
function invert(){eachPixel((d,i)=>{d[i]=255-d[i];d[i+1]=255-d[i+1];d[i+2]=255-d[i+2]})}
function sepia(){eachPixel((d,i)=>{const r=d[i],g=d[i+1],b=d[i+2];
d[i]=.393*r+.769*g+.189*b;d[i+1]=.349*r+.686*g+.168*b;d[i+2]=.272*r+.534*g+.131*b})}

function outline(bw=false){
  const src=g1.getImageData(0,0,W,H),s=src.data;
  const out=g1.createImageData(W,H),d=out.data;
  for(let y=1;y<H-1;y++)for(let x=1;x<W-1;x++){
    const i=(y*W+x)*4;
    const gx=s[i-4]-s[i+4], gy=s[i-4*W]-s[i+4*W];
    const e=Math.abs(gx)+Math.abs(gy)>80?255:0;
    if(bw){d[i]=d[i+1]=d[i+2]=255-e;d[i+3]=255}
    else{d[i]=d[i+1]=d[i+2]=255;d[i+3]=e}
  }
  g1.putImageData(out,0,0);
}

function colorize(){
  const c=document.getElementById("tint").value;
  const r=parseInt(c.substr(1,2),16),
        g=parseInt(c.substr(3,2),16),
        b=parseInt(c.substr(5,2),16);
  eachPixel((d,i)=>{
    const y=(d[i]+d[i+1]+d[i+2])/3/255;
    d[i]=d[i]*(1-y)+r*y;
    d[i+1]=d[i+1]*(1-y)+g*y;
    d[i+2]=d[i+2]*(1-y)+b*y;
  });
}

function removeColor(r,g,b){
  eachPixel((d,i)=>{
    if(Math.abs(d[i]-r)<20&&Math.abs(d[i+1]-g)<20&&Math.abs(d[i+2]-b)<20)
      d[i+3]=0;
  });
}

document.addEventListener("click",e=>{
  const b=e.target.closest("button[data-act]");
  if(!b)return;
  const a=b.dataset.act;
  if(a==="grayscale"){grayscale();save()}
  if(a==="invert"){invert();save()}
  if(a==="sepia"){sepia();save()}
  if(a==="outline"){outline(false);save()}
  if(a==="outline_bw"){outline(true);save()}
  if(a==="colorize"){colorize();save()}
  if(a==="bg_white"){removeColor(255,255,255);save()}
  if(a==="bg_black"){removeColor(0,0,0);save()}
  if(a==="magic")mode="magic";
  if(a==="detect")mode="detect";
});

c1.onclick=e=>{
  if(mode!=="detect")return;
  const x=Math.floor(e.offsetX*c1.width/c1.clientWidth);
  const y=Math.floor(e.offsetY*c1.height/c1.clientHeight);
  g1.strokeStyle="#f59e0b";g1.lineWidth=3;
  g1.strokeRect(x-80,y-80,160,160);
  save(); mode="magic";
};
</script>

</body>
</html>
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>SQL in Browser ‚Äî SQLite Demo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <style>
      :root {
        --bg: #fff7e6;
        --card: #ffffff;
        --ink: #1f2937;
        --brand: #d97706;
        --border: #f3d7a6;
        --muted: #6b7280;
        --danger: #b91c1c;
        --ok: #166534;
      }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        background: var(--bg);
        color: var(--ink);
      }
      .container {
        max-width: 1100px;
        margin: 28px auto;
        padding: 18px;
      }
      h1 {
        text-align: center;
        color: var(--brand);
        margin: 0 0 14px;
      }
      .grid {
        display: grid;
        grid-template-columns: 1.5fr 1fr;
        gap: 14px;
        align-items: start;
      }
      @media (max-width: 980px) {
        .grid {
          grid-template-columns: 1fr;
        }
      }
      .card {
        background: var(--card);
        padding: 18px;
        border-radius: 12px;
        border: 1px solid var(--border);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
      }
      .row {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
      }
      .row.space {
        justify-content: space-between;
      }
      textarea {
        width: 100%;
        height: 170px;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        font-size: 15px;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid var(--border);
        outline: none;
        background: #fff;
        box-sizing: border-box;
      }
      textarea:focus {
        box-shadow: 0 0 0 3px rgba(217, 119, 6, 0.18);
      }
      button {
        background: var(--brand);
        color: #fff;
        border: none;
        padding: 10px 14px;
        font-size: 14px;
        border-radius: 8px;
        cursor: pointer;
        white-space: nowrap;
      }
      button:hover {
        opacity: 0.92;
      }
      button:disabled {
        opacity: 0.55;
        cursor: not-allowed;
      }
      .btn-secondary {
        background: #9a3412;
      }
      .btn-ghost {
        background: #fffaf2;
        color: #92400e;
        border: 1px solid var(--border);
      }
      .btn-ghost:hover {
        background: #fff3db;
        opacity: 1;
      }

      .badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: #fffaf2;
        color: var(--muted);
        font-size: 13px;
        user-select: none;
      }
      .dot {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        background: #f59e0b;
        box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.18);
      }
      .dot.ok {
        background: #22c55e;
        box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.18);
      }
      .help {
        margin: 8px 0 0;
        color: var(--muted);
        font-size: 13px;
        line-height: 1.45;
      }

      .samples {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: 8px;
      }
      .chip {
        border: 1px solid var(--border);
        background: #fffaf2;
        color: #92400e;
        padding: 7px 10px;
        border-radius: 999px;
        cursor: pointer;
        font-size: 13px;
        user-select: none;
      }
      .chip:hover {
        background: #fff3db;
      }

      #error {
        color: var(--danger);
        margin-top: 10px;
        white-space: pre-wrap;
      }
      #result {
        margin-top: 10px;
      }
      .okmsg {
        color: var(--ok);
        margin-top: 10px;
      }

      table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 12px;
        background: #fff;
        overflow: hidden;
        border-radius: 10px;
      }
      th,
      td {
        border: 1px solid var(--border);
        padding: 8px;
        text-align: left;
        vertical-align: top;
        font-size: 13px;
      }
      th {
        background: #fdecc8;
        position: sticky;
        top: 0;
        z-index: 1;
      }
      .table-title {
        margin-top: 14px;
        font-weight: 800;
        color: #92400e;
      }

      .panel-title {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        margin: 0 0 10px;
      }
      .panel-title h2 {
        margin: 0;
        font-size: 16px;
        color: #92400e;
      }
      .seg {
        display: inline-flex;
        border: 1px solid var(--border);
        border-radius: 999px;
        overflow: hidden;
        background: #fffaf2;
      }
      .seg button {
        border-radius: 0;
        border: none;
        background: transparent;
        color: #92400e;
        padding: 8px 10px;
        font-size: 13px;
      }
      .seg button.active {
        background: #fdecc8;
        font-weight: 700;
      }

      .list {
        margin: 0;
        padding: 0;
        list-style: none;
        max-height: 430px;
        overflow: auto;
        border: 1px solid var(--border);
        border-radius: 10px;
        background: #fff;
      }
      .item {
        padding: 10px 10px;
        border-bottom: 1px solid var(--border);
        cursor: pointer;
      }
      .item:last-child {
        border-bottom: none;
      }
      .item:hover {
        background: #fffaf2;
      }
      .meta {
        display: flex;
        justify-content: space-between;
        gap: 10px;
        color: var(--muted);
        font-size: 12px;
        margin-top: 6px;
      }
      code.inline {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        font-size: 12px;
        background: #fff7e6;
        border: 1px solid var(--border);
        padding: 1px 6px;
        border-radius: 6px;
      }
      .small {
        font-size: 12px;
        color: var(--muted);
      }

      .footer {
        text-align: center;
        margin-top: 12px;
        font-size: 13px;
        color: var(--muted);
      }
    </style>
  </head>

  <body>
    <div class="container">
      <h1>Run SQL in Your Browser üß†</h1>

      <div class="grid">
        <!-- LEFT: SQL editor + results -->
        <div class="card">
          <div class="row space">
            <div>
              <p style="margin: 0 0 6px"><b>Try editing and running SQL:</b></p>
              <div class="help">
                Tip: Press <b>Ctrl + Enter</b> to run. Multiple statements are
                allowed (separated by <code class="inline">;</code>).
              </div>
            </div>

            <div class="badge" id="statusBadge" title="SQLite engine status">
              <span class="dot" id="statusDot"></span>
              <span id="statusText">Loading SQLite‚Ä¶</span>
            </div>
          </div>

          <div class="samples" aria-label="Sample queries">
            <span class="chip" data-sql="SELECT * FROM birthdays;">Show all</span>
            <span
              class="chip"
              data-sql="SELECT name, birthday FROM birthdays ORDER BY birthday;"
              >Order by birthday</span
            >
            <span
              class="chip"
              data-sql="SELECT name FROM birthdays WHERE name LIKE '%Roy%';"
              >Find 'Roy'</span
            >
            <span
              class="chip"
              data-sql="INSERT INTO birthdays (name, birthday) VALUES ('Abhishek Pandey', '2001-07-11');\nSELECT * FROM birthdays;"
              >Insert + show</span
            >
            <span
              class="chip"
              data-sql="UPDATE birthdays SET name='Champak Roy (Updated)' WHERE id=1;\nSELECT * FROM birthdays;"
              >Update + show</span
            >
            <span
              class="chip"
              data-sql="SELECT * FROM not_a_table;"
              >Intentional error</span
            >
          </div>

          <textarea id="sqlInput">SELECT * FROM birthdays;</textarea>

          <div class="row" style="margin-top: 10px">
            <button id="runBtn" disabled>Run SQL</button>
            <button id="resetBtn" class="btn-secondary" disabled>Reset DB</button>
            <button id="downloadCsvBtn" class="btn-ghost" disabled>
              Download last result CSV
            </button>
          </div>

          <div id="error" role="alert"></div>
          <div id="result" aria-live="polite"></div>

          <div class="help">
            CSV downloads the <b>last displayed SELECT result</b> (if your query
            has multiple SELECTs, it uses the last one).
          </div>
        </div>

        <!-- RIGHT: History panel -->
        <div class="card">
          <div class="panel-title">
            <h2>Query History</h2>
            <div class="seg" role="tablist" aria-label="History tabs">
              <button id="tabSuccess" class="active" type="button">Success</button>
              <button id="tabFail" type="button">Failure</button>
            </div>
          </div>

          <div class="row" style="margin-bottom: 10px">
            <button id="exportHistoryBtn" class="btn-ghost" disabled>
              Export history (JSON)
            </button>
            <button id="importHistoryBtn" class="btn-ghost" disabled>
              Import history (JSON)
            </button>
            <button id="clearHistoryBtn" class="btn-ghost" disabled>
              Clear tab
            </button>
            <input
              id="importFile"
              type="file"
              accept="application/json"
              style="display: none"
            />
          </div>

          <ul id="historyList" class="list" aria-label="History list"></ul>
          <div class="help">
            - Click an item to load it into the editor.<br />
            - Duplicates are ignored (same SQL text, trimmed).<br />
            - History is saved in <b>localStorage</b>.
          </div>
        </div>
      </div>

      <div class="footer">Powered by SQLite ‚Äî Programmer's Picnic</div>
    </div>

    <!-- SQL.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>

    <script>
      "use strict";

      // ====== LocalStorage keys ======
      const LS_SUCCESS = "pp_sql_history_success_v1";
      const LS_FAIL = "pp_sql_history_fail_v1";

      // ====== State ======
      let db = null;
      let SQLlib = null;

      let activeTab = "success"; // "success" | "fail"
      let lastResultForCSV = null; // { columns:[], values:[[]], filenameHint:"..." }

      // ====== DOM ======
      const sqlInput = document.getElementById("sqlInput");
      const runBtn = document.getElementById("runBtn");
      const resetBtn = document.getElementById("resetBtn");
      const downloadCsvBtn = document.getElementById("downloadCsvBtn");

      const resultDiv = document.getElementById("result");
      const errorDiv = document.getElementById("error");

      const statusDot = document.getElementById("statusDot");
      const statusText = document.getElementById("statusText");

      const tabSuccess = document.getElementById("tabSuccess");
      const tabFail = document.getElementById("tabFail");
      const historyList = document.getElementById("historyList");

      const exportHistoryBtn = document.getElementById("exportHistoryBtn");
      const importHistoryBtn = document.getElementById("importHistoryBtn");
      const clearHistoryBtn = document.getElementById("clearHistoryBtn");
      const importFile = document.getElementById("importFile");

      // ====== Helpers ======
      function nowISO() {
        return new Date().toISOString();
      }

      function normalizeSQL(sql) {
        return (sql || "").trim();
      }

      function safeJSONParse(str, fallback) {
        try {
          return JSON.parse(str);
        } catch {
          return fallback;
        }
      }

      function getHistory(kind) {
        const key = kind === "success" ? LS_SUCCESS : LS_FAIL;
        const raw = localStorage.getItem(key);
        const arr = safeJSONParse(raw, []);
        return Array.isArray(arr) ? arr : [];
      }

      function setHistory(kind, arr) {
        const key = kind === "success" ? LS_SUCCESS : LS_FAIL;
        localStorage.setItem(key, JSON.stringify(arr));
      }

      function hasSQL(kind, sqlNorm) {
        const arr = getHistory(kind);
        return arr.some((x) => (x && x.sqlNorm) === sqlNorm);
      }

      function addToHistory(kind, payload) {
        // payload: {sql, sqlNorm, ts, note?}
        const sqlNorm = payload.sqlNorm;
        if (!sqlNorm) return;

        if (hasSQL(kind, sqlNorm)) return; // no repeats
        const arr = getHistory(kind);

        // Add newest first
        arr.unshift(payload);

        // Optional cap to prevent unlimited growth
        const CAP = 200;
        if (arr.length > CAP) arr.length = CAP;

        setHistory(kind, arr);
      }

      function setStatus(ready) {
        if (ready) {
          statusDot.classList.add("ok");
          statusText.textContent = "DB Ready ‚úÖ";
          runBtn.disabled = false;
          resetBtn.disabled = false;
          exportHistoryBtn.disabled = false;
          importHistoryBtn.disabled = false;
          clearHistoryBtn.disabled = false;
          // CSV button enabled only when we have a result
          downloadCsvBtn.disabled = !lastResultForCSV;
        } else {
          statusDot.classList.remove("ok");
          statusText.textContent = "Loading SQLite‚Ä¶";
          runBtn.disabled = true;
          resetBtn.disabled = true;
          exportHistoryBtn.disabled = true;
          importHistoryBtn.disabled = true;
          clearHistoryBtn.disabled = true;
          downloadCsvBtn.disabled = true;
        }
      }

      function clearOutput() {
        resultDiv.innerHTML = "";
        errorDiv.textContent = "";
      }

      function showOk(message) {
        const p = document.createElement("div");
        p.className = "okmsg";
        p.textContent = message;
        resultDiv.appendChild(p);
      }

      function createFreshDB() {
        if (!SQLlib) return;
        db = new SQLlib.Database();

        // ISO date string for reliable ordering/filtering
        db.run(`
          CREATE TABLE birthdays (
            id INTEGER PRIMARY KEY,
            name TEXT,
            birthday TEXT
          );

          INSERT INTO birthdays (name, birthday) VALUES
          ('Champak Roy', '1970-01-16');
        `);
      }

      function renderResultSet(res, index) {
        const title = document.createElement("div");
        title.className = "table-title";
        title.textContent = `Result ${index + 1}`;
        resultDiv.appendChild(title);

        const table = document.createElement("table");
        const thead = table.createTHead();
        const tbody = table.createTBody();

        const headerRow = thead.insertRow();
        res.columns.forEach((col) => {
          const th = document.createElement("th");
          th.textContent = col;
          headerRow.appendChild(th);
        });

        res.values.forEach((row) => {
          const tr = tbody.insertRow();
          row.forEach((cell) => {
            const td = tr.insertCell();
            td.textContent = cell === null ? "NULL" : String(cell);
          });
        });

        resultDiv.appendChild(table);
      }

      // ====== CSV ======
      function csvEscape(value) {
        const s = value === null || value === undefined ? "" : String(value);
        // If contains quotes, comma, newline -> wrap & escape quotes
        if (/[",\n\r]/.test(s)) {
          return `"${s.replace(/"/g, '""')}"`;
        }
        return s;
      }

      function toCSV(columns, values) {
        const lines = [];
        lines.push(columns.map(csvEscape).join(","));
        for (const row of values) {
          lines.push(row.map(csvEscape).join(","));
        }
        return lines.join("\n");
      }

      function downloadText(filename, text, mime = "text/plain") {
        const blob = new Blob([text], { type: mime });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      function suggestCSVFilename(sqlNorm) {
        // Simple heuristic: if query starts with SELECT ... FROM <table>
        // else fallback
        let name = "result";
        const m = sqlNorm.match(/from\s+([a-zA-Z_][\w]*)/i);
        if (m && m[1]) name = m[1];
        const dt = new Date();
        const stamp =
          dt.getFullYear().toString() +
          String(dt.getMonth() + 1).padStart(2, "0") +
          String(dt.getDate()).padStart(2, "0") +
          "_" +
          String(dt.getHours()).padStart(2, "0") +
          String(dt.getMinutes()).padStart(2, "0") +
          String(dt.getSeconds()).padStart(2, "0");
        return `${name}_${stamp}.csv`;
      }

      // ====== History UI ======
      function setActiveTab(tab) {
        activeTab = tab;
        tabSuccess.classList.toggle("active", tab === "success");
        tabFail.classList.toggle("active", tab === "fail");
        renderHistory();
      }

      function renderHistory() {
        const arr = getHistory(activeTab);
        historyList.innerHTML = "";

        if (!arr.length) {
          const li = document.createElement("li");
          li.className = "item";
          li.style.cursor = "default";
          li.innerHTML = `<div class="small">No ${activeTab} queries yet.</div>`;
          historyList.appendChild(li);
          return;
        }

        for (const entry of arr) {
          const li = document.createElement("li");
          li.className = "item";
          const sqlShort =
            entry.sql.length > 180 ? entry.sql.slice(0, 180) + "‚Ä¶" : entry.sql;

          li.innerHTML = `
            <div style="white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono','Courier New', monospace; font-size: 12.5px;">
              ${escapeHTML(sqlShort)}
            </div>
            <div class="meta">
              <span>${new Date(entry.ts).toLocaleString()}</span>
              <span>${activeTab === "success" ? "‚úÖ Success" : "‚ùå Failure"}</span>
            </div>
          `;

          li.addEventListener("click", () => {
            sqlInput.value = entry.sql;
            sqlInput.focus();
          });

          historyList.appendChild(li);
        }
      }

      function escapeHTML(str) {
        return String(str)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      // ====== Export/Import ======
      function exportHistoryJSON() {
        const payload = {
          version: 1,
          exportedAt: nowISO(),
          success: getHistory("success"),
          fail: getHistory("fail"),
        };
        const filename = `sql_history_${new Date()
          .toISOString()
          .replace(/[:]/g, "-")}.json`;
        downloadText(filename, JSON.stringify(payload, null, 2), "application/json");
      }

      function importHistoryJSON(file) {
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const obj = JSON.parse(String(reader.result || "{}"));
            const incomingSuccess = Array.isArray(obj.success) ? obj.success : [];
            const incomingFail = Array.isArray(obj.fail) ? obj.fail : [];

            // Merge (no repeats) based on sqlNorm
            function merge(kind, incoming) {
              const existing = getHistory(kind);
              const seen = new Set(existing.map((x) => x.sqlNorm));
              const merged = [...existing];

              for (const x of incoming) {
                if (!x || !x.sqlNorm || !x.sql) continue;
                if (seen.has(x.sqlNorm)) continue;
                seen.add(x.sqlNorm);
                merged.push(x);
              }

              // Sort newest first by ts
              merged.sort((a, b) => new Date(b.ts) - new Date(a.ts));

              // Cap
              const CAP = 200;
              if (merged.length > CAP) merged.length = CAP;

              setHistory(kind, merged);
            }

            merge("success", incomingSuccess);
            merge("fail", incomingFail);

            renderHistory();
            showOk("History imported successfully.");
          } catch (e) {
            errorDiv.textContent =
              "Import failed. Please choose a valid JSON export.\n\n" +
              (e && e.message ? e.message : String(e));
          }
        };
        reader.readAsText(file);
      }

      function clearActiveHistory() {
        setHistory(activeTab, []);
        renderHistory();
        showOk(`Cleared ${activeTab} history.`);
      }

      // ====== Main: Run SQL ======
      function runSQL() {
        clearOutput();

        if (!db) {
          errorDiv.textContent = "SQLite is still loading‚Ä¶ please wait.";
          return;
        }

        const sql = sqlInput.value;
        const sqlNorm = normalizeSQL(sql);

        if (!sqlNorm) {
          errorDiv.textContent = "Please type a SQL query first.";
          return;
        }

        try {
          const results = db.exec(sql);

          // Store successful query (even if no rows)
          addToHistory("success", {
            sql,
            sqlNorm,
            ts: nowISO(),
          });

          // Render results
          if (!results || results.length === 0) {
            showOk("Query executed successfully (no rows returned).");
            lastResultForCSV = null;
            downloadCsvBtn.disabled = true;
            renderHistory();
            return;
          }

          // Render all result sets
          results.forEach((res, i) => renderResultSet(res, i));

          // Save last SELECT result for CSV (use the last result set)
          const last = results[results.length - 1];
          lastResultForCSV = {
            columns: last.columns || [],
            values: last.values || [],
            filenameHint: suggestCSVFilename(sqlNorm),
          };
          downloadCsvBtn.disabled = false;

          renderHistory();
        } catch (err) {
          const msg = err && err.message ? err.message : String(err);
          errorDiv.textContent = msg;

          // Store unsuccessful query (no repeats)
          addToHistory("fail", {
            sql,
            sqlNorm,
            ts: nowISO(),
            error: msg,
          });

          lastResultForCSV = null;
          downloadCsvBtn.disabled = true;

          renderHistory();
        }
      }

      // ====== Events ======
      runBtn.addEventListener("click", runSQL);

      resetBtn.addEventListener("click", () => {
        clearOutput();
        if (!db) return;
        try {
          db.close();
        } catch (_) {}
        createFreshDB();
        lastResultForCSV = null;
        downloadCsvBtn.disabled = true;
        showOk("Database reset. Try running a query.");
      });

      downloadCsvBtn.addEventListener("click", () => {
        clearOutput();
        if (!lastResultForCSV) {
          errorDiv.textContent = "No result available to export as CSV.";
          return;
        }
        const csv = toCSV(lastResultForCSV.columns, lastResultForCSV.values);
        downloadText(lastResultForCSV.filenameHint, csv, "text/csv");
        showOk(`Downloaded CSV: ${lastResultForCSV.filenameHint}`);
      });

      // Ctrl+Enter shortcut
      sqlInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && (e.ctrlKey || e.metaKey)) {
          e.preventDefault();
          runSQL();
        }
      });

      // Sample chips
      document.querySelectorAll(".chip").forEach((chip) => {
        chip.addEventListener("click", () => {
          const sql = chip.getAttribute("data-sql") || "";
          sqlInput.value = sql;
          sqlInput.focus();
        });
      });

      // Tabs
      tabSuccess.addEventListener("click", () => setActiveTab("success"));
      tabFail.addEventListener("click", () => setActiveTab("fail"));

      // Export/Import/Clear
      exportHistoryBtn.addEventListener("click", exportHistoryJSON);

      importHistoryBtn.addEventListener("click", () => importFile.click());

      importFile.addEventListener("change", () => {
        const file = importFile.files && importFile.files[0];
        if (!file) return;
        importHistoryJSON(file);
        importFile.value = ""; // allow re-import same file
      });

      clearHistoryBtn.addEventListener("click", clearActiveHistory);

      // ====== Init SQL.js ======
      setStatus(false);

      initSqlJs({
        locateFile: (file) =>
          `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`,
      })
        .then((SQL) => {
          SQLlib = SQL;
          createFreshDB();
          setStatus(true);
          renderHistory(); // load from localStorage on start
          runSQL(); // auto-run initial query
        })
        .catch((e) => {
          setStatus(false);
          errorDiv.textContent =
            "Failed to load SQL.js. Check internet/CDN access.\n\n" +
            (e && e.message ? e.message : String(e));
        });
    </script>

    <!-- Optional project scripts (non-blocking for core demo) -->
    <script src="https://programmer-s-picnic.github.io/json-images/find-on-page.js" defer></script>
    <script src="https://programmer-s-picnic.github.io/json-images/imgshow.js" defer></script>
    <script src="https://programmer-s-picnic.github.io/json-images/hometag.js" defer></script>
  </body>
</html>
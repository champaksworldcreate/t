<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Animation Lab ‚Äî Interactive Learning (CSS + JS + SVG)</title>
  <meta name="description" content="A complete interactive web page to learn animation: transitions, keyframes, easing, transforms, requestAnimationFrame, SVG, mini quizzes, and exercises." />
  <style>
    :root{
      /* Light saffron theme */
      --bg:#fff7e6;
      --card:#ffffff;
      --ink:#1f2937;
      --muted:#6b7280;
      --brand:#d97706;
      --brand2:#f59e0b;
      --border:#eadcc5;
      --shadow:0 18px 45px rgba(15,23,42,.10);
      --good:#16a34a;
      --bad:#dc2626;
      --warn:#b45309;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
      --radius: 18px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--ink);
      background:
        radial-gradient(1000px 600px at 10% 0%, rgba(245,158,11,.30), transparent 60%),
        radial-gradient(900px 500px at 90% 10%, rgba(217,119,6,.22), transparent 55%),
        linear-gradient(180deg, var(--bg), #fffaf2 65%, #fff);
    }
    a{ color:var(--brand); text-decoration:none; }
    a:hover{ text-decoration:underline; }
    .wrap{ max-width:1200px; margin:0 auto; padding:18px 14px 48px; }

    /* Header */
    header{
      display:flex; gap:14px; align-items:center; justify-content:space-between;
      padding:14px 14px;
      border:1px solid var(--border);
      background:linear-gradient(180deg, #fff, #fff6df);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      position:sticky; top:10px; z-index:50;
      backdrop-filter: blur(10px);
    }
    .brand{
      display:flex; align-items:center; gap:12px; min-width:280px;
    }
    .logo{
      width:44px; height:44px; border-radius:14px;
      background: conic-gradient(from 180deg, var(--brand2), var(--brand), #fbbf24, var(--brand2));
      box-shadow: 0 12px 25px rgba(217,119,6,.25);
      position:relative;
    }
    .logo:after{
      content:"";
      position:absolute; inset:11px 10px 12px 12px;
      border-radius:12px;
      background:linear-gradient(135deg, rgba(255,255,255,.95), rgba(255,255,255,.55));
    }
    .titlebox{ line-height:1.1; }
    .titlebox h1{ margin:0; font-size:16px; letter-spacing:.2px; }
    .titlebox p{ margin:4px 0 0; font-size:12px; color:var(--muted); }

    .top-actions{
      display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; align-items:center;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:9px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      box-shadow: 0 10px 25px rgba(15,23,42,.06);
      font-size:12px;
      color:var(--muted);
      user-select:none;
    }
    .btn{
      border:1px solid var(--border);
      background: linear-gradient(180deg, #fff, #fff7e6);
      color:var(--ink);
      padding:9px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:650;
      font-size:12px;
      box-shadow: 0 12px 25px rgba(15,23,42,.06);
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
      user-select:none;
    }
    .btn:hover{ transform: translateY(-1px); border-color:#f3c58d; box-shadow: 0 18px 40px rgba(15,23,42,.08); }
    .btn:active{ transform: translateY(0px) scale(.99); }
    .btn.primary{
      border-color: rgba(217,119,6,.35);
      background: linear-gradient(180deg, rgba(245,158,11,.25), rgba(217,119,6,.15));
    }
    .btn.danger{
      border-color: rgba(220,38,38,.35);
      background: linear-gradient(180deg, rgba(220,38,38,.10), rgba(220,38,38,.06));
    }
    .toggle{
      display:inline-flex; align-items:center; gap:8px;
      padding:9px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      font-weight:650;
      font-size:12px;
      user-select:none;
    }
    .toggle input{ accent-color: var(--brand); }

    /* Layout */
    .grid{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:14px;
      margin-top:14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      header{ position:relative; top:auto; }
      .brand{ min-width:auto; }
    }

    .card{
      border:1px solid var(--border);
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:12px 14px;
      border-bottom:1px solid var(--border);
      background: linear-gradient(180deg, #fff, #fff7e6);
      display:flex; justify-content:space-between; align-items:center; gap:10px;
    }
    .card .hd h2{
      margin:0;
      font-size:14px;
      letter-spacing:.2px;
    }
    .card .hd .meta{
      font-size:12px; color:var(--muted);
      display:flex; align-items:center; gap:10px;
    }
    .card .bd{ padding:14px; }

    /* Sidebar */
    .nav{
      display:flex; flex-direction:column; gap:10px;
    }
    .nav .section{
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .nav .tab{
      flex: 1 1 140px;
      text-align:left;
      padding:10px 10px;
      border-radius:14px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      transition: transform .12s ease, border-color .12s ease, box-shadow .12s ease;
      box-shadow: 0 10px 22px rgba(15,23,42,.06);
      user-select:none;
    }
    .nav .tab:hover{ transform: translateY(-1px); border-color:#f3c58d; box-shadow: 0 16px 34px rgba(15,23,42,.08); }
    .nav .tab.active{
      border-color: rgba(217,119,6,.45);
      background: linear-gradient(180deg, rgba(245,158,11,.20), rgba(217,119,6,.10));
    }
    .small{
      font-size:12px; color:var(--muted); line-height:1.45;
    }
    .kpi{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    .tile{
      border:1px solid var(--border);
      border-radius:16px;
      padding:10px;
      background: linear-gradient(180deg, #fff, #fffaf2);
    }
    .tile b{ font-size:12px; }
    .tile div{ margin-top:6px; font-size:12px; color:var(--muted); }

    /* Controls */
    .controls{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 980px){
      .controls{ grid-template-columns: 1fr; }
    }

    .field{
      border:1px solid var(--border);
      border-radius:16px;
      padding:10px;
      background: #fff;
    }
    .field label{
      display:flex; justify-content:space-between; align-items:baseline; gap:10px;
      font-size:12px; font-weight:750;
      margin-bottom:6px;
    }
    .field label span{ color:var(--muted); font-weight:650; }
    input[type="range"]{ width:100%; }
    input[type="number"], select, input[type="text"]{
      width:100%;
      padding:9px 10px;
      border-radius:12px;
      border:1px solid var(--border);
      outline:none;
      font-family:var(--sans);
      background: #fff;
    }
    input[type="number"]:focus, select:focus, input[type="text"]:focus{
      border-color:#f3c58d;
      box-shadow: 0 0 0 4px rgba(245,158,11,.15);
    }
    .row{
      display:flex; gap:8px; flex-wrap:wrap;
      align-items:center;
    }
    .row > *{ flex: 1 1 auto; }

    /* Playground */
    .playground{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
      align-items:stretch;
    }
    @media (max-width: 1100px){
      .playground{ grid-template-columns: 1fr; }
    }
    .stageWrap{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .stage{
      position:relative;
      height:360px;
      border-radius: 22px;
      border:1px dashed rgba(217,119,6,.45);
      background:
        radial-gradient(700px 220px at 20% 15%, rgba(245,158,11,.18), transparent 60%),
        radial-gradient(700px 220px at 80% 25%, rgba(217,119,6,.10), transparent 62%),
        linear-gradient(180deg, #fff, #fffaf2);
      overflow:hidden;
    }

    .gridlines{
      position:absolute; inset:0;
      background:
        linear-gradient(to right, rgba(31,41,55,.05) 1px, transparent 1px) 0 0 / 24px 24px,
        linear-gradient(to bottom, rgba(31,41,55,.05) 1px, transparent 1px) 0 0 / 24px 24px;
      pointer-events:none;
      opacity:.7;
    }

    .sprite{
      --x: 40;
      --y: 40;
      --size: 64;
      --rot: 0;
      --scale: 1;
      --skewX: 0;
      --skewY: 0;
      --blur: 0;
      --hue: 0;
      --opacity: 1;

      position:absolute;
      left: calc(var(--x) * 1px);
      top: calc(var(--y) * 1px);
      width: calc(var(--size) * 1px);
      height: calc(var(--size) * 1px);
      border-radius: 22px;
      background: conic-gradient(from 180deg, var(--brand2), var(--brand), #fbbf24, var(--brand2));
      box-shadow: 0 18px 35px rgba(217,119,6,.22);
      transform:
        rotate(calc(var(--rot) * 1deg))
        scale(var(--scale))
        skew(calc(var(--skewX) * 1deg), calc(var(--skewY) * 1deg));
      filter:
        blur(calc(var(--blur) * 1px))
        hue-rotate(calc(var(--hue) * 1deg));
      opacity: var(--opacity);
      will-change: transform, left, top, filter, opacity;
      display:grid; place-items:center;
      user-select:none;
      touch-action:none;
    }
    .sprite:after{
      content:"";
      width: 22px; height:22px;
      border-radius: 10px;
      background: rgba(255,255,255,.85);
      box-shadow: inset 0 -10px 14px rgba(15,23,42,.08);
    }
    .spriteLabel{
      position:absolute; left:14px; bottom:12px;
      font-size:12px; color: var(--muted);
      background: rgba(255,255,255,.75);
      border:1px solid var(--border);
      padding:7px 10px;
      border-radius: 999px;
      backdrop-filter: blur(6px);
    }

    .hud{
      display:flex; gap:8px; flex-wrap:wrap;
      align-items:center; justify-content:space-between;
    }
    .hud .left, .hud .right{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
    }
    .chip{
      display:inline-flex; align-items:center; gap:6px;
      border:1px solid var(--border);
      background:#fff;
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      user-select:none;
    }
    .chip b{ color:var(--ink); font-weight:800; }
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(217,119,6,.25);
      background: rgba(245,158,11,.12);
      font-size:12px;
      color:#7c2d12;
      user-select:none;
    }

    /* Code blocks */
    pre{
      margin:0;
      padding:12px;
      border-radius: 16px;
      border:1px solid var(--border);
      background: #0b1220;
      color:#e5e7eb;
      overflow:auto;
      font-family: var(--mono);
      font-size:12px;
      line-height:1.55;
    }
    .codeTools{
      display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;
      margin-bottom:8px;
    }
    .miniBtn{
      border:1px solid var(--border);
      background: #fff;
      border-radius: 12px;
      padding:8px 10px;
      font-size:12px;
      cursor:pointer;
      user-select:none;
      box-shadow: 0 10px 20px rgba(15,23,42,.06);
    }
    .miniBtn:hover{ border-color:#f3c58d; }
    .twoCol{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 980px){
      .twoCol{ grid-template-columns: 1fr; }
    }

    /* Quiz / Notes */
    .note{
      border:1px solid var(--border);
      background: linear-gradient(180deg, #fff, #fffaf2);
      border-radius: 16px;
      padding:10px;
      color:var(--muted);
      font-size:12px;
      line-height:1.5;
    }
    .qa{
      border:1px solid var(--border);
      border-radius:16px;
      padding:10px;
      background:#fff;
      margin-top:10px;
    }
    .qa h3{
      margin:0 0 8px;
      font-size:13px;
    }
    .opt{
      display:flex; gap:10px; align-items:flex-start;
      padding:8px 10px;
      border:1px solid var(--border);
      border-radius: 14px;
      margin-top:8px;
      background: #fff;
      cursor:pointer;
      user-select:none;
    }
    .opt input{ margin-top:2px; }
    .result{
      margin-top:10px;
      font-size:12px;
      padding:10px;
      border-radius: 16px;
      border:1px solid var(--border);
      background:#fff;
    }
    .ok{ border-color: rgba(22,163,74,.35); background: rgba(22,163,74,.08); color:#065f46; }
    .no{ border-color: rgba(220,38,38,.35); background: rgba(220,38,38,.08); color:#7f1d1d; }

    /* Timeline */
    .timeline{
      border:1px solid var(--border);
      border-radius: 16px;
      background:#fff;
      padding:10px;
    }
    .bar{
      height:14px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: linear-gradient(90deg, rgba(245,158,11,.2), rgba(217,119,6,.12));
      overflow:hidden;
      position:relative;
    }
    .bar > i{
      display:block;
      height:100%;
      width: 0%;
      background: linear-gradient(90deg, rgba(217,119,6,.85), rgba(245,158,11,.65));
      border-radius: 999px;
    }
    .barMarker{
      position:absolute;
      top:-4px;
      width:2px;
      height:22px;
      background: rgba(31,41,55,.35);
      left: 0%;
      transform: translateX(-1px);
    }

    /* SVG */
    .svgStage{
      width:100%;
      height:220px;
      border-radius: 22px;
      border:1px dashed rgba(217,119,6,.45);
      background: linear-gradient(180deg, #fff, #fffaf2);
      overflow:hidden;
    }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce){
      *{ scroll-behavior:auto !important; transition:none !important; animation:none !important; }
    }

    /* Toast */
    .toast{
      position:fixed;
      right:14px;
      bottom:14px;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.9);
      backdrop-filter: blur(8px);
      box-shadow: 0 18px 40px rgba(15,23,42,.12);
      font-size:12px;
      color:var(--muted);
      max-width: 360px;
      opacity:0;
      transform: translateY(8px);
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      z-index: 999;
    }
    .toast.show{ opacity:1; transform: translateY(0); }
    .kbd{
      font-family: var(--mono);
      font-size:11px;
      padding:2px 6px;
      border-radius:8px;
      border:1px solid var(--border);
      background:#fff;
      color:var(--ink);
    }

    /* Sections */
    .panel{ display:none; }
    .panel.active{ display:block; }

    /* Inline help tables */
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius: 16px;
      border:1px solid var(--border);
      background:#fff;
      font-size:12px;
    }
    th, td{ padding:10px; border-bottom:1px solid var(--border); vertical-align:top; }
    th{
      text-align:left;
      background: linear-gradient(180deg, #fff, #fff7e6);
      font-weight:800;
    }
    tr:last-child td{ border-bottom:none; }
    .muted{ color:var(--muted); }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="titlebox">
          <h1>Animation Lab</h1>
          <p>Learn animation by building it: <b>CSS</b> + <b>JS</b> + <b>SVG</b> playground, quizzes, and exercises.</p>
        </div>
      </div>

      <div class="top-actions">
        <span class="pill">Tip: drag the square in the stage ‚Ä¢ <span class="kbd">Space</span> play/pause</span>
        <button class="btn" id="btnReset">Reset</button>
        <button class="btn primary" id="btnPlay">Play</button>
        <button class="btn danger" id="btnStop">Stop</button>
        <label class="toggle" title="Honor reduced motion by slowing effects.">
          <input type="checkbox" id="reduceMotion">
          Reduce Motion
        </label>
      </div>
    </header>

    <div class="grid">
      <!-- Left / Sidebar -->
      <div class="card">
        <div class="hd">
          <h2>Learn</h2>
          <div class="meta"><span class="badge" id="modeBadge">Mode: CSS Keyframes</span></div>
        </div>
        <div class="bd nav">
          <div class="section" role="tablist" aria-label="Learning sections">
            <button class="tab active" data-tab="play">üéõÔ∏è Playground</button>
            <button class="tab" data-tab="basics">üìö Basics</button>
            <button class="tab" data-tab="easing">üìà Easing</button>
            <button class="tab" data-tab="raf">‚öôÔ∏è requestAnimationFrame</button>
            <button class="tab" data-tab="svg">üß© SVG Motion</button>
            <button class="tab" data-tab="quiz">üß† Mini Quiz</button>
            <button class="tab" data-tab="ex">‚úÖ Exercises</button>
          </div>

          <div class="note" id="quickHelp">
            <b>What you‚Äôll learn here</b><br/>
            ‚Ä¢ Transitions vs Keyframes<br/>
            ‚Ä¢ Timing functions (easing) & durations<br/>
            ‚Ä¢ Transform stack: translate/rotate/scale/skew<br/>
            ‚Ä¢ JS animation loop (requestAnimationFrame)<br/>
            ‚Ä¢ SVG stroke & path animations<br/>
            <div style="margin-top:8px">
              <b>Shortcuts:</b>
              <div class="small">
                <span class="kbd">Space</span> play/pause ‚Ä¢
                <span class="kbd">R</span> reset ‚Ä¢
                <span class="kbd">C</span> copy code
              </div>
            </div>
          </div>

          <div class="kpi">
            <div class="tile">
              <b>FPS</b>
              <div><span id="fpsOut">‚Äî</span></div>
            </div>
            <div class="tile">
              <b>Time</b>
              <div><span id="timeOut">0.00</span>s</div>
            </div>
            <div class="tile">
              <b>Progress</b>
              <div><span id="progOut">0</span>%</div>
            </div>
            <div class="tile">
              <b>Engine</b>
              <div><span id="engineOut">CSS</span></div>
            </div>
          </div>

          <div class="note" style="margin-top:10px">
            <b>Concept Map</b><br/>
            <span class="muted">
              <b>Motion</b> = changing values over time.<br/>
              CSS handles many motions automatically; JS gives full control.
              The key is: choose the right tool for the job.
            </span>
          </div>
        </div>
      </div>

      <!-- Right / Main -->
      <div class="card">
        <div class="hd">
          <h2 id="panelTitle">Playground</h2>
          <div class="meta">
            <span class="chip" title="Current animation mode">
              <span>Mode</span> <b id="modeOut">CSS Keyframes</b>
            </span>
            <span class="chip" title="Current easing">
              <span>Easing</span> <b id="easeOut">ease-in-out</b>
            </span>
          </div>
        </div>

        <div class="bd">
          <!-- Playground Panel -->
          <section class="panel active" id="panel-play">
            <div class="playground">
              <!-- Stage + timeline -->
              <div class="stageWrap">
                <div class="hud">
                  <div class="left">
                    <span class="chip">Target: <b>Square</b></span>
                    <span class="chip">Drag: <b>On</b></span>
                    <span class="chip">Loop: <b id="loopOut">On</b></span>
                  </div>
                  <div class="right">
                    <label class="toggle" title="Loop the animation after it ends">
                      <input type="checkbox" id="loopToggle" checked>
                      Loop
                    </label>
                    <label class="toggle" title="Show grid lines on the stage">
                      <input type="checkbox" id="gridToggle" checked>
                      Grid
                    </label>
                  </div>
                </div>

                <div class="stage" id="stage" aria-label="Animation stage">
                  <div class="gridlines" id="gridlines"></div>
                  <div class="sprite" id="sprite" role="img" aria-label="Animated square"></div>
                  <div class="spriteLabel" id="spriteLabel">x: <b id="xyOut">40, 40</b> ‚Ä¢ transform: <b id="tOut">rotate(0) scale(1)</b></div>
                </div>

                <div class="timeline" aria-label="Timeline">
                  <div class="row" style="justify-content:space-between">
                    <div class="small">
                      <b>Timeline</b> ‚Äî watch progress; compare easing types.
                    </div>
                    <div class="small">
                      Duration: <b id="durText">1.20</b>s ‚Ä¢ Delay: <b id="delayText">0.00</b>s
                    </div>
                  </div>
                  <div style="margin-top:8px; position:relative;">
                    <div class="bar" aria-hidden="true">
                      <i id="barFill"></i>
                    </div>
                    <div class="barMarker" id="barMarker"></div>
                  </div>
                  <div class="row" style="margin-top:10px;">
                    <button class="btn" id="btnStepBack" title="Back 10%">‚ü≤ -10%</button>
                    <button class="btn" id="btnStepFwd" title="Forward 10%">‚ü≥ +10%</button>
                    <button class="btn" id="btnSnapStart" title="Jump to 0%">‚èÆ Start</button>
                    <button class="btn" id="btnSnapEnd" title="Jump to 100%">‚è≠ End</button>
                  </div>
                </div>
              </div>

              <!-- Controls + code -->
              <div>
                <div class="twoCol">
                  <div class="field">
                    <label>Engine <span>CSS / JS</span></label>
                    <select id="engine">
                      <option value="cssKeyframes">CSS Keyframes</option>
                      <option value="cssTransition">CSS Transition</option>
                      <option value="jsRaf">JavaScript (requestAnimationFrame)</option>
                    </select>
                    <div class="small" style="margin-top:8px">
                      <b>Keyframes:</b> multi-step motions.<br/>
                      <b>Transition:</b> animate between states.<br/>
                      <b>JS:</b> physics, games, custom timelines.
                    </div>
                  </div>

                  <div class="field">
                    <label>Easing <span>timing function</span></label>
                    <select id="easing">
                      <option value="linear">linear</option>
                      <option value="ease">ease</option>
                      <option value="ease-in">ease-in</option>
                      <option value="ease-out">ease-out</option>
                      <option value="ease-in-out" selected>ease-in-out</option>
                      <option value="cubic-bezier(0.22, 1, 0.36, 1)">cubic-bezier(0.22,1,0.36,1) (smooth)</option>
                      <option value="cubic-bezier(0.16, 1, 0.3, 1)">cubic-bezier(0.16,1,0.3,1) (snappy)</option>
                      <option value="steps(6, end)">steps(6,end)</option>
                    </select>
                    <div class="small" style="margin-top:8px">
                      Tip: pick a cubic-bezier for UI motion; use steps for pixel-art / counters.
                    </div>
                  </div>
                </div>

                <div style="height:10px"></div>

                <div class="controls">
                  <div class="field">
                    <label>Duration <span><b id="durOut">1.20</b>s</span></label>
                    <input type="range" id="duration" min="0.1" max="6" step="0.05" value="1.2" />
                  </div>

                  <div class="field">
                    <label>Delay <span><b id="delayOut">0.00</b>s</span></label>
                    <input type="range" id="delay" min="0" max="2.5" step="0.05" value="0" />
                  </div>

                  <div class="field">
                    <label>Distance <span><b id="distOut">240</b>px</span></label>
                    <input type="range" id="distance" min="0" max="520" step="2" value="240" />
                  </div>

                  <div class="field">
                    <label>Rotation <span><b id="rotOut">180</b>¬∞</span></label>
                    <input type="range" id="rotation" min="-720" max="720" step="5" value="180" />
                  </div>

                  <div class="field">
                    <label>Scale <span><b id="scaleOut">1.10</b>x</span></label>
                    <input type="range" id="scale" min="0.2" max="2.2" step="0.01" value="1.1" />
                  </div>

                  <div class="field">
                    <label>Opacity <span><b id="opOut">1.00</b></span></label>
                    <input type="range" id="opacity" min="0.1" max="1" step="0.01" value="1" />
                  </div>

                  <div class="field">
                    <label>Blur <span><b id="blurOut">0</b>px</span></label>
                    <input type="range" id="blur" min="0" max="12" step="0.25" value="0" />
                  </div>

                  <div class="field">
                    <label>Hue Rotate <span><b id="hueOut">0</b>¬∞</span></label>
                    <input type="range" id="hue" min="0" max="360" step="1" value="0" />
                  </div>

                  <div class="field">
                    <label>Keyframe Steps <span><b id="kfOut">3</b></span></label>
                    <input type="range" id="keySteps" min="2" max="6" step="1" value="3" />
                    <div class="small" style="margin-top:8px">
                      Applies in <b>CSS Keyframes</b> mode: adds intermediate keyframes automatically.
                    </div>
                  </div>

                  <div class="field">
                    <label>Path Type <span>motion pattern</span></label>
                    <select id="pathType">
                      <option value="line">Line</option>
                      <option value="arc" selected>Arc</option>
                      <option value="zigzag">Zigzag</option>
                      <option value="bounce">Bounce</option>
                    </select>
                    <div class="small" style="margin-top:8px">
                      Try <b>Arc</b> with ease-in-out for a natural feel.
                    </div>
                  </div>
                </div>

                <div style="height:12px"></div>

                <div class="card" style="box-shadow:none;">
                  <div class="hd">
                    <h2 style="font-size:13px; margin:0;">Generated Code</h2>
                    <div class="meta">Click copy, then paste into your project</div>
                  </div>
                  <div class="bd">
                    <div class="codeTools">
                      <button class="miniBtn" id="btnCopy"><b>Copy</b> code</button>
                      <button class="miniBtn" id="btnDownload">Download HTML</button>
                      <button class="miniBtn" id="btnExplain">Explain code</button>
                    </div>

                    <pre id="codeOut"></pre>

                    <div class="note" id="explainBox" style="margin-top:10px; display:none;">
                      <b>What this code does</b>
                      <div class="small" id="explainText" style="margin-top:6px;"></div>
                    </div>
                  </div>
                </div>

              </div>
            </div>
          </section>

          <!-- Basics Panel -->
          <section class="panel" id="panel-basics">
            <div class="note">
              <b>Animation basics (quick, practical)</b><br/>
              <span class="muted">
                Use <b>transform</b> and <b>opacity</b> for smooth animations (usually GPU-friendly).
                Avoid animating layout properties like <b>top/left/width/height</b> for large UI motion when possible.
              </span>
            </div>

            <div style="height:12px"></div>

            <table aria-label="Animation cheat sheet">
              <thead>
                <tr>
                  <th>Concept</th>
                  <th>Use when</th>
                  <th>Example</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><b>Transition</b><br/><span class="muted">Animate state changes</span></td>
                  <td class="muted">Hover/focus, toggles, simple UI motion</td>
                  <td>
                    <pre>button{ transition: transform .2s ease; }
button:hover{ transform: translateY(-2px); }</pre>
                  </td>
                </tr>
                <tr>
                  <td><b>Keyframes</b><br/><span class="muted">Multi-step timeline</span></td>
                  <td class="muted">Loaders, repeated motion, choreographed sequences</td>
                  <td>
                    <pre>@keyframes floaty{
  0%{ transform: translateY(0); }
  50%{ transform: translateY(-10px); }
  100%{ transform: translateY(0); }
}
.card{ animation: floaty 2s ease-in-out infinite; }</pre>
                  </td>
                </tr>
                <tr>
                  <td><b>Easing</b><br/><span class="muted">Speed curve</span></td>
                  <td class="muted">Make movement feel natural (accelerate/decelerate)</td>
                  <td>
                    <pre>/* snappy but smooth */
transition-timing-function:
  cubic-bezier(0.16, 1, 0.3, 1);</pre>
                  </td>
                </tr>
                <tr>
                  <td><b>requestAnimationFrame</b><br/><span class="muted">JS animation loop</span></td>
                  <td class="muted">Games, physics, scroll-linked motion, custom timelines</td>
                  <td>
                    <pre>let t0;
function loop(t){
  if(!t0) t0=t;
  const p=Math.min(1,(t-t0)/800);
  el.style.transform=`translateX(${p*200}px)`;
  if(p&lt;1) requestAnimationFrame(loop);
}
requestAnimationFrame(loop);</pre>
                  </td>
                </tr>
              </tbody>
            </table>

            <div style="height:12px"></div>

            <div class="note">
              <b>Golden rules</b><br/>
              1) Prefer <b>transform</b> & <b>opacity</b>.<br/>
              2) Use <b>duration</b> ~ 150‚Äì300ms for micro-interactions (buttons, hover).<br/>
              3) Use easing: <b>ease-out</b> entering, <b>ease-in</b> leaving, or a good cubic-bezier for both.<br/>
              4) Respect users: use <code>prefers-reduced-motion</code>.
            </div>
          </section>

          <!-- Easing Panel -->
          <section class="panel" id="panel-easing">
            <div class="note">
              <b>Easing: the ‚Äúfeel‚Äù of motion</b><br/>
              Linear looks robotic for UI. Easing curves create acceleration and deceleration.
              Try switching easing in the Playground and watch how it changes the timeline.
            </div>

            <div style="height:12px"></div>

            <div class="twoCol">
              <div class="card" style="box-shadow:none;">
                <div class="hd"><h2 style="font-size:13px; margin:0;">Try cubic-bezier</h2><div class="meta">Adjust the four points</div></div>
                <div class="bd">
                  <div class="controls">
                    <div class="field">
                      <label>P1.x <span id="bx1o">0.16</span></label>
                      <input type="range" id="bx1" min="0" max="1" step="0.01" value="0.16">
                    </div>
                    <div class="field">
                      <label>P1.y <span id="by1o">1.00</span></label>
                      <input type="range" id="by1" min="0" max="1.5" step="0.01" value="1">
                    </div>
                    <div class="field">
                      <label>P2.x <span id="bx2o">0.30</span></label>
                      <input type="range" id="bx2" min="0" max="1" step="0.01" value="0.30">
                    </div>
                    <div class="field">
                      <label>P2.y <span id="by2o">1.00</span></label>
                      <input type="range" id="by2" min="0" max="1.5" step="0.01" value="1">
                    </div>
                  </div>
                  <div class="row" style="margin-top:10px">
                    <button class="btn primary" id="applyBezier">Apply to Playground</button>
                    <button class="btn" id="resetBezier">Reset</button>
                  </div>
                  <div class="note" style="margin-top:10px;">
                    Current: <b id="bezierText">cubic-bezier(0.16, 1, 0.3, 1)</b><br/>
                    <span class="muted">Tip: values above 1 in y can create a ‚Äúsnap‚Äù / overshoot feel.</span>
                  </div>
                </div>
              </div>

              <div class="card" style="box-shadow:none;">
                <div class="hd"><h2 style="font-size:13px; margin:0;">Easing examples</h2><div class="meta">When to use</div></div>
                <div class="bd">
                  <table>
                    <thead>
                      <tr><th>Easing</th><th>Feels like</th><th>Use for</th></tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td><b>ease-out</b></td>
                        <td class="muted">Fast start, gentle stop</td>
                        <td class="muted">Elements entering / appearing</td>
                      </tr>
                      <tr>
                        <td><b>ease-in</b></td>
                        <td class="muted">Slow start, fast end</td>
                        <td class="muted">Elements exiting / disappearing</td>
                      </tr>
                      <tr>
                        <td><b>ease-in-out</b></td>
                        <td class="muted">Smooth both ends</td>
                        <td class="muted">Larger movements, carousels</td>
                      </tr>
                      <tr>
                        <td><b>cubic-bezier(0.16,1,0.3,1)</b></td>
                        <td class="muted">Snappy but smooth</td>
                        <td class="muted">Modern UI micro-interactions</td>
                      </tr>
                      <tr>
                        <td><b>steps(n)</b></td>
                        <td class="muted">Jumps in chunks</td>
                        <td class="muted">Sprite sheets, counters, retro motion</td>
                      </tr>
                    </tbody>
                  </table>
                  <div class="note" style="margin-top:10px;">
                    Practice: choose <b>Arc</b> path + <b>ease-out</b>, then switch to <b>linear</b>. Notice how ‚Äúfloaty‚Äù motion becomes ‚Äúmechanical‚Äù.
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- rAF Panel -->
          <section class="panel" id="panel-raf">
            <div class="note">
              <b>JavaScript animation loop (requestAnimationFrame)</b><br/>
              rAF runs before the browser paints a new frame (usually ~60fps). You update values based on time,
              not frames, so the animation stays consistent on slower devices.
            </div>

            <div style="height:12px"></div>

            <div class="twoCol">
              <div class="card" style="box-shadow:none;">
                <div class="hd"><h2 style="font-size:13px; margin:0;">Time-based progress</h2><div class="meta">duration ‚Üí progress ‚Üí value</div></div>
                <div class="bd">
                  <pre>let start;
const duration = 900; // ms

function animate(t){
  if (!start) start = t;
  const elapsed = t - start;

  // progress in [0..1]
  const p = Math.min(1, elapsed / duration);

  // map progress to a value
  const x = 20 + p * 240;
  sprite.style.transform = `translateX(${x}px)`;

  if (p &lt; 1) requestAnimationFrame(animate);
}
requestAnimationFrame(animate);</pre>
                  <div class="note" style="margin-top:10px;">
                    Best practice: compute motion from <b>time</b>, not frame count. Frames can vary.
                  </div>
                </div>
              </div>

              <div class="card" style="box-shadow:none;">
                <div class="hd"><h2 style="font-size:13px; margin:0;">Easing in JS</h2><div class="meta">simple easing functions</div></div>
                <div class="bd">
                  <pre>// Common easing helpers:
const easeOutCubic = t => 1 - Math.pow(1 - t, 3);
const easeInOutQuad = t =>
  t &lt; 0.5 ? 2*t*t : 1 - Math.pow(-2*t + 2, 2)/2;

// Use:
const eased = easeOutCubic(p);
const x = 20 + eased * 240;</pre>
                  <div class="note" style="margin-top:10px;">
                    CSS cubic-bezier is great for UI. JS easings are great when you need custom curves or physics.
                  </div>
                </div>
              </div>
            </div>

            <div style="height:12px"></div>

            <div class="note">
              Want to <b>feel</b> the difference? Switch the Playground engine to <b>JavaScript (requestAnimationFrame)</b>.
              Then try <b>steps()</b> easing (it will be approximated) and compare with CSS.
            </div>
          </section>

          <!-- SVG Panel -->
          <section class="panel" id="panel-svg">
            <div class="note">
              <b>SVG animation</b><br/>
              SVG is perfect for icons, strokes, and paths. A common trick is animating <b>stroke-dashoffset</b> to ‚Äúdraw‚Äù a path.
            </div>

            <div style="height:12px"></div>

            <div class="svgStage">
              <svg viewBox="0 0 700 220" width="100%" height="100%" id="svgDemo" aria-label="SVG animation demo">
                <defs>
                  <linearGradient id="g1" x1="0" x2="1">
                    <stop offset="0%" stop-color="rgba(217,119,6,.95)"/>
                    <stop offset="100%" stop-color="rgba(245,158,11,.9)"/>
                  </linearGradient>
                  <filter id="soft">
                    <feDropShadow dx="0" dy="8" stdDeviation="6" flood-color="rgba(217,119,6,.25)"/>
                  </filter>
                </defs>

                <rect x="18" y="18" width="664" height="184" rx="26" fill="rgba(245,158,11,.08)" stroke="rgba(217,119,6,.20)"/>
                <path id="path" d="M 60 150 C 140 40, 260 40, 340 150 S 540 260, 640 90"
                  fill="none" stroke="url(#g1)" stroke-width="10" stroke-linecap="round" filter="url(#soft)"/>
                <circle id="dot" cx="60" cy="150" r="12" fill="white" stroke="rgba(217,119,6,.6)" stroke-width="5" filter="url(#soft)"/>
                <text x="34" y="42" font-size="14" fill="rgba(31,41,55,.75)" font-family="system-ui, sans-serif">SVG Path: draw + follow</text>
              </svg>
            </div>

            <div style="height:12px"></div>

            <div class="twoCol">
              <div class="card" style="box-shadow:none;">
                <div class="hd"><h2 style="font-size:13px; margin:0;">Controls</h2><div class="meta">draw + follow</div></div>
                <div class="bd">
                  <div class="controls">
                    <div class="field">
                      <label>SVG Duration <span><b id="svgDurOut">1.60</b>s</span></label>
                      <input type="range" id="svgDuration" min="0.3" max="6" step="0.05" value="1.6"/>
                    </div>
                    <div class="field">
                      <label>SVG Easing <span>CSS-like</span></label>
                      <select id="svgEase">
                        <option value="linear">linear</option>
                        <option value="ease-in-out" selected>ease-in-out</option>
                        <option value="ease-out">ease-out</option>
                        <option value="ease-in">ease-in</option>
                      </select>
                    </div>
                  </div>
                  <div class="row" style="margin-top:10px;">
                    <button class="btn primary" id="svgPlay">Play SVG</button>
                    <button class="btn" id="svgReset">Reset</button>
                  </div>
                  <div class="note" style="margin-top:10px;">
                    The path is ‚Äúdrawn‚Äù using dash offsets, and the dot follows the path using JS sampling.
                  </div>
                </div>
              </div>

              <div class="card" style="box-shadow:none;">
                <div class="hd"><h2 style="font-size:13px; margin:0;">SVG draw trick</h2><div class="meta">stroke-dasharray</div></div>
                <div class="bd">
                  <pre>const path = document.querySelector("path");
const len = path.getTotalLength();

// Hide stroke by using dash
path.style.strokeDasharray = len;
path.style.strokeDashoffset = len;

// Animate to 0 to draw
path.animate(
  [{ strokeDashoffset: len }, { strokeDashoffset: 0 }],
  { duration: 1400, easing: "ease-in-out", fill: "forwards" }
);</pre>
                  <div class="note" style="margin-top:10px;">
                    Try this for icon ‚Äúdraw-in‚Äù effects on page load.
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- Quiz Panel -->
          <section class="panel" id="panel-quiz">
            <div class="note">
              <b>Mini Quiz</b><br/>
              Answer, then check why. These are short but practical for real web UI animation.
            </div>

            <div class="qa" data-q="1">
              <h3>1) Which properties are generally best for smooth UI animations?</h3>
              <div class="opt"><input type="radio" name="q1" value="a"> <div>top / left</div></div>
              <div class="opt"><input type="radio" name="q1" value="b"> <div>width / height</div></div>
              <div class="opt"><input type="radio" name="q1" value="c"> <div><b>transform / opacity</b></div></div>
              <div class="opt"><input type="radio" name="q1" value="d"> <div>border / outline</div></div>
              <div class="result" id="r1" style="display:none;"></div>
            </div>

            <div class="qa" data-q="2">
              <h3>2) When should you use a CSS transition?</h3>
              <div class="opt"><input type="radio" name="q2" value="a"> <div>When you need a multi-step looping loader</div></div>
              <div class="opt"><input type="radio" name="q2" value="b"> <div><b>When animating between two states (hover/toggle)</b></div></div>
              <div class="opt"><input type="radio" name="q2" value="c"> <div>When you need physics and collisions</div></div>
              <div class="opt"><input type="radio" name="q2" value="d"> <div>When you need to draw SVG paths</div></div>
              <div class="result" id="r2" style="display:none;"></div>
            </div>

            <div class="qa" data-q="3">
              <h3>3) Why is requestAnimationFrame recommended for JS animations?</h3>
              <div class="opt"><input type="radio" name="q3" value="a"> <div>It runs exactly at 60fps always</div></div>
              <div class="opt"><input type="radio" name="q3" value="b"> <div>It skips time-based math</div></div>
              <div class="opt"><input type="radio" name="q3" value="c"> <div><b>It syncs updates with browser paint for smoother results</b></div></div>
              <div class="opt"><input type="radio" name="q3" value="d"> <div>It only works for transforms</div></div>
              <div class="result" id="r3" style="display:none;"></div>
            </div>

            <div class="row" style="margin-top:12px;">
              <button class="btn primary" id="gradeQuiz">Check answers</button>
              <button class="btn" id="resetQuiz">Reset quiz</button>
            </div>

            <div class="note" style="margin-top:12px;">
              Want harder quizzes (10‚Äì25 questions) in the same style? Tell me and I‚Äôll expand this page.
            </div>
          </section>

          <!-- Exercises Panel -->
          <section class="panel" id="panel-ex">
            <div class="note">
              <b>Exercises (do them in the Playground)</b><br/>
              Each exercise teaches a ‚Äúreal‚Äù animation skill. Try to match the goal, then copy the code.
            </div>

            <div style="height:12px"></div>

            <table aria-label="Exercises">
              <thead>
                <tr>
                  <th>Exercise</th>
                  <th>Goal</th>
                  <th>Suggested settings</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><b>1) Button hover</b></td>
                  <td class="muted">Make a fast micro-interaction that feels responsive</td>
                  <td class="muted">Engine: <b>Transition</b> ‚Ä¢ Duration: 0.18s ‚Ä¢ Easing: <b>cubic-bezier(0.16,1,0.3,1)</b> ‚Ä¢ Distance: 8‚Äì14px</td>
                </tr>
                <tr>
                  <td><b>2) Loader loop</b></td>
                  <td class="muted">Create a repeating motion that is not annoying</td>
                  <td class="muted">Engine: <b>Keyframes</b> ‚Ä¢ Duration: 1.2‚Äì2.2s ‚Ä¢ Easing: <b>ease-in-out</b> ‚Ä¢ Loop: On ‚Ä¢ Rotation: 360¬∞</td>
                </tr>
                <tr>
                  <td><b>3) Natural movement</b></td>
                  <td class="muted">Make motion feel like it has weight</td>
                  <td class="muted">Path: <b>Arc</b> or <b>Bounce</b> ‚Ä¢ Easing: <b>ease-out</b> (enter) ‚Ä¢ Add small scale (1.02‚Äì1.12)</td>
                </tr>
                <tr>
                  <td><b>4) Step animation</b></td>
                  <td class="muted">Create ‚Äúrobotic‚Äù or pixel-style movement</td>
                  <td class="muted">Easing: <b>steps(6,end)</b> ‚Ä¢ Duration: 1‚Äì2s ‚Ä¢ Distance: 200‚Äì320px</td>
                </tr>
                <tr>
                  <td><b>5) JS timeline</b></td>
                  <td class="muted">Animate multiple properties with precise control</td>
                  <td class="muted">Engine: <b>JS (rAF)</b> ‚Ä¢ Try Bounce path ‚Ä¢ Make blur/hue change over time</td>
                </tr>
              </tbody>
            </table>

            <div style="height:12px"></div>

            <div class="note">
              <b>Challenge</b><br/>
              Build a ‚Äútoast notification‚Äù animation: slide in from the bottom, overshoot slightly, then settle.
              Use either a cubic-bezier or a JS easing function.
            </div>
          </section>
        </div>
      </div>
    </div>

    <div class="toast" id="toast" role="status" aria-live="polite"></div>
  </div>

  <script>
    (() => {
      // ---------- Helpers ----------
      const $ = (sel, root=document) => root.querySelector(sel);
      const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
      const clamp = (v, a, b) => Math.min(b, Math.max(a, v));
      const fmt = (n, d=2) => Number(n).toFixed(d);
      const now = () => performance.now();

      const toastEl = $("#toast");
      let toastTimer = null;
      function toast(msg){
        toastEl.textContent = msg;
        toastEl.classList.add("show");
        clearTimeout(toastTimer);
        toastTimer = setTimeout(() => toastEl.classList.remove("show"), 1600);
      }

      function download(filename, text){
        const blob = new Blob([text], {type:"text/html;charset=utf-8"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(()=>URL.revokeObjectURL(url), 800);
      }

      // ---------- State ----------
      const state = {
        engine: "cssKeyframes", // cssKeyframes | cssTransition | jsRaf
        easing: "ease-in-out",
        duration: 1.2,
        delay: 0,
        distance: 240,
        rotation: 180,
        scale: 1.1,
        opacity: 1,
        blur: 0,
        hue: 0,
        keySteps: 3,
        pathType: "arc",
        loop: true,
        grid: true,
        reduceMotion: false,

        // timeline control
        progress: 0, // 0..1 (when scrubbed/stepped)
        playing: false,
        startedAt: 0,
        pausedAt: 0,

        // metrics
        fps: 0,
        frameCount: 0,
        lastFpsT: 0
      };

      // ---------- Elements ----------
      const engineSel = $("#engine");
      const easingSel = $("#easing");
      const durR = $("#duration");
      const delayR = $("#delay");
      const distR = $("#distance");
      const rotR = $("#rotation");
      const scaleR = $("#scale");
      const opR = $("#opacity");
      const blurR = $("#blur");
      const hueR = $("#hue");
      const keyStepsR = $("#keySteps");
      const pathSel = $("#pathType");

      const sprite = $("#sprite");
      const stage = $("#stage");

      const btnPlay = $("#btnPlay");
      const btnStop = $("#btnStop");
      const btnReset = $("#btnReset");

      const loopToggle = $("#loopToggle");
      const gridToggle = $("#gridToggle");
      const reduceMotion = $("#reduceMotion");

      const barFill = $("#barFill");
      const barMarker = $("#barMarker");

      const modeOut = $("#modeOut");
      const modeBadge = $("#modeBadge");
      const easeOut = $("#easeOut");
      const engineOut = $("#engineOut");

      // readouts
      const durOut = $("#durOut");
      const delayOut = $("#delayOut");
      const distOut = $("#distOut");
      const rotOut = $("#rotOut");
      const scaleOut = $("#scaleOut");
      const opOut = $("#opOut");
      const blurOut = $("#blurOut");
      const hueOut = $("#hueOut");
      const kfOut = $("#kfOut");

      const durText = $("#durText");
      const delayText = $("#delayText");

      const fpsOut = $("#fpsOut");
      const timeOut = $("#timeOut");
      const progOut = $("#progOut");
      const loopOut = $("#loopOut");

      const xyOut = $("#xyOut");
      const tOut = $("#tOut");

      const codeOut = $("#codeOut");
      const btnCopy = $("#btnCopy");
      const btnDownload = $("#btnDownload");
      const btnExplain = $("#btnExplain");
      const explainBox = $("#explainBox");
      const explainText = $("#explainText");

      const btnStepBack = $("#btnStepBack");
      const btnStepFwd = $("#btnStepFwd");
      const btnSnapStart = $("#btnSnapStart");
      const btnSnapEnd = $("#btnSnapEnd");

      const panelTitle = $("#panelTitle");

      // Bezier controls
      const bx1 = $("#bx1"), by1 = $("#by1"), bx2 = $("#bx2"), by2 = $("#by2");
      const bx1o = $("#bx1o"), by1o = $("#by1o"), bx2o = $("#bx2o"), by2o = $("#by2o");
      const bezierText = $("#bezierText");
      const applyBezier = $("#applyBezier");
      const resetBezier = $("#resetBezier");

      // SVG demo
      const svgPlayBtn = $("#svgPlay");
      const svgResetBtn = $("#svgReset");
      const svgDuration = $("#svgDuration");
      const svgDurOut = $("#svgDurOut");
      const svgEase = $("#svgEase");
      const svgPath = $("#path");
      const svgDot = $("#dot");

      // Quiz
      const gradeQuiz = $("#gradeQuiz");
      const resetQuiz = $("#resetQuiz");

      // Tabs
      const tabs = $$(".tab");
      const panels = {
        play: $("#panel-play"),
        basics: $("#panel-basics"),
        easing: $("#panel-easing"),
        raf: $("#panel-raf"),
        svg: $("#panel-svg"),
        quiz: $("#panel-quiz"),
        ex: $("#panel-ex"),
      };

      // ---------- Motion models ----------
      function easeFunc(name){
        // For JS engine only; CSS engines use CSS timing functions.
        if (name.startsWith("steps(")) {
          // Rough steps approximation: steps(n,end)
          const m = name.match(/steps\((\d+)\s*,\s*(start|end)\s*\)/);
          if(!m) return t => t;
          const n = Math.max(1, parseInt(m[1],10));
          const mode = m[2];
          return t => {
            const step = mode === "start" ? Math.ceil(t*n)/n : Math.floor(t*n)/n;
            return clamp(step, 0, 1);
          };
        }
        const map = {
          "linear": t => t,
          "ease": t => t<0.5 ? 2*t*t : 1 - Math.pow(-2*t+2,2)/2, // approx ease
          "ease-in": t => t*t,
          "ease-out": t => 1 - Math.pow(1-t,2),
          "ease-in-out": t => t<0.5 ? 2*t*t : 1 - Math.pow(-2*t+2,2)/2
        };
        return map[name] || map["ease-in-out"];
      }

      function pathAt(p){
        // Returns {dx, dy} relative movement based on path type.
        const dist = state.distance;
        const t = clamp(p, 0, 1);

        if(state.pathType === "line"){
          return { dx: dist*t, dy: 0 };
        }
        if(state.pathType === "arc"){
          // Smooth arc: x moves forward, y follows a sine curve
          const y = -Math.sin(Math.PI * t) * Math.min(140, dist*0.35);
          return { dx: dist*t, dy: y };
        }
        if(state.pathType === "zigzag"){
          const amp = Math.min(90, dist*0.22);
          const z = Math.sin(t * Math.PI * 4) * amp;
          return { dx: dist*t, dy: z };
        }
        if(state.pathType === "bounce"){
          // Bounce-like: y has multiple decaying bounces
          const amp = Math.min(160, dist*0.45);
          const y = -Math.abs(Math.sin(t * Math.PI * 3.2)) * amp * (1 - t*0.55);
          return { dx: dist*t, dy: y };
        }
        return { dx: dist*t, dy: 0 };
      }

      // ---------- CSS engines ----------
      let activeAnim = null;

      function clearCssAnimation(){
        if(activeAnim){
          try{ activeAnim.cancel(); } catch(e){}
          activeAnim = null;
        }
        sprite.style.animation = "";
        sprite.style.transition = "";
      }

      function setBaseVisuals(){
        sprite.style.setProperty("--blur", state.blur);
        sprite.style.setProperty("--hue", state.hue);
        sprite.style.setProperty("--opacity", state.opacity);
      }

      function applySpriteAtProgress(p){
        // Always apply position/transform for scrubbing and for JS engine.
        const baseX = 40;
        const baseY = 40;
        const eased = (state.engine === "jsRaf") ? easeFunc(state.easing)(p) : p;
        const {dx, dy} = pathAt(eased);

        const x = baseX + dx;
        const y = baseY + dy;

        sprite.style.setProperty("--x", x);
        sprite.style.setProperty("--y", y);
        sprite.style.setProperty("--rot", state.rotation * eased);
        sprite.style.setProperty("--scale", 1 + (state.scale - 1) * eased);

        // keep label updated
        xyOut.textContent = `${Math.round(x)}, ${Math.round(y)}`;
        tOut.textContent = `rotate(${Math.round(state.rotation * eased)}) scale(${fmt(1 + (state.scale - 1)*eased, 2)})`;
      }

      function cssKeyframesPlay(fromProgress=0){
        clearCssAnimation();
        setBaseVisuals();

        const durMs = (state.duration * 1000) * (state.reduceMotion ? 1.6 : 1);
        const delayMs = (state.delay * 1000);

        // Build keyframes with N steps (including 0 and 1)
        const steps = clamp(state.keySteps, 2, 6);
        const frames = [];
        for(let i=0;i<steps;i++){
          const p = i/(steps-1);
          const easeP = p; // easing handled by animation easing overall
          const {dx, dy} = pathAt(easeP);
          const x = 40 + dx;
          const y = 40 + dy;
          const rot = state.rotation * p;
          const sc  = 1 + (state.scale - 1) * p;
          const op  = 1 + (state.opacity - 1) * p; // if opacity <1, fade a bit (optional)
          frames.push({
            offset: p,
            transform: `translate(${x}px, ${y}px) rotate(${rot}deg) scale(${sc})`,
            opacity: op
          });
        }

        // We'll animate via Web Animations API for easier scrubbing
        // (still "CSS-like": uses easing strings)
        sprite.style.transformOrigin = "center";
        sprite.style.left = "0px";
        sprite.style.top = "0px";

        activeAnim = sprite.animate(frames, {
          duration: durMs,
          delay: delayMs,
          easing: state.easing,
          iterations: state.loop ? Infinity : 1,
          fill: "both"
        });

        activeAnim.currentTime = (delayMs + fromProgress * durMs);
        if(state.playing) activeAnim.play(); else activeAnim.pause();
      }

      function cssTransitionPlay(){
        clearCssAnimation();
        setBaseVisuals();

        const dur = (state.duration) * (state.reduceMotion ? 1.6 : 1);
        const delay = state.delay;

        // Transition animates between current and target state.
        sprite.style.transition = `transform ${dur}s ${state.easing} ${delay}s, opacity ${dur}s ${state.easing} ${delay}s, filter ${dur}s ${state.easing} ${delay}s`;

        // Start from base
        sprite.style.left = "0px"; sprite.style.top = "0px";
        sprite.style.transform = `translate(40px, 40px) rotate(0deg) scale(1)`;
        sprite.style.opacity = "1";
        // Force reflow so transition starts cleanly
        sprite.getBoundingClientRect();

        // End state (use path at 1)
        const {dx, dy} = pathAt(1);
        const x = 40 + dx;
        const y = 40 + dy;
        sprite.style.transform = `translate(${x}px, ${y}px) rotate(${state.rotation}deg) scale(${state.scale})`;
        sprite.style.opacity = String(state.opacity);

        // Transition has no built-in "loop": we emulate loop by toggling
        if(state.loop){
          const totalMs = (dur + delay) * 1000;
          const cycle = () => {
            if(!state.playing) return;
            // toggle back then forward
            sprite.style.transform = `translate(40px, 40px) rotate(0deg) scale(1)`;
            sprite.style.opacity = "1";
            setTimeout(() => {
              if(!state.playing) return;
              sprite.getBoundingClientRect();
              sprite.style.transform = `translate(${x}px, ${y}px) rotate(${state.rotation}deg) scale(${state.scale})`;
              sprite.style.opacity = String(state.opacity);
            }, 30);
            setTimeout(cycle, totalMs + 40);
          };
          setTimeout(cycle, totalMs + 40);
        }
      }

      // ---------- JS rAF engine ----------
      let rafId = 0;
      let rafStart = 0;
      let rafPauseAccum = 0;

      function stopRaf(){
        if(rafId) cancelAnimationFrame(rafId);
        rafId = 0;
      }

      function rafLoop(t){
        // fps calc
        if(!state.lastFpsT) state.lastFpsT = t;
        state.frameCount++;
        if(t - state.lastFpsT >= 500){
          state.fps = Math.round((state.frameCount*1000)/(t - state.lastFpsT));
          state.frameCount = 0;
          state.lastFpsT = t;
        }

        const durMs = (state.duration*1000) * (state.reduceMotion ? 1.6 : 1);
        const delayMs = (state.delay*1000);
        const elapsed = t - rafStart - rafPauseAccum;

        let p;
        if(elapsed < delayMs){
          p = 0;
        } else {
          p = clamp((elapsed - delayMs) / durMs, 0, 1);
        }

        const eased = easeFunc(state.easing)(p);
        applySpriteAtProgress(eased);

        state.progress = p;
        updateTimeline();

        if(p >= 1){
          if(state.loop){
            // restart
            rafStart = t;
            rafPauseAccum = 0;
            state.progress = 0;
          } else {
            state.playing = false;
            updatePlayButtons();
            return;
          }
        }

        if(state.playing) rafId = requestAnimationFrame(rafLoop);
      }

      // ---------- Timeline UI ----------
      function updateTimeline(){
        const p = clamp(state.progress, 0, 1);
        barFill.style.width = `${p*100}%`;
        barMarker.style.left = `${p*100}%`;

        progOut.textContent = Math.round(p*100);
        timeOut.textContent = fmt(p * state.duration, 2);
        fpsOut.textContent = state.engine === "jsRaf" ? state.fps : "‚Äî";
      }

      function setProgress(p){
        state.progress = clamp(p, 0, 1);

        // For CSS keyframes (WAAPI) we can scrub currentTime
        if(state.engine === "cssKeyframes" && activeAnim){
          const durMs = (state.duration*1000) * (state.reduceMotion ? 1.6 : 1);
          const delayMs = (state.delay*1000);
          activeAnim.currentTime = delayMs + state.progress * durMs;
          activeAnim.pause();
        } else if(state.engine === "jsRaf"){
          // Just apply directly
          const eased = easeFunc(state.easing)(state.progress);
          applySpriteAtProgress(eased);
        } else {
          // transition cannot scrub; best effort: apply final pose based on progress
          const eased = state.progress;
          applySpriteAtProgress(eased);
        }

        updateTimeline();
      }

      // ---------- Code generation ----------
      function makeCode(){
        const dur = fmt(state.duration, 2);
        const delay = fmt(state.delay, 2);
        const ease = state.easing;
        const dist = Math.round(state.distance);
        const rot = Math.round(state.rotation);
        const sc = fmt(state.scale, 2);
        const op = fmt(state.opacity, 2);
        const blur = fmt(state.blur, 2);
        const hue = Math.round(state.hue);
        const path = state.pathType;
        const steps = clamp(state.keySteps,2,6);

        const commonCss = `:root{
  --brand:#d97706; --brand2:#f59e0b;
}
.box{
  width:64px; height:64px; border-radius:20px;
  background: conic-gradient(from 180deg, var(--brand2), var(--brand), #fbbf24, var(--brand2));
  box-shadow: 0 18px 35px rgba(217,119,6,.22);
  will-change: transform, opacity, filter;
}`;

        const pathComment = {
          line: "Line: straight motion in X",
          arc: "Arc: smooth sine wave in Y",
          zigzag: "Zigzag: alternating sine waves",
          bounce: "Bounce: absolute sine with decay"
        }[path] || "";

        const cssKeyframes = `<!-- CSS Keyframes example (generated) -->
<style>
${commonCss}

@keyframes moveBox{
  /* Path: ${path} ‚Äî ${pathComment} */
  0%   { transform: translate(40px, 40px) rotate(0deg) scale(1); opacity: 1; }
  50%  { transform: translate(${Math.round(40 + dist/2)}px, ${path==="arc" ? 0 : 40}px) rotate(${Math.round(rot/2)}deg) scale(${fmt(1 + (sc-1)/2, 2)}); }
  100% { transform: translate(${40+dist}px, 40px) rotate(${rot}deg) scale(${sc}); opacity: ${op}; }
}

.box{
  filter: blur(${blur}px) hue-rotate(${hue}deg);
  animation: moveBox ${dur}s ${ease} ${delay}s ${state.loop ? "infinite" : ""};
}
</style>

<div class="box"></div>`;

        const cssTransition = `<!-- CSS Transition example (generated) -->
<style>
${commonCss}
.box{
  filter: blur(${blur}px) hue-rotate(${hue}deg);
  transition: transform ${dur}s ${ease} ${delay}s, opacity ${dur}s ${ease} ${delay}s;
}
.box.is-on{
  transform: translate(${40+dist}px, 40px) rotate(${rot}deg) scale(${sc});
  opacity: ${op};
}
</style>

<button id="toggle">Toggle</button>
<div class="box" id="box" style="transform: translate(40px, 40px) rotate(0deg) scale(1);"></div>

<script>
const box = document.querySelector("#box");
document.querySelector("#toggle").onclick = () => box.classList.toggle("is-on");
<\/script>`;

        const jsRaf = `<!-- JavaScript requestAnimationFrame example (generated) -->
<style>
${commonCss}
#stage{ position:relative; height:220px; border:1px dashed rgba(217,119,6,.45); border-radius:18px; background:#fff; overflow:hidden; }
.box{ position:absolute; left:0; top:0; filter: blur(${blur}px) hue-rotate(${hue}deg); }
</style>

<div id="stage"><div class="box" id="box"></div></div>

<script>
const box = document.querySelector("#box");

// Easing (approx for "${ease}")
const ease = ${ease.startsWith("steps(") ? `((t)=>{ const n=${parseInt((ease.match(/steps\\((\\d+)/)||["",6])[1],10)}; return Math.floor(t*n)/n; })` :
(ease==="linear" ? "(t)=>t" :
(ease==="ease-in" ? "(t)=>t*t" :
(ease==="ease-out" ? "(t)=>1-Math.pow(1-t,2)" :
"(t)=>t<0.5?2*t*t:1-Math.pow(-2*t+2,2)/2")))};

const duration = ${Math.round(state.duration*1000)}; // ms
const delay = ${Math.round(state.delay*1000)}; // ms

function pathAt(p){
  const dist=${dist};
  const t=Math.max(0,Math.min(1,p));
  const type="${path}";
  if(type==="line") return {dx: dist*t, dy: 0};
  if(type==="arc")  return {dx: dist*t, dy: -Math.sin(Math.PI*t)*Math.min(140, dist*0.35)};
  if(type==="zigzag") return {dx: dist*t, dy: Math.sin(t*Math.PI*4)*Math.min(90, dist*0.22)};
  if(type==="bounce") return {dx: dist*t, dy: -Math.abs(Math.sin(t*Math.PI*3.2))*Math.min(160, dist*0.45)*(1 - t*0.55)};
  return {dx: dist*t, dy: 0};
}

let start;
function loop(ts){
  if(!start) start = ts;
  const elapsed = ts - start;

  let p = 0;
  if(elapsed >= delay){
    p = Math.min(1, (elapsed - delay) / duration);
  }

  const e = ease(p);
  const pos = pathAt(e);

  const x = 40 + pos.dx;
  const y = 40 + pos.dy;

  const rot = ${rot} * e;
  const sc = 1 + (${sc} - 1) * e;
  const op = 1 + (${op} - 1) * e;

  box.style.transform = \`translate(\${x}px, \${y}px) rotate(\${rot}deg) scale(\${sc})\`;
  box.style.opacity = op;

  if(p < 1) requestAnimationFrame(loop);
  else ${state.loop ? "start = undefined; requestAnimationFrame(loop);" : ""}
}
requestAnimationFrame(loop);
<\/script>`;

        // Give a more "complete" keyframes by describing steps in comment, since full step generation is handled in-app.
        const details = `/* In this playground, keyframes are auto-generated with ${steps} steps for smoother paths.
   The snippet below is a simplified 0/50/100 example. */`;

        const pick =
          state.engine === "cssTransition" ? cssTransition :
          state.engine === "jsRaf" ? jsRaf :
          `${details}\n${cssKeyframes}`;

        return pick;
      }

      function updateCode(){
        codeOut.textContent = makeCode();
      }

      function explainCurrent(){
        const parts = [];
        if(state.engine === "cssKeyframes"){
          parts.push("You‚Äôre using CSS Keyframes (via the Web Animations API here). That means the motion is defined as multiple keyframes over time, great for loops and multi-step sequences.");
        } else if(state.engine === "cssTransition"){
          parts.push("You‚Äôre using CSS Transition. This is best when you toggle between two states (like hover, active, open/closed). It‚Äôs simple and very common in UI.");
        } else {
          parts.push("You‚Äôre using JavaScript requestAnimationFrame (rAF). This is best for custom timelines, physics, or when you need exact control over progress.");
        }
        parts.push(`Duration is ${fmt(state.duration,2)}s with a delay of ${fmt(state.delay,2)}s. Easing is "${state.easing}" ‚Äî it changes how speed varies over time.`);
        parts.push(`Your path type is "${state.pathType}" and distance is ${Math.round(state.distance)}px. Rotation ends at ${Math.round(state.rotation)}¬∞ and scale ends at ${fmt(state.scale,2)}x.`);
        parts.push("Tip: For smoother UI, prefer transform/opacity. If you need accessibility, add a prefers-reduced-motion fallback (this page includes one).");
        return parts.join(" ");
      }

      // ---------- UI updates ----------
      function updateReadouts(){
        durOut.textContent = fmt(state.duration,2);
        delayOut.textContent = fmt(state.delay,2);
        distOut.textContent = Math.round(state.distance);
        rotOut.textContent = Math.round(state.rotation);
        scaleOut.textContent = fmt(state.scale,2);
        opOut.textContent = fmt(state.opacity,2);
        blurOut.textContent = fmt(state.blur,2);
        hueOut.textContent = Math.round(state.hue);
        kfOut.textContent = clamp(state.keySteps,2,6);

        durText.textContent = fmt(state.duration,2);
        delayText.textContent = fmt(state.delay,2);

        loopOut.textContent = state.loop ? "On" : "Off";
        easeOut.textContent = state.easing;
      }

      function updateModeLabels(){
        const name =
          state.engine === "cssTransition" ? "CSS Transition" :
          state.engine === "jsRaf" ? "JavaScript (requestAnimationFrame)" :
          "CSS Keyframes";
        modeOut.textContent = name;
        modeBadge.textContent = `Mode: ${name}`;
        engineOut.textContent = state.engine === "jsRaf" ? "JS" : "CSS";
      }

      function updatePlayButtons(){
        btnPlay.textContent = state.playing ? "Pause" : "Play";
      }

      function applyGrid(){
        $("#gridlines").style.display = state.grid ? "block" : "none";
      }

      function applyReduceMotion(){
        document.documentElement.style.scrollBehavior = state.reduceMotion ? "auto" : "smooth";
      }

      // ---------- Engine apply ----------
      function stopAll(){
        state.playing = false;
        updatePlayButtons();
        clearCssAnimation();
        stopRaf();
      }

      function startEngine(fromProgress=0){
        stopAll();
        state.playing = true;
        updatePlayButtons();
        updateModeLabels();
        setBaseVisuals();

        if(state.engine === "cssKeyframes"){
          cssKeyframesPlay(fromProgress);
          // keep progress UI updating
          tickCssProgress();
        } else if(state.engine === "cssTransition"){
          cssTransitionPlay();
          // no exact timeline; we simulate a timer
          tickSimulatedProgress();
        } else {
          // JS
          state.fps = 0; state.frameCount = 0; state.lastFpsT = 0;
          rafStart = now();
          rafPauseAccum = 0;
          stopRaf();
          rafId = requestAnimationFrame(rafLoop);
        }
      }

      function pauseEngine(){
        state.playing = false;
        updatePlayButtons();

        if(state.engine === "cssKeyframes" && activeAnim){
          activeAnim.pause();
        }
        if(state.engine === "jsRaf"){
          stopRaf();
        }
        // transitions have no real pause; we "pause" by stopping the button state only
      }

      // Track CSS keyframes progress
      let cssProgressTicker = 0;
      function tickCssProgress(){
        cancelAnimationFrame(cssProgressTicker);
        const tick = () => {
          if(state.engine !== "cssKeyframes" || !activeAnim) return;
          // approximate progress within a single iteration
          const durMs = (state.duration*1000) * (state.reduceMotion ? 1.6 : 1);
          const delayMs = (state.delay*1000);
          const ct = activeAnim.currentTime || 0;

          // currentTime includes delay
          let p = 0;
          if(ct <= delayMs) p = 0;
          else p = ((ct - delayMs) % durMs) / durMs;

          state.progress = clamp(p,0,1);
          updateTimeline();

          // WAAPI already moves it; just update text based on progress
          // For label: derive approx from progress
          applySpriteAtProgress(state.progress);

          if(state.playing) cssProgressTicker = requestAnimationFrame(tick);
        };
        cssProgressTicker = requestAnimationFrame(tick);
      }

      // Track transition progress with a timer
      let simTicker = 0;
      function tickSimulatedProgress(){
        cancelAnimationFrame(simTicker);
        const startT = now();
        const total = ((state.delay + state.duration) * (state.reduceMotion ? 1.6 : 1)) * 1000;
        const tick = () => {
          if(state.engine !== "cssTransition") return;
          const t = now() - startT;
          const p = clamp((t - state.delay*1000) / (state.duration*1000), 0, 1);
          state.progress = p;
          updateTimeline();
          applySpriteAtProgress(p);
          if(state.playing){
            if(p >= 1 && state.loop){
              tickSimulatedProgress();
              return;
            }
            simTicker = requestAnimationFrame(tick);
          }
        };
        simTicker = requestAnimationFrame(tick);
      }

      // ---------- Dragging ----------
      let dragging = false;
      let dragOffset = {x:0, y:0};

      function spritePosPx(){
        const styles = getComputedStyle(sprite);
        const x = parseFloat(styles.getPropertyValue("--x")) || 40;
        const y = parseFloat(styles.getPropertyValue("--y")) || 40;
        return {x, y};
      }

      function onPointerDown(e){
        dragging = true;
        sprite.setPointerCapture(e.pointerId);
        const rect = sprite.getBoundingClientRect();
        dragOffset.x = e.clientX - rect.left;
        dragOffset.y = e.clientY - rect.top;
        toast("Dragging: move the square (this sets start position).");
      }

      function onPointerMove(e){
        if(!dragging) return;
        const stageRect = stage.getBoundingClientRect();
        const size = sprite.getBoundingClientRect();
        const nx = clamp(e.clientX - stageRect.left - dragOffset.x, 0, stageRect.width - size.width);
        const ny = clamp(e.clientY - stageRect.top - dragOffset.y, 0, stageRect.height - size.height);

        // Update base position by shifting our internal "origin" assumptions.
        // We'll store it by changing CSS variables directly.
        sprite.style.setProperty("--x", nx);
        sprite.style.setProperty("--y", ny);
        xyOut.textContent = `${Math.round(nx)}, ${Math.round(ny)}`;
      }

      function onPointerUp(e){
        dragging = false;
        try{ sprite.releasePointerCapture(e.pointerId); } catch(_){}
      }

      // ---------- Tabs ----------
      function showTab(tab){
        tabs.forEach(t => t.classList.toggle("active", t.dataset.tab === tab));
        Object.entries(panels).forEach(([k, el]) => el.classList.toggle("active", k === tab));
        panelTitle.textContent =
          tab === "play" ? "Playground" :
          tab === "basics" ? "Basics" :
          tab === "easing" ? "Easing" :
          tab === "raf" ? "requestAnimationFrame" :
          tab === "svg" ? "SVG Motion" :
          tab === "quiz" ? "Mini Quiz" : "Exercises";
      }

      // ---------- Quiz ----------
      function grade(){
        const answers = { q1:"c", q2:"b", q3:"c" };
        const expl = {
          q1: "Correct: transform and opacity typically animate smoothly and avoid expensive layout work.",
          q2: "Correct: transitions are best for animating between two states like hover, open/close, active/inactive.",
          q3: "Correct: rAF aligns updates with the browser‚Äôs paint cycle and provides a timestamp for time-based motion."
        };
        let score = 0;
        Object.entries(answers).forEach(([q, a], idx) => {
          const pick = (document.querySelector(`input[name="${q}"]:checked`) || {}).value;
          const r = $(`#r${idx+1}`);
          if(!pick){
            r.className = "result no";
            r.style.display = "block";
            r.textContent = "Pick an option first.";
            return;
          }
          const ok = pick === a;
          if(ok) score++;
          r.className = "result " + (ok ? "ok" : "no");
          r.style.display = "block";
          r.textContent = (ok ? "‚úÖ " : "‚ùå ") + expl[q];
        });
        toast(`Quiz score: ${score}/3`);
      }

      function resetQuizUI(){
        $$('input[type="radio"]').forEach(r => r.checked = false);
        ["#r1","#r2","#r3"].forEach(id => { const el=$(id); el.style.display="none"; el.textContent=""; });
        toast("Quiz reset.");
      }

      // ---------- SVG demo ----------
      let svgLen = 0;
      let svgAnim = null;
      let svgRaf = 0;

      function svgSetup(){
        svgLen = svgPath.getTotalLength();
        svgPath.style.strokeDasharray = svgLen;
        svgPath.style.strokeDashoffset = svgLen;
        svgDot.setAttribute("cx", 60);
        svgDot.setAttribute("cy", 150);
      }

      function svgEaseFunc(name){
        const f = {
          "linear": t => t,
          "ease-in": t => t*t,
          "ease-out": t => 1 - Math.pow(1-t, 2),
          "ease-in-out": t => t<0.5 ? 2*t*t : 1 - Math.pow(-2*t+2,2)/2
        };
        return f[name] || f["ease-in-out"];
      }

      function svgPlay(){
        cancelAnimationFrame(svgRaf);
        if(svgAnim){ try{ svgAnim.cancel(); }catch(e){} svgAnim=null; }

        const dur = (parseFloat(svgDuration.value) * 1000) * (state.reduceMotion ? 1.6 : 1);
        const ease = svgEase.value;

        svgSetup();
        // Draw the path using WAAPI
        svgAnim = svgPath.animate(
          [{ strokeDashoffset: svgLen }, { strokeDashoffset: 0 }],
          { duration: dur, easing: ease, fill: "forwards" }
        );

        // Move dot along path (sample points)
        const startT = now();
        const ef = svgEaseFunc(ease);
        const tick = () => {
          const t = now() - startT;
          const p = clamp(t / dur, 0, 1);
          const e = ef(p);
          const pt = svgPath.getPointAtLength(svgLen * e);
          svgDot.setAttribute("cx", pt.x);
          svgDot.setAttribute("cy", pt.y);
          if(p < 1) svgRaf = requestAnimationFrame(tick);
        };
        svgRaf = requestAnimationFrame(tick);
      }

      // ---------- Events ----------
      tabs.forEach(t => t.addEventListener("click", () => showTab(t.dataset.tab)));

      engineSel.addEventListener("change", () => {
        state.engine = engineSel.value;
        updateModeLabels();
        updateCode();
        // keep a stable visual position
        setProgress(state.progress);
      });

      easingSel.addEventListener("change", () => {
        state.easing = easingSel.value;
        updateReadouts();
        updateCode();
        // If playing, restart to apply easing cleanly
        if(state.playing) startEngine(state.progress);
      });

      function bindRange(el, key, outEl, fmtFn){
        el.addEventListener("input", () => {
          state[key] = parseFloat(el.value);
          outEl.textContent = fmtFn(state[key]);
          updateReadouts();
          setBaseVisuals();
          updateCode();
          // If playing: restart so the engine picks up changes (clean, predictable)
          if(state.playing){
            startEngine(state.progress);
          } else {
            setProgress(state.progress);
          }
        });
      }

      bindRange(durR, "duration", durOut, v => fmt(v,2));
      bindRange(delayR, "delay", delayOut, v => fmt(v,2));
      bindRange(distR, "distance", distOut, v => Math.round(v));
      bindRange(rotR, "rotation", rotOut, v => Math.round(v));
      bindRange(scaleR, "scale", scaleOut, v => fmt(v,2));
      bindRange(opR, "opacity", opOut, v => fmt(v,2));
      bindRange(blurR, "blur", blurOut, v => fmt(v,2));
      bindRange(hueR, "hue", hueOut, v => Math.round(v));
      keyStepsR.addEventListener("input", () => {
        state.keySteps = parseInt(keyStepsR.value, 10);
        kfOut.textContent = state.keySteps;
        updateCode();
        if(state.playing && state.engine === "cssKeyframes") startEngine(state.progress);
      });

      pathSel.addEventListener("change", () => {
        state.pathType = pathSel.value;
        updateCode();
        if(state.playing) startEngine(state.progress);
        else setProgress(state.progress);
      });

      loopToggle.addEventListener("change", () => {
        state.loop = loopToggle.checked;
        updateReadouts();
        updateCode();
        if(state.playing) startEngine(state.progress);
      });

      gridToggle.addEventListener("change", () => {
        state.grid = gridToggle.checked;
        applyGrid();
      });

      reduceMotion.addEventListener("change", () => {
        state.reduceMotion = reduceMotion.checked;
        applyReduceMotion();
        updateCode();
        if(state.playing) startEngine(state.progress);
      });

      btnPlay.addEventListener("click", () => {
        if(state.playing){
          pauseEngine();
          toast("Paused.");
        } else {
          // resume: restart from current progress for consistent behavior
          startEngine(state.progress);
          toast("Playing.");
        }
      });

      btnStop.addEventListener("click", () => {
        stopAll();
        toast("Stopped.");
      });

      btnReset.addEventListener("click", () => {
        stopAll();
        state.progress = 0;
        setProgress(0);
        toast("Reset to start.");
      });

      btnStepBack.addEventListener("click", ()=> setProgress(state.progress - 0.1));
      btnStepFwd.addEventListener("click", ()=> setProgress(state.progress + 0.1));
      btnSnapStart.addEventListener("click", ()=> setProgress(0));
      btnSnapEnd.addEventListener("click", ()=> setProgress(1));

      btnCopy.addEventListener("click", async () => {
        try{
          await navigator.clipboard.writeText(codeOut.textContent);
          toast("Copied code to clipboard.");
        } catch(e){
          // fallback
          const ta = document.createElement("textarea");
          ta.value = codeOut.textContent;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          ta.remove();
          toast("Copied (fallback).");
        }
      });

      btnDownload.addEventListener("click", () => {
        const full = `<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Exported Animation Snippet</title>
</head>
<body>
${makeCode()}
</body>
</html>`;
        download("animation-snippet.html", full);
        toast("Downloaded animation-snippet.html");
      });

      btnExplain.addEventListener("click", () => {
        const open = explainBox.style.display !== "none";
        if(open){
          explainBox.style.display = "none";
        } else {
          explainText.textContent = explainCurrent();
          explainBox.style.display = "block";
        }
      });

      // Bezier panel
      function updateBezierText(){
        bx1o.textContent = fmt(bx1.value,2);
        by1o.textContent = fmt(by1.value,2);
        bx2o.textContent = fmt(bx2.value,2);
        by2o.textContent = fmt(by2.value,2);
        const bz = `cubic-bezier(${fmt(bx1.value,2)}, ${fmt(by1.value,2)}, ${fmt(bx2.value,2)}, ${fmt(by2.value,2)})`;
        bezierText.textContent = bz;
        return bz;
      }
      [bx1,by1,bx2,by2].forEach(el => el.addEventListener("input", updateBezierText));
      applyBezier.addEventListener("click", () => {
        const bz = updateBezierText();
        state.easing = bz;
        easingSel.value = bz; // if not present, set anyway (select will show empty)
        // add it as an option if missing
        if(!$$("option", easingSel).some(o => o.value === bz)){
          const opt = document.createElement("option");
          opt.value = bz;
          opt.textContent = bz + " (custom)";
          easingSel.appendChild(opt);
          easingSel.value = bz;
        }
        updateReadouts();
        updateCode();
        toast("Applied custom cubic-bezier to Playground.");
        if(state.playing) startEngine(state.progress);
      });
      resetBezier.addEventListener("click", () => {
        bx1.value = 0.16; by1.value = 1; bx2.value = 0.30; by2.value = 1;
        updateBezierText();
        toast("Bezier reset.");
      });
      updateBezierText();

      // SVG demo
      svgDuration.addEventListener("input", () => {
        svgDurOut.textContent = fmt(svgDuration.value,2);
      });
      svgPlayBtn.addEventListener("click", () => { svgPlay(); toast("SVG animation playing."); });
      svgResetBtn.addEventListener("click", () => { svgSetup(); toast("SVG reset."); });

      // Quiz events
      gradeQuiz.addEventListener("click", grade);
      resetQuiz.addEventListener("click", resetQuizUI);

      // Dragging
      sprite.addEventListener("pointerdown", onPointerDown);
      window.addEventListener("pointermove", onPointerMove);
      window.addEventListener("pointerup", onPointerUp);

      // Keyboard shortcuts
      window.addEventListener("keydown", (e) => {
        if(e.code === "Space"){
          e.preventDefault();
          btnPlay.click();
        }
        if(e.key.toLowerCase() === "r"){
          btnReset.click();
        }
        if(e.key.toLowerCase() === "c"){
          btnCopy.click();
        }
      });

      // Initialize
      function init(){
        engineSel.value = state.engine;
        easingSel.value = state.easing;
        durR.value = state.duration;
        delayR.value = state.delay;
        distR.value = state.distance;
        rotR.value = state.rotation;
        scaleR.value = state.scale;
        opR.value = state.opacity;
        blurR.value = state.blur;
        hueR.value = state.hue;
        keyStepsR.value = state.keySteps;
        pathSel.value = state.pathType;

        applyGrid();
        applyReduceMotion();

        updateReadouts();
        updateModeLabels();
        updateCode();

        // Put sprite at start
        setProgress(0);
        svgSetup();
        svgDurOut.textContent = fmt(svgDuration.value,2);

        toast("Ready. Try Play, then change easing + path type.");
      }
      init();
    })();
  </script>
</body>
</html>